
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="agent/">
      
      
      <link rel="icon" href="../img/squid_drawing.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>olfactory_navigation - Olfactory Navigation Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#olfactory_navigation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Olfactory Navigation Documentation" class="md-header__button md-logo" aria-label="Olfactory Navigation Documentation" data-md-component="logo">
      
  <img src="../img/squid_drawing.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Olfactory Navigation Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              olfactory_navigation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="green"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/PimLb/olfactory-navigation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    PimLb/olfactory-navigation
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  
  Code Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../tutorials/environment_description/" class="md-tabs__link">
          
  
  
  Tutorials

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Olfactory Navigation Documentation" class="md-nav__button md-logo" aria-label="Olfactory Navigation Documentation" data-md-component="logo">
      
  <img src="../img/squid_drawing.png" alt="logo">

    </a>
    Olfactory Navigation Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/PimLb/olfactory-navigation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    PimLb/olfactory-navigation
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Code Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Code Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="./" class="md-nav__link md-nav__link--active">
              
  
  
  <span class="md-ellipsis">
    olfactory_navigation
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link md-nav__link--active" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            olfactory_navigation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    agents
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_2" id="__nav_2_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            agents
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/fsvi_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    fsvi_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/hsvi_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    hsvi_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/infotaxis_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    infotaxis_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="agents/model_based_util/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    model_based_util
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_2_4" id="__nav_2_1_2_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2_4">
            <span class="md-nav__icon md-icon"></span>
            model_based_util
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/model_based_util/belief/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    belief
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/model_based_util/belief_value_mapping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    belief_value_mapping
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/model_based_util/environment_converter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    environment_converter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/model_based_util/mdp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mdp
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/model_based_util/pomdp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pomdp
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/model_based_util/value_function/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    value_function
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/model_based_util/vi_solver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    vi_solver
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/pbvi_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pbvi_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/pbvi_ger_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pbvi_ger_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/pbvi_ra_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pbvi_ra_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/pbvi_ssea_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pbvi_ssea_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/pbvi_ssga_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pbvi_ssga_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/pbvi_ssra_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pbvi_ssra_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/perseus_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    perseus_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/q_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    q_agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agents/qmdp_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    qmdp_agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="build_environment_gui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    build_environment_gui
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    environment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="simulation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    simulation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="test_setups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    test_setups
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    visualization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/environment_description/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    What is an Environment?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/agent_description/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    What is an Agent?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/simulation_process/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How does a simulation work?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/available_tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    What tests are available?
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#olfactory_navigation" class="md-nav__link">
    <span class="md-ellipsis">
      olfactory_navigation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent" class="md-nav__link">
    <span class="md-ellipsis">
      Agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.class_name" class="md-nav__link">
    <span class="md-ellipsis">
      class_name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.cpu_version" class="md-nav__link">
    <span class="md-ellipsis">
      cpu_version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.gpu_version" class="md-nav__link">
    <span class="md-ellipsis">
      gpu_version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.choose_action" class="md-nav__link">
    <span class="md-ellipsis">
      choose_action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.discretize_observations" class="md-nav__link">
    <span class="md-ellipsis">
      discretize_observations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.initialize_state" class="md-nav__link">
    <span class="md-ellipsis">
      initialize_state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.kill" class="md-nav__link">
    <span class="md-ellipsis">
      kill
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.modify_environment" class="md-nav__link">
    <span class="md-ellipsis">
      modify_environment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.to_cpu" class="md-nav__link">
    <span class="md-ellipsis">
      to_cpu
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.to_gpu" class="md-nav__link">
    <span class="md-ellipsis">
      to_gpu
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Agent.update_state" class="md-nav__link">
    <span class="md-ellipsis">
      update_state
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment" class="md-nav__link">
    <span class="md-ellipsis">
      Environment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Environment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.cpu_version" class="md-nav__link">
    <span class="md-ellipsis">
      cpu_version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.data" class="md-nav__link">
    <span class="md-ellipsis">
      data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.gpu_version" class="md-nav__link">
    <span class="md-ellipsis">
      gpu_version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.distance_to_source" class="md-nav__link">
    <span class="md-ellipsis">
      distance_to_source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.get_observation" class="md-nav__link">
    <span class="md-ellipsis">
      get_observation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.modify" class="md-nav__link">
    <span class="md-ellipsis">
      modify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.modify_scale" class="md-nav__link">
    <span class="md-ellipsis">
      modify_scale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.move" class="md-nav__link">
    <span class="md-ellipsis">
      move
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.plot" class="md-nav__link">
    <span class="md-ellipsis">
      plot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.random_start_points" class="md-nav__link">
    <span class="md-ellipsis">
      random_start_points
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.source_reached" class="md-nav__link">
    <span class="md-ellipsis">
      source_reached
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.to_cpu" class="md-nav__link">
    <span class="md-ellipsis">
      to_cpu
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.Environment.to_gpu" class="md-nav__link">
    <span class="md-ellipsis">
      to_gpu
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory" class="md-nav__link">
    <span class="md-ellipsis">
      SimulationHistory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SimulationHistory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.done_count" class="md-nav__link">
    <span class="md-ellipsis">
      done_count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.general_analysis_df" class="md-nav__link">
    <span class="md-ellipsis">
      general_analysis_df
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.runs_analysis_df" class="md-nav__link">
    <span class="md-ellipsis">
      runs_analysis_df
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.simulation_dfs" class="md-nav__link">
    <span class="md-ellipsis">
      simulation_dfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.simulations_at_horizon" class="md-nav__link">
    <span class="md-ellipsis">
      simulations_at_horizon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.start_time" class="md-nav__link">
    <span class="md-ellipsis">
      start_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.success_count" class="md-nav__link">
    <span class="md-ellipsis">
      success_count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.summary" class="md-nav__link">
    <span class="md-ellipsis">
      summary
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.add_step" class="md-nav__link">
    <span class="md-ellipsis">
      add_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.compute_distance_to_source" class="md-nav__link">
    <span class="md-ellipsis">
      compute_distance_to_source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.plot" class="md-nav__link">
    <span class="md-ellipsis">
      plot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.plot_runtimes" class="md-nav__link">
    <span class="md-ellipsis">
      plot_runtimes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.plot_successes" class="md-nav__link">
    <span class="md-ellipsis">
      plot_successes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#olfactory_navigation.SimulationHistory.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#olfactory_navigation.run_test" class="md-nav__link">
    <span class="md-ellipsis">
      run_test
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>olfactory_navigation</h1>

<div class="doc doc-object doc-module">



<a id="olfactory_navigation"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="olfactory_navigation.Agent" class="doc doc-heading">
            <code>Agent</code>


</h2>


    <div class="doc doc-contents ">


        <p>A generic agent class.</p>
<p>It is meant to define the general structure for an agent meant to evolve in a environment of olfactory cues.
To define such agent, a set of methods need to be implemented. This methods can be seperated into 3 categories:</p>
<ol>
<li>Training methods</li>
<li>Simulation methods</li>
<li>General methods</li>
</ol>
<p>The training methods are meant to train the agent before testing their performance in a simulation. A single method is needed for this:</p>
<ul>
<li>train()</li>
</ul>
<p>The simulation methods are meant for the agent to make choices and receiving observations during a simulation. The following methods are required for this:</p>
<ul>
<li>initialize_state(): This method is meant for the state of the agent(s) to be initialized before the simulation loop starts. The state of the agent can be an internal clock, a belief or something else arbitrary.</li>
<li>choose_action(): Here the agent(s) is asked to choose an action to play based on its internal state.</li>
<li>update_state(): Then, after the agent(s) has taken an action, the observation it makes along with whether he reached the source or not is returned to him using this method. This allows the agent to update its internal state.</li>
<li>kill(): Finally, the method asks for a set of agents to be terminated. The basic case happens when the agent reaches the source but it can also be asked to terminate if it has reached the end of the simulation without success.</li>
</ul>
<p>The general methods are methods to perform general actions with the agent. These methods are:</p>
<ul>
<li>save(): To save the agent to long term storage.</li>
<li>load(): To load the agent from long term storage.</li>
<li>modify_environment(): To provide an equivalent agent with a different environment linked to it. If the agent has previously been trained, the trained components needs to be adapted to this new environment.</li>
<li>to_gpu(): To create an alternative version of the agent whether the array instances are stored on the GPU memory instead of the CPU memory.</li>
<li>to_cpu(): To create an alternative version of the agent whether the array instances are stored on the CPU memory instead of the GPU memory.</li>
</ul>
<p>For a user to implement an agent, the main methods to define are the Simulation methods! The training method is, as stated, optional, as some agent definitions do not require it.
And the General methods all have some default behavior and are therefore only needed to be overwritten in specific cases.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>environment</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.environment.Environment)" href="environment/#olfactory_navigation.environment.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The olfactory environment the agent is meant to evolve in.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>thresholds</code>
            </td>
            <td>
                  <code><span title="float">float</span> or <span title="list">list</span>[<span title="float">float</span>] or <span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span>] or <span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The olfactory thresholds. If an odor cue above this threshold is detected, the agent detects it, else it does not.
If a list of thresholds is provided, he agent should be able to detect |thresholds|+1 levels of odor.
A dictionary of (list of) thresholds can also be provided when the environment is layered.
In such case, the number of layers provided must match the environment's layers and their labels must match.
The thresholds provided will be converted to an array where the levels start with -inf and end with +inf.</p>
              </div>
            </td>
            <td>
                  <code>3e-6</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>space_aware</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the agent is aware of it's own position in space.
This is to be used in scenarios where, for example, the agent is an enclosed container and the source is the variable.
Note: The observation array will have a different shape when returned to the update_state function!</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>spacial_subdivisions</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many spacial compartments the agent has to internally represent the space it lives in.
By default, it will be as many as there are grid points in the environment.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>actions</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The set of action available to the agent. It should match the type of environment (ie: if the environment has layers, it should contain a layer component to the action vector, and similarly for a third dimension).
Else, a dict of strings and action vectors where the strings represent the action labels.
If none is provided, by default, all unit movement vectors are included and shuch for all layers (if the environment has layers.)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A custom name for the agent. If it is not provided it will be named like "<class_name>-thresh_<threshold>".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For reproducible randomness.</p>
              </div>
            </td>
            <td>
                  <code>12131415</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.environment">environment</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.environment.Environment)" href="environment/#olfactory_navigation.environment.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.thresholds">thresholds</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of the thresholds of detection, starting with -inf and ending with +inf.
In the case of a 2D array of thresholds, the rows of thresholds apply to the different layers of the environment.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.space_aware">space_aware</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.spacial_subdivisions">spacial_subdivisions</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.action_set">action_set</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The actions allowed of the agent. Formulated as movement vectors as [(layer,) (dz,) dy, dx].</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.action_labels">action_labels</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The labels associated to the action vectors present in the action set.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.saved_at">saved_at</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the agent has been saved, the path at which it is saved is recorded in this variable.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.on_gpu">on_gpu</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the arrays are on the GPU memory or not. For this, the support for Cupy needs to be enabled and the agent needs to have been moved to the GPU using the to_gpu() function.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="class_name

  
      property
   (olfactory_navigation.Agent.class_name)" href="#olfactory_navigation.Agent.class_name">class_name</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the class of the agent.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.seed">seed</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The seed used for the random operations (to allow for reproducability).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Agent.rnd_state">rnd_state</span></code></td>
            <td>
                  <code><span title="numpy.random.RandomState">RandomState</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The random state variable used to generate random values.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="cpu_version

  
      property
   (olfactory_navigation.Agent.cpu_version)" href="#olfactory_navigation.Agent.cpu_version">cpu_version</a></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Agent (olfactory_navigation.agent.Agent)" href="agent/#olfactory_navigation.agent.Agent">Agent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the agent on the CPU. If it already is, it returns itself.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="gpu_version

  
      property
   (olfactory_navigation.Agent.gpu_version)" href="#olfactory_navigation.Agent.gpu_version">gpu_version</a></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Agent (olfactory_navigation.agent.Agent)" href="agent/#olfactory_navigation.agent.Agent">Agent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the agent on the CPU. If it already is, it returns itself.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Agent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A generic agent class.</span>

<span class="sd">    It is meant to define the general structure for an agent meant to evolve in a environment of olfactory cues.</span>
<span class="sd">    To define such agent, a set of methods need to be implemented. This methods can be seperated into 3 categories:</span>

<span class="sd">    1. Training methods</span>
<span class="sd">    2. Simulation methods</span>
<span class="sd">    3. General methods</span>

<span class="sd">    The training methods are meant to train the agent before testing their performance in a simulation. A single method is needed for this:</span>

<span class="sd">    - train()</span>

<span class="sd">    The simulation methods are meant for the agent to make choices and receiving observations during a simulation. The following methods are required for this:</span>

<span class="sd">    - initialize_state(): This method is meant for the state of the agent(s) to be initialized before the simulation loop starts. The state of the agent can be an internal clock, a belief or something else arbitrary.</span>
<span class="sd">    - choose_action(): Here the agent(s) is asked to choose an action to play based on its internal state.</span>
<span class="sd">    - update_state(): Then, after the agent(s) has taken an action, the observation it makes along with whether he reached the source or not is returned to him using this method. This allows the agent to update its internal state.</span>
<span class="sd">    - kill(): Finally, the method asks for a set of agents to be terminated. The basic case happens when the agent reaches the source but it can also be asked to terminate if it has reached the end of the simulation without success.</span>

<span class="sd">    The general methods are methods to perform general actions with the agent. These methods are:</span>

<span class="sd">    - save(): To save the agent to long term storage.</span>
<span class="sd">    - load(): To load the agent from long term storage.</span>
<span class="sd">    - modify_environment(): To provide an equivalent agent with a different environment linked to it. If the agent has previously been trained, the trained components needs to be adapted to this new environment.</span>
<span class="sd">    - to_gpu(): To create an alternative version of the agent whether the array instances are stored on the GPU memory instead of the CPU memory.</span>
<span class="sd">    - to_cpu(): To create an alternative version of the agent whether the array instances are stored on the CPU memory instead of the GPU memory.</span>

<span class="sd">    For a user to implement an agent, the main methods to define are the Simulation methods! The training method is, as stated, optional, as some agent definitions do not require it.</span>
<span class="sd">    And the General methods all have some default behavior and are therefore only needed to be overwritten in specific cases.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    environment : Environment</span>
<span class="sd">        The olfactory environment the agent is meant to evolve in.</span>

<span class="sd">    thresholds : float or list[float] or dict[str, float] or dict[str, list[float]], default=3e-6</span>
<span class="sd">        The olfactory thresholds. If an odor cue above this threshold is detected, the agent detects it, else it does not.</span>
<span class="sd">        If a list of thresholds is provided, he agent should be able to detect |thresholds|+1 levels of odor.</span>
<span class="sd">        A dictionary of (list of) thresholds can also be provided when the environment is layered.</span>
<span class="sd">        In such case, the number of layers provided must match the environment&#39;s layers and their labels must match.</span>
<span class="sd">        The thresholds provided will be converted to an array where the levels start with -inf and end with +inf.</span>
<span class="sd">    space_aware : bool, default=False</span>
<span class="sd">        Whether the agent is aware of it&#39;s own position in space.</span>
<span class="sd">        This is to be used in scenarios where, for example, the agent is an enclosed container and the source is the variable.</span>
<span class="sd">        Note: The observation array will have a different shape when returned to the update_state function!</span>
<span class="sd">    spacial_subdivisions : np.ndarray, optional</span>
<span class="sd">        How many spacial compartments the agent has to internally represent the space it lives in.</span>
<span class="sd">        By default, it will be as many as there are grid points in the environment.</span>
<span class="sd">    actions : dict or np.ndarray, optional</span>
<span class="sd">        The set of action available to the agent. It should match the type of environment (ie: if the environment has layers, it should contain a layer component to the action vector, and similarly for a third dimension).</span>
<span class="sd">        Else, a dict of strings and action vectors where the strings represent the action labels.</span>
<span class="sd">        If none is provided, by default, all unit movement vectors are included and shuch for all layers (if the environment has layers.)</span>
<span class="sd">    name : str, optional</span>
<span class="sd">        A custom name for the agent. If it is not provided it will be named like &quot;&lt;class_name&gt;-thresh_&lt;threshold&gt;&quot;.</span>
<span class="sd">    seed : int, default=12131415</span>
<span class="sd">        For reproducible randomness.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    environment : Environment</span>
<span class="sd">    thresholds : np.ndarray</span>
<span class="sd">        An array of the thresholds of detection, starting with -inf and ending with +inf.</span>
<span class="sd">        In the case of a 2D array of thresholds, the rows of thresholds apply to the different layers of the environment.</span>
<span class="sd">    space_aware : bool</span>
<span class="sd">    spacial_subdivisions : np.ndarray</span>
<span class="sd">    name : str</span>
<span class="sd">    action_set : np.ndarray</span>
<span class="sd">        The actions allowed of the agent. Formulated as movement vectors as [(layer,) (dz,) dy, dx].</span>
<span class="sd">    action_labels : list[str]</span>
<span class="sd">        The labels associated to the action vectors present in the action set.</span>
<span class="sd">    saved_at : str</span>
<span class="sd">        If the agent has been saved, the path at which it is saved is recorded in this variable.</span>
<span class="sd">    on_gpu : bool</span>
<span class="sd">        Whether the arrays are on the GPU memory or not. For this, the support for Cupy needs to be enabled and the agent needs to have been moved to the GPU using the to_gpu() function.</span>
<span class="sd">    class_name : str</span>
<span class="sd">        The name of the class of the agent.</span>
<span class="sd">    seed : int</span>
<span class="sd">        The seed used for the random operations (to allow for reproducability).</span>
<span class="sd">    rnd_state : np.random.RandomState</span>
<span class="sd">        The random state variable used to generate random values.</span>
<span class="sd">    cpu_version : Agent</span>
<span class="sd">        An instance of the agent on the CPU. If it already is, it returns itself.</span>
<span class="sd">    gpu_version : Agent</span>
<span class="sd">        An instance of the agent on the CPU. If it already is, it returns itself.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">environment</span><span class="p">:</span> <span class="n">Environment</span><span class="p">,</span>
                 <span class="n">thresholds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">3e-6</span><span class="p">,</span>
                 <span class="n">space_aware</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">spacial_subdivisions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">actions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12131415</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space_aware</span> <span class="o">=</span> <span class="n">space_aware</span>

        <span class="c1"># Handle thresholds</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="n">thresholds</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Ensure -inf and +inf begin and end the thresholds list</span>
            <span class="k">if</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
                <span class="n">thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">+</span> <span class="n">thresholds</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
                <span class="n">thresholds</span> <span class="o">=</span> <span class="n">thresholds</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thresholds</span><span class="p">)</span>

        <span class="c1"># Handle the case where a dict of thresholds is provided in the case of a layered environment and ensuring they are ordered.</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">has_layers</span><span class="p">,</span> <span class="s2">&quot;Thresholds can only be provided as a dict if the environment is layered.&quot;</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresholds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">layer_labels</span><span class="p">),</span> <span class="s2">&quot;Thresholds must be given for each layers.&quot;</span>

            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">layer_thresholds</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer_thresholds</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">layer_thresholds_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresholds</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layer_thresholds</span><span class="p">)</span> <span class="o">==</span> <span class="n">layer_thresholds_count</span> <span class="k">for</span> <span class="n">layer_thresholds</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="s2">&quot;If provided as lists, the threshold lists must all be of the same length.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">layer_threshold</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer_threshold</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="s2">&quot;The thresholds provided in a dictionary must all be list or float, not a combination of both.&quot;</span>

            <span class="c1"># Processing layers of thresholds</span>
            <span class="n">layer_thresholds_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">layer_labels</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Environment&#39;s layer [</span><span class="si">{</span><span class="n">layer_label</span><span class="si">}</span><span class="s2">] was not matched to any layers of the environment.&quot;</span>
                <span class="n">layer_thresholds</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">layer_label</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer_thresholds</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">layer_thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer_thresholds</span><span class="p">]</span>

                <span class="c1"># Ensure -inf and +inf begin and end the thresholds list</span>
                <span class="k">if</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layer_thresholds</span><span class="p">:</span>
                    <span class="n">layer_thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">+</span> <span class="n">layer_thresholds</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layer_thresholds</span><span class="p">:</span>
                    <span class="n">layer_thresholds</span> <span class="o">=</span> <span class="n">layer_thresholds</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>

                <span class="n">layer_thresholds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_thresholds</span><span class="p">)</span>

            <span class="c1"># Building an array with the layers of thresholds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layer_thresholds_list</span><span class="p">)</span>

        <span class="c1"># Ensuring the thresholds are in ascending order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># Spacial subdivisions</span>
        <span class="k">if</span> <span class="n">spacial_subdivisions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spacial_subdivisions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spacial_subdivisions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spacial_subdivisions</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spacial_subdivisions</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="s2">&quot;The amount of spacial divisions must match the amount of dimensions of the environment.&quot;</span>

        <span class="c1"># Mapping environment to spacial subdivisions</span>
        <span class="n">env_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">std_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">env_shape</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacial_subdivisions</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">overflows</span> <span class="o">=</span> <span class="p">(</span><span class="n">env_shape</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacial_subdivisions</span><span class="p">)</span>

        <span class="n">cell_sizes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">partitions</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">overflow</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">partitions</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">overflow</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">partitions</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">overflow</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spacial_subdivisions</span><span class="p">,</span> <span class="n">std_size</span><span class="p">,</span> <span class="n">overflows</span><span class="p">)]</span>

        <span class="c1"># Finding the edges of the cells and filling a grid with ids</span>
        <span class="n">cell_edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ax_sizes</span><span class="p">)))</span> <span class="k">for</span> <span class="n">ax_sizes</span> <span class="ow">in</span> <span class="n">cell_sizes</span><span class="p">]</span>

        <span class="n">lower_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="k">for</span> <span class="n">ax_arr</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">bounds_arr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">bounds_arr</span> <span class="ow">in</span> <span class="n">cell_edges</span><span class="p">],</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">upper_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="k">for</span> <span class="n">ax_arr</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">bounds_arr</span><span class="p">[</span><span class="mi">1</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">bounds_arr</span> <span class="ow">in</span> <span class="n">cell_edges</span><span class="p">],</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_environment_to_subdivision_mapping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">lower_b</span><span class="p">,</span> <span class="n">upper_b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lower_bounds</span><span class="p">,</span> <span class="n">upper_bounds</span><span class="p">)):</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">ax_lower</span><span class="p">,</span> <span class="n">ax_upper</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax_lower</span><span class="p">,</span> <span class="n">ax_upper</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lower_b</span><span class="p">,</span> <span class="n">upper_b</span><span class="p">)]</span>

            <span class="c1"># Grid to cell mapping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_environment_to_subdivision_mapping</span><span class="p">[</span><span class="o">*</span><span class="n">slices</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="c1"># Allowed actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">actions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span> <span class="c1"># North</span>
                    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span> <span class="c1"># East</span>
                    <span class="p">[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span> <span class="c1"># South</span>
                    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># West</span>
                <span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_labels</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;North&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;East&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;South&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;West&#39;</span>
                <span class="p">]</span>
            <span class="k">elif</span> <span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span> <span class="c1"># North</span>
                    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span> <span class="c1"># East</span>
                    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span> <span class="c1"># South</span>
                    <span class="p">[</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># West</span>
                    <span class="p">[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span> <span class="c1"># Up</span>
                    <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Down</span>
                <span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_labels</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;North&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;East&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;South&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;West&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Up&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Down&#39;</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># ND</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_labels</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span><span class="p">):</span>
                    <span class="c1"># Increase in dimension &#39;dim&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span><span class="p">[</span><span class="n">dim</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">action_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;d</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s1">+1&#39;</span><span class="p">)</span>

                    <span class="c1"># Decrease in dimension &#39;dim&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span><span class="p">[(</span><span class="n">dim</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">action_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;d</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s1">-1&#39;</span><span class="p">)</span>

            <span class="c1"># Layered</span>
            <span class="k">if</span> <span class="n">environment</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">layer</span><span class="p">,</span> <span class="o">*</span><span class="n">action_vector</span><span class="p">]</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">layers</span> <span class="k">for</span> <span class="n">action_vector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;l_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span>  <span class="n">layer</span> <span class="ow">in</span> <span class="n">environment</span><span class="o">.</span><span class="n">layer_labels</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_labels</span><span class="p">]</span>

        <span class="c1"># Actions provided as numpy array</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span> <span class="o">=</span> <span class="n">actions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">dim_a</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim_a</span> <span class="ow">in</span> <span class="n">action_vector</span><span class="p">])</span> <span class="k">for</span> <span class="n">action_vector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span><span class="p">]</span>

        <span class="c1"># Actions provided as dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">actions</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">actions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Asertion that the shape of the actions set if right</span>
        <span class="n">layered</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">environment</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">layered</span> <span class="o">+</span> <span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The shape of the action_set provided is not right. (Found </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">action_set</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">; expected (., </span><span class="si">{</span><span class="n">layered</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span><span class="si">}</span><span class="s2">))&quot;</span>

        <span class="c1"># setup name</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_name</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">thresh_string</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;l</span><span class="si">{</span><span class="n">row_i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span><span class="p">])</span> <span class="k">for</span> <span class="n">row_i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thresh_string</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;-tresholds-&#39;</span> <span class="o">+</span> <span class="n">thresh_string</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;-space_aware&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_aware</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># Other variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_at</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># random state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnd_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">class_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The name of the class of the agent.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>


    <span class="c1"># ----------------</span>
    <span class="c1"># Training methods</span>
    <span class="c1"># ----------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Optional function to train the agent in the olfactory environment it is in.</span>
<span class="sd">        This function is optional as some agents have some fixed behavior and therefore dont require training.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The train function is not implemented, make an agent subclass to implement the method&#39;</span><span class="p">)</span>


    <span class="c1"># ------------------</span>
    <span class="c1"># Simulation methods</span>
    <span class="c1"># ------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to initialize the internal state of the agent(s) for the simulation process. The internal state can be concepts such as the &quot;memory&quot; or &quot;belief&quot; of the agent.</span>
<span class="sd">        The n parameter corresponds to how many &quot;instances&quot; need to instanciated. This is meant so that we work with a &quot;group&quot; of agents instead of individual instances.</span>

<span class="sd">        This is done with the purpose that the state of the group of agents be stored in (Numpy) arrays to allow vectorization instead of sequential loops.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n : int, default=1</span>
<span class="sd">            How many agents to initialize.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The initialize_state function is not implemented, make an agent subclass to implement the method&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">choose_action</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to allow for the agent(s) to choose an action to take based on its current state.</span>

<span class="sd">        It should return a 2D array of shape n by 2 (or 3, or 4 depending of whether the environment has layers and/or a 3rd dimension),</span>
<span class="sd">        where n is how many agents are to choose an action. It should be n 2D vectors of (the layer and) the change in the (z,) y, and x positions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        movement_vector : np.ndarray</span>
<span class="sd">            An array of n vectors in 2D space of the movement(s) the agent(s) will take.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The choose_action function is not implemented, make an agent subclass to implement the method&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">discretize_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">observation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                <span class="n">action</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                <span class="n">source_reached</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                                <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to convert a set of observations to discrete observation ids.</span>
<span class="sd">        It uses the olfaction thresholds of the agent to discretize the odor concentrations.</span>

<span class="sd">        In the case where the agent is also aware of it&#39;s own position in space, in which case the observation matrix is of size n by 1 + environment.dimensions,</span>
<span class="sd">        the agent first converts the points on the grid to position ids and then multiply the id by olfactory observation id.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        observation : np.ndarray</span>
<span class="sd">            The observations the agent receives, in the case the agent is space_aware, the position point is also included.</span>
<span class="sd">        action: np.ndarray</span>
<span class="sd">            The action the agent did. This parameter is used in the particular case where the environment has layers and the odor thresholds are layer dependent.</span>
<span class="sd">        source_reached : np.ndarray</span>
<span class="sd">            A 1D array of boolean values signifying whether each agent reached or not the source.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        discrete_observations: np.ndarray</span>
<span class="sd">            An integer array of discrete observations</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># GPU support</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">cp</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">discrete_observations</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Gather olfactory observation</span>
        <span class="n">olfactory_observation</span> <span class="o">=</span> <span class="n">observation</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_aware</span> <span class="k">else</span> <span class="n">observation</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Compute the amount of observations available</span>
        <span class="n">observation_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># |thresholds| - 1 observation buckets</span>

        <span class="c1"># Handle the special case where we have a layered environment and different thresholds for these layers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">has_layers</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">layer_ids</span> <span class="o">=</span> <span class="n">action</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># First column of actions is the layer</span>
            <span class="n">action_layer_thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="n">layer_ids</span><span class="p">]</span>
            <span class="n">observation_ids</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">olfactory_observation</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">action_layer_thresholds</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">olfactory_observation</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">action_layer_thresholds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]))[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Setting observation ids</span>
            <span class="n">observation_ids</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">olfactory_observation</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="kc">None</span><span class="p">,:])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">olfactory_observation</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="kc">None</span><span class="p">,:]))[:,</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># If needed, multiply observation indices by position indices</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_aware</span><span class="p">:</span>
            <span class="n">discrete_observations</span> <span class="o">=</span> <span class="n">observation_ids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">position_clipped</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">observation</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">position_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spacial_subdivisions</span><span class="p">))</span>
            <span class="n">position_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environment_to_subdivision_mapping</span><span class="p">[</span><span class="o">*</span><span class="n">position_clipped</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>

            <span class="c1"># Add the amount of possible positions to the observation count</span>
            <span class="n">observation_count</span> <span class="o">*=</span> <span class="n">position_count</span>

            <span class="c1"># Combine with observation ids</span>
            <span class="n">discrete_observations</span> <span class="o">=</span> <span class="p">(</span><span class="n">observation_ids</span> <span class="o">*</span> <span class="n">position_count</span><span class="p">)</span> <span class="o">+</span> <span class="n">position_ids</span>

        <span class="c1"># Adding the goal observation</span>
        <span class="n">discrete_observations</span><span class="p">[</span><span class="n">source_reached</span><span class="p">]</span> <span class="o">=</span> <span class="n">observation_count</span>

        <span class="k">return</span> <span class="n">discrete_observations</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">action</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">observation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">source_reached</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to update the internal state(s) of the agent(s) based on the action(s) taken and the observation(s) received.</span>
<span class="sd">        The observations are then compared with the thresholds to decide whether something was sensed or not or to what level.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action : np.ndarray</span>
<span class="sd">            A 2D array of n movement vectors. If the environment is layered, the 1st component should be the layer.</span>
<span class="sd">        observation : np.ndarray</span>
<span class="sd">            A n by 1 (or 1 + environment.dimensions if space_aware) array of odor cues (float values) retrieved from the environment.</span>
<span class="sd">        source_reached : np.array</span>
<span class="sd">            A 1D array of boolean values signifying whether each agent reached or not the source.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        update_successfull : np.ndarray, optional</span>
<span class="sd">            If nothing is returned, it means all the agent&#39;s state updates have been successfull.</span>
<span class="sd">            Else, a boolean np.ndarray of size n can be returned confirming for each agent whether the update has been successful or not.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The update_state function is not implemented, make an agent subclass to implement the method&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">simulations_to_kill</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to kill any agents that either reached the source or failed by not reaching the source before the horizon or failing to update its own state.</span>
<span class="sd">        The agents where the simulations_to_kill paramater is True have to removed from the list of agents.</span>
<span class="sd">        It is necessary because their reference will also be removed from the simulation loop. Therefore, if they are not removed, the array sizes will not match anymore.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        simulations_to_kill : np.ndarray</span>
<span class="sd">            An array of size n containing boolean values of whether or not agent&#39;s simulations are terminated and therefore should be removed.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The kill function is not implemented, make an agent subclass to implement the method&#39;</span><span class="p">)</span>


    <span class="c1"># ---------------</span>
    <span class="c1"># General methods</span>
    <span class="c1"># ---------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">save_environment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to save a trained agent to long term storage.</span>
<span class="sd">        By default, the agent is saved in its entirety using pickle.</span>

<span class="sd">        However, it is strongly advised to overwrite this method to only save save the necessary components of the agents in order to be able to load it and reproduce its behavior.</span>
<span class="sd">        For instance, if the agent is saved after the simulation is run, the state would also be saved within the pickle which is not wanted.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folder : str, optional</span>
<span class="sd">            The folder in which the agent&#39;s data should be saved.</span>
<span class="sd">        force : bool, default=False</span>
<span class="sd">            If the agent is already saved at the folder provided, the saving should fail.</span>
<span class="sd">            If the already saved agent should be overwritten, this parameter should be toggled to True.</span>
<span class="sd">        save_environment : bool, default=False</span>
<span class="sd">            Whether to save the agent&#39;s linked environment alongside the agent itself.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="n">cpu_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_cpu</span><span class="p">()</span>
            <span class="n">cpu_agent</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">save_environment</span><span class="o">=</span><span class="n">save_environment</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Adding env name to folder path</span>
        <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./Agent-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;/Agent-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># Checking the folder exists or creates it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1"> is not empty. If you want to overwrite the saved agent, enable &quot;force&quot;.&#39;</span><span class="p">)</span>

        <span class="c1"># Send self to pickle</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/binary.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="c1"># Save environment in folder too if requested</span>
        <span class="k">if</span> <span class="n">save_environment</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/Env-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
             <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Agent&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to load a trained agent from long term storage.</span>
<span class="sd">        By default, as for the save function, it will load the agent from the folder assuming it is a pickle file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folder : str</span>
<span class="sd">            The folder in which the agent was saved.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loaded_agent : Agent</span>
<span class="sd">            The agent loaded from the folder.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">olfactory_navigation</span><span class="w"> </span><span class="kn">import</span> <span class="n">agents</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">agents</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="bp">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="c1"># Default loading with pickle</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/binary.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">modify_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">new_environment</span><span class="p">:</span> <span class="n">Environment</span>
                           <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Agent&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to modify the environment of the agent.</span>

<span class="sd">        Note: By default, a new agent is created with the same thresholds and name but with a this new environment!</span>
<span class="sd">        If there are any trained elements to the agent, they are to be modified in this method to be adapted to this new environment.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_environment : Environment</span>
<span class="sd">            The new environment to replace the agent in an equivalent agent.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        modified_agent : Agent</span>
<span class="sd">            A new Agent whose environment has been replaced.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># TODO: Fix this to account for other init parameters</span>
        <span class="n">modified_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">environment</span><span class="o">=</span><span class="n">new_environment</span><span class="p">,</span>
                                        <span class="n">thresholds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">modified_agent</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">to_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Agent&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to send the numpy arrays of the agent to the gpu.</span>
<span class="sd">        It returns a new instance of the Agent class with the arrays on the gpu.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gpu_agent : Agent</span>
<span class="sd">            A new environment instance where the arrays are on the gpu memory.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Check whether the agent is already on the gpu or not</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Warn and overwrite alternate_version in case it already exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[warning] A GPU instance already existed and is being recreated.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="n">gpu_support</span><span class="p">,</span> <span class="s2">&quot;GPU support is not enabled, Cupy might need to be installed...&quot;</span>

        <span class="c1"># Generating a new instance</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">gpu_agent</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="c1"># Copying arguments to gpu</span>
        <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;rnd_state&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># Self reference instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="n">gpu_agent</span>
        <span class="n">gpu_agent</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">gpu_agent</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">gpu_agent</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">to_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Agent&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to send the numpy arrays of the agent to the cpu.</span>
<span class="sd">        It returns a new instance of the Agent class with the arrays on the cpu.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cpu_agent : Agent</span>
<span class="sd">            A new environment instance where the arrays are on the cpu memory.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Check whether the agent is already on the cpu or not</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[warning] A CPU instance already existed and is being recreated.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Generating a new instance</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">cpu_agent</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="c1"># Copying arguments to gpu</span>
        <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;rnd_state&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># Self reference instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="n">cpu_agent</span>
        <span class="n">cpu_agent</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">cpu_agent</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">cpu_agent</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gpu_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A version of the Agent on the GPU.</span>
<span class="sd">        If the agent is already on the GPU it returns itself, otherwise the to_gpu function is called to generate a new one.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Check if an alternate version already exists</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Generate an alternate version on the gpu</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_gpu</span><span class="p">()</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cpu_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A version of the Agent on the CPU.</span>
<span class="sd">        If the agent is already on the CPU it returns itself, otherwise the to_cpu function is called to generate a new one.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Check if an alternate version already exists</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Generate an alternate version on the cpu</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_cpu</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.Agent.class_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">class_name</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>The name of the class of the agent.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.Agent.cpu_version" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cpu_version</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>A version of the Agent on the CPU.
If the agent is already on the CPU it returns itself, otherwise the to_cpu function is called to generate a new one.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.Agent.gpu_version" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">gpu_version</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>A version of the Agent on the GPU.
If the agent is already on the GPU it returns itself, otherwise the to_gpu function is called to generate a new one.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.choose_action" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">choose_action</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to allow for the agent(s) to choose an action to take based on its current state.</p>
<p>It should return a 2D array of shape n by 2 (or 3, or 4 depending of whether the environment has layers and/or a 3rd dimension),
where n is how many agents are to choose an action. It should be n 2D vectors of (the layer and) the change in the (z,) y, and x positions.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>movement_vector</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of n vectors in 2D space of the movement(s) the agent(s) will take.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">choose_action</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to allow for the agent(s) to choose an action to take based on its current state.</span>

<span class="sd">    It should return a 2D array of shape n by 2 (or 3, or 4 depending of whether the environment has layers and/or a 3rd dimension),</span>
<span class="sd">    where n is how many agents are to choose an action. It should be n 2D vectors of (the layer and) the change in the (z,) y, and x positions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    movement_vector : np.ndarray</span>
<span class="sd">        An array of n vectors in 2D space of the movement(s) the agent(s) will take.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The choose_action function is not implemented, make an agent subclass to implement the method&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.discretize_observations" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">discretize_observations</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">source_reached</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to convert a set of observations to discrete observation ids.
It uses the olfaction thresholds of the agent to discretize the odor concentrations.</p>
<p>In the case where the agent is also aware of it's own position in space, in which case the observation matrix is of size n by 1 + environment.dimensions,
the agent first converts the points on the grid to position ids and then multiply the id by olfactory observation id.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>observation</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The observations the agent receives, in the case the agent is space_aware, the position point is also included.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>action</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The action the agent did. This parameter is used in the particular case where the environment has layers and the odor thresholds are layer dependent.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_reached</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 1D array of boolean values signifying whether each agent reached or not the source.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>discrete_observations</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer array of discrete observations</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">discretize_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">observation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">action</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">source_reached</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to convert a set of observations to discrete observation ids.</span>
<span class="sd">    It uses the olfaction thresholds of the agent to discretize the odor concentrations.</span>

<span class="sd">    In the case where the agent is also aware of it&#39;s own position in space, in which case the observation matrix is of size n by 1 + environment.dimensions,</span>
<span class="sd">    the agent first converts the points on the grid to position ids and then multiply the id by olfactory observation id.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    observation : np.ndarray</span>
<span class="sd">        The observations the agent receives, in the case the agent is space_aware, the position point is also included.</span>
<span class="sd">    action: np.ndarray</span>
<span class="sd">        The action the agent did. This parameter is used in the particular case where the environment has layers and the odor thresholds are layer dependent.</span>
<span class="sd">    source_reached : np.ndarray</span>
<span class="sd">        A 1D array of boolean values signifying whether each agent reached or not the source.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    discrete_observations: np.ndarray</span>
<span class="sd">        An integer array of discrete observations</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># GPU support</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">cp</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
    <span class="n">discrete_observations</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># Gather olfactory observation</span>
    <span class="n">olfactory_observation</span> <span class="o">=</span> <span class="n">observation</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_aware</span> <span class="k">else</span> <span class="n">observation</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Compute the amount of observations available</span>
    <span class="n">observation_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># |thresholds| - 1 observation buckets</span>

    <span class="c1"># Handle the special case where we have a layered environment and different thresholds for these layers</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">has_layers</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">layer_ids</span> <span class="o">=</span> <span class="n">action</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># First column of actions is the layer</span>
        <span class="n">action_layer_thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="n">layer_ids</span><span class="p">]</span>
        <span class="n">observation_ids</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">olfactory_observation</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">action_layer_thresholds</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">olfactory_observation</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">action_layer_thresholds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]))[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Setting observation ids</span>
        <span class="n">observation_ids</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">olfactory_observation</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="kc">None</span><span class="p">,:])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">olfactory_observation</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="kc">None</span><span class="p">,:]))[:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># If needed, multiply observation indices by position indices</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_aware</span><span class="p">:</span>
        <span class="n">discrete_observations</span> <span class="o">=</span> <span class="n">observation_ids</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">position_clipped</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">observation</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">position_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spacial_subdivisions</span><span class="p">))</span>
        <span class="n">position_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environment_to_subdivision_mapping</span><span class="p">[</span><span class="o">*</span><span class="n">position_clipped</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>

        <span class="c1"># Add the amount of possible positions to the observation count</span>
        <span class="n">observation_count</span> <span class="o">*=</span> <span class="n">position_count</span>

        <span class="c1"># Combine with observation ids</span>
        <span class="n">discrete_observations</span> <span class="o">=</span> <span class="p">(</span><span class="n">observation_ids</span> <span class="o">*</span> <span class="n">position_count</span><span class="p">)</span> <span class="o">+</span> <span class="n">position_ids</span>

    <span class="c1"># Adding the goal observation</span>
    <span class="n">discrete_observations</span><span class="p">[</span><span class="n">source_reached</span><span class="p">]</span> <span class="o">=</span> <span class="n">observation_count</span>

    <span class="k">return</span> <span class="n">discrete_observations</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.initialize_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialize_state</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to initialize the internal state of the agent(s) for the simulation process. The internal state can be concepts such as the "memory" or "belief" of the agent.
The n parameter corresponds to how many "instances" need to instanciated. This is meant so that we work with a "group" of agents instead of individual instances.</p>
<p>This is done with the purpose that the state of the group of agents be stored in (Numpy) arrays to allow vectorization instead of sequential loops.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many agents to initialize.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to initialize the internal state of the agent(s) for the simulation process. The internal state can be concepts such as the &quot;memory&quot; or &quot;belief&quot; of the agent.</span>
<span class="sd">    The n parameter corresponds to how many &quot;instances&quot; need to instanciated. This is meant so that we work with a &quot;group&quot; of agents instead of individual instances.</span>

<span class="sd">    This is done with the purpose that the state of the group of agents be stored in (Numpy) arrays to allow vectorization instead of sequential loops.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int, default=1</span>
<span class="sd">        How many agents to initialize.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The initialize_state function is not implemented, make an agent subclass to implement the method&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.kill" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">kill</span><span class="p">(</span><span class="n">simulations_to_kill</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to kill any agents that either reached the source or failed by not reaching the source before the horizon or failing to update its own state.
The agents where the simulations_to_kill paramater is True have to removed from the list of agents.
It is necessary because their reference will also be removed from the simulation loop. Therefore, if they are not removed, the array sizes will not match anymore.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>simulations_to_kill</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of size n containing boolean values of whether or not agent's simulations are terminated and therefore should be removed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
         <span class="n">simulations_to_kill</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to kill any agents that either reached the source or failed by not reaching the source before the horizon or failing to update its own state.</span>
<span class="sd">    The agents where the simulations_to_kill paramater is True have to removed from the list of agents.</span>
<span class="sd">    It is necessary because their reference will also be removed from the simulation loop. Therefore, if they are not removed, the array sizes will not match anymore.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    simulations_to_kill : np.ndarray</span>
<span class="sd">        An array of size n containing boolean values of whether or not agent&#39;s simulations are terminated and therefore should be removed.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The kill function is not implemented, make an agent subclass to implement the method&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.load" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Function to load a trained agent from long term storage.
By default, as for the save function, it will load the agent from the folder assuming it is a pickle file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The folder in which the agent was saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>loaded_agent</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="Agent (olfactory_navigation.agent.Agent)" href="agent/#olfactory_navigation.agent.Agent">Agent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The agent loaded from the folder.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
         <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Agent&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to load a trained agent from long term storage.</span>
<span class="sd">    By default, as for the save function, it will load the agent from the folder assuming it is a pickle file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str</span>
<span class="sd">        The folder in which the agent was saved.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    loaded_agent : Agent</span>
<span class="sd">        The agent loaded from the folder.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">olfactory_navigation</span><span class="w"> </span><span class="kn">import</span> <span class="n">agents</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">agents</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="c1"># Default loading with pickle</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/binary.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.modify_environment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">modify_environment</span><span class="p">(</span><span class="n">new_environment</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to modify the environment of the agent.</p>
<p>Note: By default, a new agent is created with the same thresholds and name but with a this new environment!
If there are any trained elements to the agent, they are to be modified in this method to be adapted to this new environment.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>new_environment</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.environment.Environment)" href="environment/#olfactory_navigation.environment.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The new environment to replace the agent in an equivalent agent.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>modified_agent</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="Agent (olfactory_navigation.agent.Agent)" href="agent/#olfactory_navigation.agent.Agent">Agent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new Agent whose environment has been replaced.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">modify_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">new_environment</span><span class="p">:</span> <span class="n">Environment</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Agent&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to modify the environment of the agent.</span>

<span class="sd">    Note: By default, a new agent is created with the same thresholds and name but with a this new environment!</span>
<span class="sd">    If there are any trained elements to the agent, they are to be modified in this method to be adapted to this new environment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    new_environment : Environment</span>
<span class="sd">        The new environment to replace the agent in an equivalent agent.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    modified_agent : Agent</span>
<span class="sd">        A new Agent whose environment has been replaced.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># TODO: Fix this to account for other init parameters</span>
    <span class="n">modified_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">environment</span><span class="o">=</span><span class="n">new_environment</span><span class="p">,</span>
                                    <span class="n">thresholds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">modified_agent</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_environment</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to save a trained agent to long term storage.
By default, the agent is saved in its entirety using pickle.</p>
<p>However, it is strongly advised to overwrite this method to only save save the necessary components of the agents in order to be able to load it and reproduce its behavior.
For instance, if the agent is saved after the simulation is run, the state would also be saved within the pickle which is not wanted.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The folder in which the agent's data should be saved.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the agent is already saved at the folder provided, the saving should fail.
If the already saved agent should be overwritten, this parameter should be toggled to True.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_environment</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to save the agent's linked environment alongside the agent itself.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
         <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
         <span class="n">save_environment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to save a trained agent to long term storage.</span>
<span class="sd">    By default, the agent is saved in its entirety using pickle.</span>

<span class="sd">    However, it is strongly advised to overwrite this method to only save save the necessary components of the agents in order to be able to load it and reproduce its behavior.</span>
<span class="sd">    For instance, if the agent is saved after the simulation is run, the state would also be saved within the pickle which is not wanted.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str, optional</span>
<span class="sd">        The folder in which the agent&#39;s data should be saved.</span>
<span class="sd">    force : bool, default=False</span>
<span class="sd">        If the agent is already saved at the folder provided, the saving should fail.</span>
<span class="sd">        If the already saved agent should be overwritten, this parameter should be toggled to True.</span>
<span class="sd">    save_environment : bool, default=False</span>
<span class="sd">        Whether to save the agent&#39;s linked environment alongside the agent itself.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
        <span class="n">cpu_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_cpu</span><span class="p">()</span>
        <span class="n">cpu_agent</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">save_environment</span><span class="o">=</span><span class="n">save_environment</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Adding env name to folder path</span>
    <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./Agent-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;/Agent-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="c1"># Checking the folder exists or creates it</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1"> is not empty. If you want to overwrite the saved agent, enable &quot;force&quot;.&#39;</span><span class="p">)</span>

    <span class="c1"># Send self to pickle</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/binary.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># Save environment in folder too if requested</span>
    <span class="k">if</span> <span class="n">save_environment</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/Env-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.to_cpu" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_cpu</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to send the numpy arrays of the agent to the cpu.
It returns a new instance of the Agent class with the arrays on the cpu.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>cpu_agent</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="Agent (olfactory_navigation.agent.Agent)" href="agent/#olfactory_navigation.agent.Agent">Agent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new environment instance where the arrays are on the cpu memory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Agent&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to send the numpy arrays of the agent to the cpu.</span>
<span class="sd">    It returns a new instance of the Agent class with the arrays on the cpu.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cpu_agent : Agent</span>
<span class="sd">        A new environment instance where the arrays are on the cpu memory.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Check whether the agent is already on the cpu or not</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[warning] A CPU instance already existed and is being recreated.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Generating a new instance</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="n">cpu_agent</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="c1"># Copying arguments to gpu</span>
    <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;rnd_state&#39;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Self reference instances</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="n">cpu_agent</span>
    <span class="n">cpu_agent</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="n">cpu_agent</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">cpu_agent</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.to_gpu" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_gpu</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to send the numpy arrays of the agent to the gpu.
It returns a new instance of the Agent class with the arrays on the gpu.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>gpu_agent</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="Agent (olfactory_navigation.agent.Agent)" href="agent/#olfactory_navigation.agent.Agent">Agent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new environment instance where the arrays are on the gpu memory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Agent&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to send the numpy arrays of the agent to the gpu.</span>
<span class="sd">    It returns a new instance of the Agent class with the arrays on the gpu.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gpu_agent : Agent</span>
<span class="sd">        A new environment instance where the arrays are on the gpu memory.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Check whether the agent is already on the gpu or not</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># Warn and overwrite alternate_version in case it already exists</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[warning] A GPU instance already existed and is being recreated.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">assert</span> <span class="n">gpu_support</span><span class="p">,</span> <span class="s2">&quot;GPU support is not enabled, Cupy might need to be installed...&quot;</span>

    <span class="c1"># Generating a new instance</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="n">gpu_agent</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="c1"># Copying arguments to gpu</span>
    <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;rnd_state&#39;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_agent</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Self reference instances</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="n">gpu_agent</span>
    <span class="n">gpu_agent</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="n">gpu_agent</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">gpu_agent</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.train" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Optional function to train the agent in the olfactory environment it is in.
This function is optional as some agents have some fixed behavior and therefore dont require training.</p>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Optional function to train the agent in the olfactory environment it is in.</span>
<span class="sd">    This function is optional as some agents have some fixed behavior and therefore dont require training.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The train function is not implemented, make an agent subclass to implement the method&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Agent.update_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_state</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">source_reached</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to update the internal state(s) of the agent(s) based on the action(s) taken and the observation(s) received.
The observations are then compared with the thresholds to decide whether something was sensed or not or to what level.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>action</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 2D array of n movement vectors. If the environment is layered, the 1st component should be the layer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>observation</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A n by 1 (or 1 + environment.dimensions if space_aware) array of odor cues (float values) retrieved from the environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_reached</code>
            </td>
            <td>
                  <code><span title="numpy.array">array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 1D array of boolean values signifying whether each agent reached or not the source.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>update_successfull</code></td>            <td>
                  <code>(<span title="numpy.ndarray">ndarray</span>, <span title="optional">optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If nothing is returned, it means all the agent's state updates have been successfull.
Else, a boolean np.ndarray of size n can be returned confirming for each agent whether the update has been successful or not.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">action</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">observation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">source_reached</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to update the internal state(s) of the agent(s) based on the action(s) taken and the observation(s) received.</span>
<span class="sd">    The observations are then compared with the thresholds to decide whether something was sensed or not or to what level.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    action : np.ndarray</span>
<span class="sd">        A 2D array of n movement vectors. If the environment is layered, the 1st component should be the layer.</span>
<span class="sd">    observation : np.ndarray</span>
<span class="sd">        A n by 1 (or 1 + environment.dimensions if space_aware) array of odor cues (float values) retrieved from the environment.</span>
<span class="sd">    source_reached : np.array</span>
<span class="sd">        A 1D array of boolean values signifying whether each agent reached or not the source.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    update_successfull : np.ndarray, optional</span>
<span class="sd">        If nothing is returned, it means all the agent&#39;s state updates have been successfull.</span>
<span class="sd">        Else, a boolean np.ndarray of size n can be returned confirming for each agent whether the update has been successful or not.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The update_state function is not implemented, make an agent subclass to implement the method&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="olfactory_navigation.Environment" class="doc doc-heading">
            <code>Environment</code>


</h2>


    <div class="doc doc-contents ">


        <p>Class to represent an olfactory environment.</p>
<p>It is defined based on an olfactory data set provided as either a numpy file or an array directly with shape time, y, x.
From this environment, the various parameters are applied in the following order:</p>
<ol>
<li>The source position is set</li>
<li>The margins are added and the shape (total size) of the environment are set.</li>
<li>The data file's x and y components are squished and streched the to fit the inter-marginal shape of the environment.</li>
<li>The source's position is also moved to stay at the same position within the data.</li>
<li>The multiplier is finally applied to modify the data file's x and y components a final time by growing or shrinking the margins to account for the multiplier. (The multiplication applies with the source position as a center point)</li>
</ol>
<p>Note: to modify the shape of the data file's x and y components the OpenCV library's resize function is used. And the interpolation method is controlled by the interpolation_method parameter.</p>
<p>Then, the starting probability map is built. Either an array can be provided directly or preset option can be chosen:</p>
<ul>
<li>'data_zone': The agent can start at any point in the data_zone (after all the modification parameters have been applied)</li>
<li>'odor_present': The agent can start at any point where an odor cue above the odor_present_threshold can be found at any timestep during the simulation</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_file</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset containing the olfactory data. It can be provided as a path to a file containing said array.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data_source_position</code>
            </td>
            <td>
                  <code><span title="list">list</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The center point of the source provided as a list or a 1D array with the components being x,y.
This position is computed in the olfactory data zone (so excluding the margins).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_radius</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The radius from the center point of the source in which we consider the agent has reached the source.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layers</code>
            </td>
            <td>
                  <code><span title="bool">bool</span> or <span title="list">list</span>[<span title="int">int</span>] or <span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not the data provided contains layers or not.
If a list of strings is provided, it will be either used to name the layers found (if numpy data), or it is used to querry the datasets of the h5 file.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shape</code>
            </td>
            <td>
                  <code><span title="list">list</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 2-element array or list of how many units should be kept in the final array (including the margins).
As it should include the margins, the shape should be strictly larger than the sum of the margins in each direction.
By default, the shape of the olfactory data will be maintained.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>margins</code>
            </td>
            <td>
                  <code><span title="int">int</span> or <span title="list">list</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many units have to be added to the data as margins. (Before the multiplier is applied)
If a unique element is provided, the margin will be this same value on each side.
If a list or array of 2 elements is provided, the first number will be vertical margins (y-axis), while the other will be on the x-axis (horizontal).</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>multiplier</code>
            </td>
            <td>
                  <code><span title="list">list</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 2-element array or list of how much the odor field should be streched in each direction.
If a value larger than 1 is provided, the margins will be reduced to accomodate for the larger size of the olfactory data size.
And inversly, less than 1 will increase the margins.
By default, the multipliers will be set to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>[1.0,1.0]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interpolation_method</code>
            </td>
            <td>
                  <code><span title="Nearest">Nearest</span> or <span title="Linear">Linear</span> or <span title="Cubic">Cubic</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The interpolation method to be used in the case the data needs to be reshaped to fit the shape, margins and multiplier parameters.
By default, it uses Bi-linear interpolation. The interpolation is performed using the OpenCV library.</p>
              </div>
            </td>
            <td>
                  <code>&#39;Linear&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preprocess_data</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Applicable only for data_file being a path to a h5 file.
Whether to reshape of the data at the creation of the environment.
Reshaping the data ahead of time will require more processing at the creation and more memory overall.
While if this is disabled, when gathering observations, more time will be required but less memory will need to be used at once.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>boundary_condition</code>
            </td>
            <td>
                  <code><span title="stop">stop</span> or <span title="wrap">wrap</span> or <span title="wrap_vertical">wrap_vertical</span> or <span title="wrap_horizontal">wrap_horizontal</span> or <span title="clip">clip</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How the agent should behave at the boundary.
Stop means for the agent to stop at the boundary, if the agent tries to move north while being on the top edge, it will stay in the same state.
Wrap means for the borders to be like portals, when entering on one side, it reappears on the other side.
Wrap can be specified to be only vertically or horizontally</p>
              </div>
            </td>
            <td>
                  <code>&#39;stop&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_zone</code>
            </td>
            <td>
                  <code><span title="odor_present">odor_present</span> or <span title="data_zone">data_zone</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either an array or a string representing how the starting probabilities should be constructed.
- odor_present: The start probabilities will be uniform where odor cues can be found above 0 (or a given odor_present_threshold)
- data_zone: Uniform over the data zone, so without the margins.
Note that the points within the source radius will be excluded from this probability grid.</p>
              </div>
            </td>
            <td>
                  <code>&#39;data_zone&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>odor_present_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An olfactory threshold, under which the odor is considered too low to be noticed.
It is used only to build the starting zone if the 'odor_present' option is selected.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A custom name to be given to the agent.
If it is not provided, by default it will have the format:
<shape>-marg_<margins>-edge_<boundary_condition>-start_<start_zone>-source_<source_point>_radius<source_radius></p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For reproducible randomness.</p>
              </div>
            </td>
            <td>
                  <code>12131415</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="data

  
      property
   (olfactory_navigation.Environment.data)" href="#olfactory_navigation.Environment.data">data</a></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array containing the olfactory data after the modification parameters have been applied.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.data_file_path">data_file_path</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the data is loaded from a path, the path will be recorded here.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.data_source_position">data_source_position</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The position of the source in the original data file (after modifications have been applied).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.layers">layers</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A numbered list of the IDs of the layers.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.layer_labels">layer_labels</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of how the layers are named.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.has_layers">has_layers</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not the environment is made up of layers.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.margins">margins</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of the margins vertically and horizontally (after multiplier is applied).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.timestamps">timestamps</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The amount of timeslices available in the environment.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.data_shape">data_shape</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The shape of the data's odor field (after modifications have been applied).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.dimensions">dimensions</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The amount of dimensions of the physical space of the olfactory environment.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.shape">shape</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The shape of the environment. It is a tuple of the size in each axis of the environment.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.data_bounds">data_bounds</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The bounds between which the original olfactory data stands in the coordinate system of the environment (after modifications have been applied).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.source_position">source_position</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The position of the source in the padded grid (after modifications have been applied).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.source_radius">source_radius</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The radius of the source.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.interpolation_method">interpolation_method</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The interpolation used to modify the shape of the original data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.data_processed">data_processed</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the data was processed (ie the shape is at it should be) or not.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.boundary_condition">boundary_condition</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How the agent should behave when reaching the boundary.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.start_probabilities">start_probabilities</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A probability map of where the agent is likely to start within the environment.
Note: Zero within the source radius.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.start_type">start_type</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The type of the start probability map building. For instance: 'data_zone', 'odor_present', or 'custom' (if an array is provided).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.odor_present_threshold">odor_present_threshold</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The threshold used to uild the start probabilities if the option 'odor_present' is used.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name set to the agent as defined in the parameters.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.saved_at">saved_at</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the environment is saved, the path at which it is saved will be recorded here.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.on_gpu">on_gpu</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the environment's arrays are on the gpu's memory or not.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.seed">seed</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The seed used for the random operations (to allow for reproducability).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.Environment.rnd_state">rnd_state</span></code></td>
            <td>
                  <code><span title="numpy.random.RandomState">RandomState</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The random state variable used to generate random values.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="cpu_version

  
      property
   (olfactory_navigation.Environment.cpu_version)" href="#olfactory_navigation.Environment.cpu_version">cpu_version</a></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.environment.Environment)" href="environment/#olfactory_navigation.environment.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the environment on the CPU. If it already is, it returns itself.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="gpu_version

  
      property
   (olfactory_navigation.Environment.gpu_version)" href="#olfactory_navigation.Environment.gpu_version">gpu_version</a></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.environment.Environment)" href="environment/#olfactory_navigation.environment.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the environment on the CPU. If it already is, it returns itself.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Environment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class to represent an olfactory environment.</span>

<span class="sd">    It is defined based on an olfactory data set provided as either a numpy file or an array directly with shape time, y, x.</span>
<span class="sd">    From this environment, the various parameters are applied in the following order:</span>

<span class="sd">    0. The source position is set</span>
<span class="sd">    1. The margins are added and the shape (total size) of the environment are set.</span>
<span class="sd">    2. The data file&#39;s x and y components are squished and streched the to fit the inter-marginal shape of the environment.</span>
<span class="sd">    3. The source&#39;s position is also moved to stay at the same position within the data.</span>
<span class="sd">    4. The multiplier is finally applied to modify the data file&#39;s x and y components a final time by growing or shrinking the margins to account for the multiplier. (The multiplication applies with the source position as a center point)</span>

<span class="sd">    Note: to modify the shape of the data file&#39;s x and y components the OpenCV library&#39;s resize function is used. And the interpolation method is controlled by the interpolation_method parameter.</span>


<span class="sd">    Then, the starting probability map is built. Either an array can be provided directly or preset option can be chosen:</span>

<span class="sd">    - &#39;data_zone&#39;: The agent can start at any point in the data_zone (after all the modification parameters have been applied)</span>
<span class="sd">    - &#39;odor_present&#39;: The agent can start at any point where an odor cue above the odor_present_threshold can be found at any timestep during the simulation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_file : str or np.ndarray</span>
<span class="sd">        The dataset containing the olfactory data. It can be provided as a path to a file containing said array.</span>
<span class="sd">    data_source_position : list or np.ndarray</span>
<span class="sd">        The center point of the source provided as a list or a 1D array with the components being x,y.</span>
<span class="sd">        This position is computed in the olfactory data zone (so excluding the margins).</span>
<span class="sd">    source_radius : float, default=1.0</span>
<span class="sd">        The radius from the center point of the source in which we consider the agent has reached the source.</span>
<span class="sd">    layers : bool or list[int] or list[str], default=False</span>
<span class="sd">        Whether or not the data provided contains layers or not.</span>
<span class="sd">        If a list of strings is provided, it will be either used to name the layers found (if numpy data), or it is used to querry the datasets of the h5 file.</span>
<span class="sd">    shape : list or np.ndarray, optional</span>
<span class="sd">        A 2-element array or list of how many units should be kept in the final array (including the margins).</span>
<span class="sd">        As it should include the margins, the shape should be strictly larger than the sum of the margins in each direction.</span>
<span class="sd">        By default, the shape of the olfactory data will be maintained.</span>
<span class="sd">    margins : int or list or np.ndarray, default=0</span>
<span class="sd">        How many units have to be added to the data as margins. (Before the multiplier is applied)</span>
<span class="sd">        If a unique element is provided, the margin will be this same value on each side.</span>
<span class="sd">        If a list or array of 2 elements is provided, the first number will be vertical margins (y-axis), while the other will be on the x-axis (horizontal).</span>
<span class="sd">    multiplier : list or np.ndarray, default=[1.0,1.0]</span>
<span class="sd">        A 2-element array or list of how much the odor field should be streched in each direction.</span>
<span class="sd">        If a value larger than 1 is provided, the margins will be reduced to accomodate for the larger size of the olfactory data size.</span>
<span class="sd">        And inversly, less than 1 will increase the margins.</span>
<span class="sd">        By default, the multipliers will be set to 1.0.</span>
<span class="sd">    interpolation_method : &#39;Nearest&#39; or &#39;Linear&#39; or &#39;Cubic&#39;, default=&#39;Linear&#39;</span>
<span class="sd">        The interpolation method to be used in the case the data needs to be reshaped to fit the shape, margins and multiplier parameters.</span>
<span class="sd">        By default, it uses Bi-linear interpolation. The interpolation is performed using the OpenCV library.</span>
<span class="sd">    preprocess_data : bool, default=False</span>
<span class="sd">        Applicable only for data_file being a path to a h5 file.</span>
<span class="sd">        Whether to reshape of the data at the creation of the environment.</span>
<span class="sd">        Reshaping the data ahead of time will require more processing at the creation and more memory overall.</span>
<span class="sd">        While if this is disabled, when gathering observations, more time will be required but less memory will need to be used at once.</span>
<span class="sd">    boundary_condition : &#39;stop&#39; or &#39;wrap&#39; or &#39;wrap_vertical&#39; or &#39;wrap_horizontal&#39; or &#39;clip&#39;, default=&#39;stop&#39;</span>
<span class="sd">        How the agent should behave at the boundary.</span>
<span class="sd">        Stop means for the agent to stop at the boundary, if the agent tries to move north while being on the top edge, it will stay in the same state.</span>
<span class="sd">        Wrap means for the borders to be like portals, when entering on one side, it reappears on the other side.</span>
<span class="sd">        Wrap can be specified to be only vertically or horizontally</span>
<span class="sd">    start_zone : &#39;odor_present&#39; or &#39;data_zone&#39; or np.ndarray, default=&#39;data_zone&#39;</span>
<span class="sd">        Either an array or a string representing how the starting probabilities should be constructed.</span>
<span class="sd">        - odor_present: The start probabilities will be uniform where odor cues can be found above 0 (or a given odor_present_threshold)</span>
<span class="sd">        - data_zone: Uniform over the data zone, so without the margins.</span>
<span class="sd">        Note that the points within the source radius will be excluded from this probability grid.</span>
<span class="sd">    odor_present_threshold : float, optional</span>
<span class="sd">        An olfactory threshold, under which the odor is considered too low to be noticed.</span>
<span class="sd">        It is used only to build the starting zone if the &#39;odor_present&#39; option is selected.</span>
<span class="sd">    name : str, optional</span>
<span class="sd">        A custom name to be given to the agent.</span>
<span class="sd">        If it is not provided, by default it will have the format:</span>
<span class="sd">        &lt;shape&gt;-marg_&lt;margins&gt;-edge_&lt;boundary_condition&gt;-start_&lt;start_zone&gt;-source_&lt;source_point&gt;_radius&lt;source_radius&gt;</span>
<span class="sd">    seed : int, default=12131415</span>
<span class="sd">        For reproducible randomness.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data : np.ndarray</span>
<span class="sd">        An array containing the olfactory data after the modification parameters have been applied.</span>
<span class="sd">    data_file_path : str</span>
<span class="sd">        If the data is loaded from a path, the path will be recorded here.</span>
<span class="sd">    data_source_position : np.ndarray</span>
<span class="sd">        The position of the source in the original data file (after modifications have been applied).</span>
<span class="sd">    layers : np.ndarray</span>
<span class="sd">        A numbered list of the IDs of the layers.</span>
<span class="sd">    layer_labels : list[str]</span>
<span class="sd">        A list of how the layers are named.</span>
<span class="sd">    has_layers : bool</span>
<span class="sd">        Whether or not the environment is made up of layers.</span>
<span class="sd">    margins : np.ndarray</span>
<span class="sd">        An array of the margins vertically and horizontally (after multiplier is applied).</span>
<span class="sd">    timestamps : int</span>
<span class="sd">        The amount of timeslices available in the environment.</span>
<span class="sd">    data_shape : tuple[int]</span>
<span class="sd">        The shape of the data&#39;s odor field (after modifications have been applied).</span>
<span class="sd">    dimensions : int</span>
<span class="sd">        The amount of dimensions of the physical space of the olfactory environment.</span>
<span class="sd">    shape : tuple[int]</span>
<span class="sd">        The shape of the environment. It is a tuple of the size in each axis of the environment.</span>
<span class="sd">    data_bounds : np.ndarray</span>
<span class="sd">        The bounds between which the original olfactory data stands in the coordinate system of the environment (after modifications have been applied).</span>
<span class="sd">    source_position : np.ndarray</span>
<span class="sd">        The position of the source in the padded grid (after modifications have been applied).</span>
<span class="sd">    source_radius : float</span>
<span class="sd">        The radius of the source.</span>
<span class="sd">    interpolation_method : str</span>
<span class="sd">        The interpolation used to modify the shape of the original data.</span>
<span class="sd">    data_processed : bool</span>
<span class="sd">        Whether the data was processed (ie the shape is at it should be) or not.</span>
<span class="sd">    boundary_condition : str</span>
<span class="sd">        How the agent should behave when reaching the boundary.</span>
<span class="sd">    start_probabilities : np.ndarray</span>
<span class="sd">        A probability map of where the agent is likely to start within the environment.</span>
<span class="sd">        Note: Zero within the source radius.</span>
<span class="sd">    start_type : str</span>
<span class="sd">        The type of the start probability map building. For instance: &#39;data_zone&#39;, &#39;odor_present&#39;, or &#39;custom&#39; (if an array is provided).</span>
<span class="sd">    odor_present_threshold : float</span>
<span class="sd">        The threshold used to uild the start probabilities if the option &#39;odor_present&#39; is used.</span>
<span class="sd">    name : str</span>
<span class="sd">        The name set to the agent as defined in the parameters.</span>
<span class="sd">    saved_at : str</span>
<span class="sd">        If the environment is saved, the path at which it is saved will be recorded here.</span>
<span class="sd">    on_gpu : bool</span>
<span class="sd">        Whether the environment&#39;s arrays are on the gpu&#39;s memory or not.</span>
<span class="sd">    seed : int</span>
<span class="sd">        The seed used for the random operations (to allow for reproducability).</span>
<span class="sd">    rnd_state : np.random.RandomState</span>
<span class="sd">        The random state variable used to generate random values.</span>
<span class="sd">    cpu_version : Environment</span>
<span class="sd">        An instance of the environment on the CPU. If it already is, it returns itself.</span>
<span class="sd">    gpu_version : Environment</span>
<span class="sd">        An instance of the environment on the CPU. If it already is, it returns itself.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">data_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">data_source_position</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">source_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">layers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">shape</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">margins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">multiplier</span><span class="p">:</span> <span class="nb">list</span><span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                 <span class="n">interpolation_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;Nearest&#39;</span><span class="p">,</span> <span class="s1">&#39;Linear&#39;</span><span class="p">,</span> <span class="s1">&#39;Cubic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Linear&#39;</span><span class="p">,</span>
                 <span class="n">preprocess_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">boundary_condition</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;wrap&#39;</span><span class="p">,</span> <span class="s1">&#39;wrap_vertical&#39;</span><span class="p">,</span> <span class="s1">&#39;wrap_horizontal&#39;</span><span class="p">,</span> <span class="s1">&#39;clip&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                 <span class="n">start_zone</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;odor_present&#39;</span><span class="p">,</span> <span class="s1">&#39;data_zone&#39;</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="s1">&#39;data_zone&#39;</span><span class="p">,</span>
                 <span class="n">odor_present_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12131415</span><span class="p">,</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_at</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Layer properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="o">=</span> <span class="n">layers</span>

        <span class="c1"># Load from file if string provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">preprocess_data</span>

        <span class="n">loaded_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="o">=</span> <span class="n">data_file</span>

            <span class="c1"># NUMPY</span>
            <span class="k">if</span> <span class="n">data_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
                <span class="n">loaded_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

                <span class="c1"># Layered data</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">))]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">)),</span> <span class="s2">&quot;The amount of layers provided dont match the amount in the dataset.&quot;</span>

                        <span class="c1"># Re-ordering the layers</span>
                        <span class="n">loaded_data</span> <span class="o">=</span> <span class="n">loaded_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">]</span>

            <span class="c1"># H5</span>
            <span class="k">elif</span> <span class="n">data_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">):</span>
                <span class="n">loaded_data</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

                <span class="c1"># Layered data</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>

                    <span class="c1"># Converting layers to strings</span>
                    <span class="n">data_layer_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">loaded_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_layer_labels</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="o">=</span> <span class="n">data_layer_labels</span>

                    <span class="c1"># Getting the labels based on the list of integers provided</span>
                    <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_layer_labels</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">]</span>

                    <span class="c1"># Loading the list of slices from the data</span>
                    <span class="n">loaded_data</span> <span class="o">=</span> <span class="p">[[</span><span class="n">loaded_data</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">[</span><span class="n">layer</span><span class="p">]))]</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loaded_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">loaded_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">))]</span>

            <span class="c1"># Not supported</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;File format loading not implemented&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Data file should be either a path or an object that is either an h5 object or a numpy array&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">loaded_data</span> <span class="k">if</span> <span class="n">loaded_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">data_file</span>

        <span class="c1"># Unmodified sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_source_position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_data_source_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span>

        <span class="n">original_data_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span>

        <span class="c1"># Making margins a |dims|x2 array</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">margins</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">margins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">margins</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">margins</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">margins</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">margins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">margins</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">margins</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,):</span> <span class="c1"># Symmetric min and max margins</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">margins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">margins</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">margins</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">margins</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">margins</span> <span class="o">=</span> <span class="n">margins</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The array or lists of Margins provided have a shape not supported. (Supported formats (2,) or (2,2))&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;margins argument should be either an integer or a 1D or 2D array with either shape (2) or (2,2)&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">int</span><span class="p">),</span> <span class="s1">&#39;margins should be integers&#39;</span>

        <span class="c1"># Process shape parameter</span>
        <span class="n">new_data_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">shape</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="s2">&quot;The shape of the environment must be strictly larger than the sum of margins.&quot;</span>

            <span class="c1"># Computing the new shape of the data</span>
            <span class="n">new_data_shape</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="c1"># New source position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span> <span class="o">*</span> <span class="p">(</span><span class="n">new_data_shape</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_data_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">new_data_shape</span><span class="p">,)</span>

        <span class="c1"># Process multiplier</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">multiplier</span><span class="p">)</span>

        <span class="c1"># Assert multiplier value is correct</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">low_max_mult</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">high_max_mult</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span><span class="p">)))</span>
            <span class="n">max_mult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">low_max_mult</span><span class="p">,</span> <span class="n">high_max_mult</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">multiplier</span> <span class="o">&lt;=</span> <span class="n">max_mult</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The multiplier given is larger than allowed (the values should be lower than </span><span class="si">{</span><span class="n">max_mult</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="c1"># Compute new data shape with the multiplier</span>
        <span class="k">if</span> <span class="n">new_data_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_data_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span>
        <span class="n">new_data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_data_shape</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># New source position based on multiplier</span>
        <span class="n">new_source_position</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Recomputing margins with new source position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="n">new_source_position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_data_shape</span><span class="p">))</span>

        <span class="c1"># Re-Setting new source position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span> <span class="o">=</span> <span class="n">new_source_position</span>

        <span class="c1"># Interpolation method choice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span> <span class="o">=</span> <span class="n">interpolation_method</span>

        <span class="c1"># Input the new shape of the data if set by custom shape or multiplier</span>
        <span class="k">if</span> <span class="n">new_data_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">new_data_shape</span><span class="p">,)</span>

        <span class="c1"># Check if data is already processed by default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span> <span class="o">==</span> <span class="n">original_data_shape</span><span class="p">)</span>

        <span class="c1"># If requested process all the slices of data into a single</span>
        <span class="k">if</span> <span class="n">preprocess_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Higher dimensional data doesnt support reshaping yet, ensure it is done beforehand..&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">):</span>
                        <span class="n">new_data</span><span class="p">[</span><span class="n">layer</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                                                           <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                                           <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">):</span>
                    <span class="n">new_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                                                <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                                <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">new_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Reading shape of data array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),)</span>

        <span class="c1"># Converting the shape tuple to integer sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">])</span>

        <span class="c1"># Building a data bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Saving arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span> <span class="o">=</span> <span class="n">source_radius</span>

        <span class="c1"># Boundary conditions</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">boundary_condition</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;wrap_vertical&#39;</span><span class="p">,</span> <span class="s1">&#39;wrap_horizontal&#39;</span><span class="p">])),</span> <span class="s2">&quot;There are more than 2 dimensions, the options of &#39;wrap_horizontal&#39; and &#39;wrap_vertical&#39; are disabled.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">=</span> <span class="n">boundary_condition</span>

        <span class="c1"># Starting zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_type</span> <span class="o">=</span> <span class="n">start_zone</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_zone</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;custom&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_zone</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">start_zone</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">slices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span> <span class="k">for</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="ow">in</span> <span class="n">start_zone</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="p">[</span><span class="n">slices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_type</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">start_zone</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
            <span class="k">elif</span> <span class="n">start_zone</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span> <span class="o">=</span> <span class="n">start_zone</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;If an np.ndarray is provided for the start_zone it has to be |dim| x 2...&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">start_zone</span> <span class="o">==</span> <span class="s1">&#39;data_zone&#39;</span><span class="p">:</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span> <span class="k">for</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="p">[</span><span class="n">slices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">elif</span> <span class="n">start_zone</span> <span class="o">==</span> <span class="s1">&#39;odor_present&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">odor_present_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">odor_present_threshold</span> <span class="k">if</span> <span class="n">odor_present_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span> <span class="k">for</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">)]</span> <span class="o">=</span> <span class="n">odor_present_map</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">odor_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">):</span>
                    <span class="n">data_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">reshaped_data_slice</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">data_slice</span><span class="p">,</span>
                                                        <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                                        <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="n">odor_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">reshaped_data_slice</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">odor_present_threshold</span> <span class="k">if</span> <span class="n">odor_present_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span> <span class="k">for</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">odor_sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;start_zone value is wrong&#39;</span><span class="p">)</span>

        <span class="c1"># Odor present tresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span> <span class="o">=</span> <span class="n">odor_present_threshold</span>

        <span class="c1"># Removing the source area from the starting zone</span>
        <span class="n">source_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfunction</span><span class="p">((</span><span class="k">lambda</span> <span class="o">*</span><span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[</span><span class="kc">None</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="p">[</span><span class="n">source_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="p">)</span> <span class="c1"># Normalization</span>

        <span class="c1"># Name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span>  <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">axis_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis_size</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span> <span class="c1"># Size of env</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;-marg_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">marg</span><span class="p">)</span> <span class="k">for</span> <span class="n">marg</span> <span class="ow">in</span> <span class="n">dim_margins</span><span class="p">])</span> <span class="k">for</span> <span class="n">dim_margins</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">])</span> <span class="c1"># margins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;-edge_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1"># Boundary condition</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;-start_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_type</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1"># Start zone</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;-source_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">])</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_radius</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1"># Source</span>

        <span class="c1"># gpu support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># random state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnd_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The whole dataset with the right shape. If not preprocessed to modify its shape the data will be processed when querrying this object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_is_numpy</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span><span class="p">:</span>
            <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[Warning] The whole dataset is being querried, it will be reshaped at this time. To avoid this, avoid querrying environment.data directly.&#39;</span><span class="p">)</span>

            <span class="c1"># Reshaping</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">):</span>
                        <span class="n">new_data</span><span class="p">[</span><span class="n">layer</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                                                           <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                                           <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">):</span>
                    <span class="n">new_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                                                <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                                <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_data_is_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wheter the data is a numpy array or not.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
             <span class="n">layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
             <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Simple function to plot the environment with a single frame of odor cues.</span>
<span class="sd">        The starting zone is also market down with a blue contour.</span>
<span class="sd">        The source of the odor is marked by a red circle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frame : int, default=0</span>
<span class="sd">            The frame of odor cues to print.</span>
<span class="sd">        layer : int, default=0</span>
<span class="sd">            The layer of the odor cues to print. (Ignored if the environment is not layered.)</span>
<span class="sd">        ax : plt.Axes, optional</span>
<span class="sd">            An ax on which the environment can be plot.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># If on GPU use the CPU version to plot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="c1"># Blank return</span>

        <span class="c1"># TODO: Implement plotting for 3D</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Plotting function only available for 2D environments for now...&quot;</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

        <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[[],[]]</span>

        <span class="c1"># Gather data frame</span>
        <span class="n">data_frame</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_frame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">data_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span><span class="p">:</span>
            <span class="n">data_frame</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">data_frame</span><span class="p">,</span>
                                       <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                       <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="c1"># Odor grid</span>
        <span class="n">odor</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_frame</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">environment_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">environment_frame</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">frame_data</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">environment_frame</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">)</span>

        <span class="n">legend_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">odor</span><span class="p">)</span>
        <span class="n">legend_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frame </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39; (layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; odor cues&#39;</span><span class="p">)</span>

        <span class="c1"># Start zone contour</span>
        <span class="n">start_zone</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

        <span class="n">legend_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_zone</span><span class="p">)</span>
        <span class="n">legend_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Start zone&#39;</span><span class="p">)</span>

        <span class="c1"># Source circle</span>
        <span class="n">goal_circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">legend_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">goal_circle</span><span class="p">)</span>
        <span class="n">legend_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Source&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">goal_circle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

        <span class="c1"># Legend</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">legend_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                        <span class="n">time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to get an observation at a given position on the grid at a given time.</span>
<span class="sd">        A set of observations can also be requested, either at a single position for multiple timestamps or with the same amoung of positions as timestamps provided.</span>

<span class="sd">        Note: The position will not be checked against boundary conditions; if a position is out-of-bounds it will simply return 0.0!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos : np.ndarray</span>
<span class="sd">            The position or list of positions to get observations at.</span>
<span class="sd">        time : int or np.ndarray, default=0</span>
<span class="sd">            A timestamp or list of timestamps to get the observations at.</span>
<span class="sd">        layer : int or np.ndarray, default=0</span>
<span class="sd">            A layer or list of timestamps to get the observations at.</span>
<span class="sd">            Note: If the environment doesnt have layers, this parameter will be ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        observation : float or np.ndarray</span>
<span class="sd">            A single observation or list of observations.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>

        <span class="c1"># Handling the case of a single point</span>
        <span class="n">is_single_point</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_single_point</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

        <span class="c1"># Counting how many position points we are dealing with</span>
        <span class="n">pos_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

        <span class="c1"># Time looping</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span>

        <span class="c1"># Determine unique layers and reindexing them if needed</span>
        <span class="n">unique_layers</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">layer</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">unique_layers</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">layer_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_layers</span><span class="p">)</span>

        <span class="c1"># Determine unique times and reindexing them if needed</span>
        <span class="n">unique_times</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">time</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">unique_time_indices</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">time</span> <span class="o">==</span> <span class="n">unique_times</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_times</span><span class="p">)</span>

        <span class="c1"># Handling the case where the data is a sequence of slices (h5, so not numpy array)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

        <span class="c1"># Selecting the required slices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_is_numpy</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">unique_layers</span><span class="p">][:,</span><span class="n">unique_times</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="n">unique_times</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Case where we are dealing with a h5 file</span>
            <span class="c1"># Note: Can&#39;t use self.data_shape because we don&#39;t know whether the data is processed yet or no</span>
            <span class="n">selected_slices</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">layer_count</span><span class="p">,</span> <span class="n">time_count</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">time_count</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_times</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_layers</span><span class="p">):</span>
                        <span class="n">selected_slices</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)][</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selected_slices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">selected_slices</span><span class="p">)</span>

        <span class="c1"># Handle the case it needs to be processed on the fly</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span><span class="p">:</span>
            <span class="n">reshaped_data</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">layer_count</span><span class="p">,</span> <span class="n">time_count</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">time_count</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">time_count</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_count</span><span class="p">):</span>
                        <span class="n">reshaped_data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">],</span>
                                                           <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                                           <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reshaped_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                     <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                                     <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reshaped_data</span><span class="p">)</span>

        <span class="c1"># Return 0.0 if outside of data zone</span>
        <span class="n">data_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">,:]</span>
        <span class="n">data_pos_valid</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">data_pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_pos</span> <span class="o">&lt;</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">observation</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pos_count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Gathering data on layered data on not</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>
            <span class="n">observation</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">layer</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">layer</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">]),</span> <span class="c1"># layer</span>
                                               <span class="p">(</span><span class="n">unique_time_indices</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unique_time_indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">unique_time_indices</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">]),</span> <span class="c1"># t</span>
                                               <span class="o">*</span><span class="n">data_pos</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="c1"># physical position</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">observation</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">unique_time_indices</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unique_time_indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">unique_time_indices</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">]),</span> <span class="c1"># t</span>
                                               <span class="o">*</span><span class="n">data_pos</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="c1"># physical position</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">observation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_single_point</span> <span class="k">else</span> <span class="n">observation</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">source_reached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks whether a given position is within the source radius.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos : np.ndarray</span>
<span class="sd">            The position to check whether in the radius of the source.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        is_at_source : bool</span>
<span class="sd">            Whether or not the position is within the radius of the source.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>

        <span class="c1"># Handling the case of a single point</span>
        <span class="n">is_single_point</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_single_point</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

        <span class="n">is_at_source</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[</span><span class="kc">None</span><span class="p">,:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">is_at_source</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_single_point</span> <span class="k">else</span> <span class="n">is_at_source</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">random_start_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to generate n starting positions following the starting probabilities.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n : int, default=1</span>
<span class="sd">            How many random starting positions to generate</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        random_states_2d : np.ndarray</span>
<span class="sd">            The n random 2d points in a n x 2 array.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>

        <span class="k">assert</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;n has to be a strictly positive number (&gt;0)&quot;</span>

        <span class="n">random_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnd_state</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))),</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">random_states_2d</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">random_states</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">random_states_2d</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">movement</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Applies a movement vector to a position point and returns a new position point while respecting the boundary conditions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos : np.ndarray</span>
<span class="sd">            The start position of the movement.</span>
<span class="sd">        movement : np.ndarray</span>
<span class="sd">            A 2D movement vector.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_pos : np.ndarray</span>
<span class="sd">            The new position after applying the movement.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>

        <span class="c1"># Applying the movement vector</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">movement</span>

        <span class="c1"># Handling the case we are dealing with a single point.</span>
        <span class="n">is_single_point</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_single_point</span><span class="p">:</span>
            <span class="n">new_pos</span> <span class="o">=</span> <span class="n">new_pos</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

        <span class="n">shape_array</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:]</span>

        <span class="c1"># Wrap boundary</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;wrap&#39;</span><span class="p">:</span>
            <span class="n">new_pos</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">new_pos</span> <span class="o">+</span> <span class="n">shape_array</span><span class="p">),</span> <span class="n">new_pos</span><span class="p">)</span>
            <span class="n">new_pos</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">&gt;=</span> <span class="n">shape_array</span><span class="p">,</span> <span class="p">(</span><span class="n">new_pos</span> <span class="o">-</span> <span class="n">shape_array</span><span class="p">),</span> <span class="n">new_pos</span><span class="p">)</span>

        <span class="c1"># Stop boundary</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span>
            <span class="n">new_pos</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">new_pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">shape_array</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Special wrap - vertical only</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;wrap_vertical&#39;</span><span class="p">):</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>

            <span class="n">new_pos</span><span class="p">[</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">height</span>
            <span class="n">new_pos</span><span class="p">[</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">height</span>

            <span class="n">new_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Special wrap - horizontal only</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;wrap_horizontal&#39;</span><span class="p">):</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>

            <span class="n">new_pos</span><span class="p">[</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">width</span>
            <span class="n">new_pos</span><span class="p">[</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">width</span>

            <span class="n">new_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">is_single_point</span> <span class="k">else</span> <span class="n">new_pos</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">distance_to_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">point</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                           <span class="n">metric</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;manhattan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;manhattan&#39;</span>
                           <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to compute the distance(s) between given points and the source point.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        point : np.ndarray</span>
<span class="sd">            A single or an Nx2 array containing N points.</span>
<span class="sd">        metric : &#39;manhattan&#39;</span>
<span class="sd">            The metric to use to compute the distance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dist : float or np.ndarray</span>
<span class="sd">            A single distance or a list of distance in a 1D distance array.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>

        <span class="c1"># Handling the case we have a single point</span>
        <span class="n">is_single_point</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_single_point</span><span class="p">:</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

        <span class="c1"># Computing dist</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;manhattan&#39;</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">point</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span>

        <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Meaning it was not computed</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This distance metric has not yet been implemented&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_single_point</span> <span class="k">else</span> <span class="n">dist</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">save_arrays</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to save the environment to the memory.</span>

<span class="sd">        By default it saved in a new folder at the current path in a new folder with the name &#39;Env-&lt;name&gt;&#39; where &lt;name&gt; is the name set when initializing an environment.</span>
<span class="sd">        In this folder a file &quot;METADATA.json&quot; is created containing all the properties of the environment.</span>

<span class="sd">        The numpy arrays of the environment (grid and start_probabilities) can be saved or not. If not, when the environment is loaded it needs to be reconstructed from the original data file.</span>
<span class="sd">        The arrays are saved to .npy files along with the METADATA file.</span>

<span class="sd">        If an environment of the same name is already saved, the saving will be interupted. It can however be forced with the force parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folder : str, optional</span>
<span class="sd">            The folder to which to save the environment data. If it is not provided, it will be created in the current folder.</span>
<span class="sd">        save_arrays : bool, default=False</span>
<span class="sd">            Whether or not to save the numpy arrays to memory. (The arrays can be heavy)</span>
<span class="sd">        force : bool, default=False</span>
<span class="sd">            In case an environment of the same name is already saved, it will be overwritten.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># If on gpu, use the cpu version to save</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
                <span class="n">save_arrays</span><span class="o">=</span><span class="n">save_arrays</span><span class="p">,</span>
                <span class="n">force</span><span class="o">=</span><span class="n">force</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="c1"># Blank return</span>

        <span class="c1"># Assert either data_file is provided or save_arrays is enabled</span>
        <span class="k">assert</span> <span class="n">save_arrays</span> <span class="ow">or</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)),</span> <span class="s2">&quot;The environment was not created from a data file so &#39;save_arrays&#39; has to be set to True.&quot;</span>

        <span class="c1"># Adding env name to folder path</span>
        <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./Env-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">+=</span> <span class="s1">&#39;/Env-&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Checking the folder exists or creates it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1"> is not empty. If you want to overwrite the saved model, enable &quot;force&quot;.&#39;</span><span class="p">)</span>

        <span class="c1"># Generating the metadata arguments dictionary</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_file_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span>

        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;timesteps&#39;</span><span class="p">]</span>                     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">)</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_shape&#39;</span><span class="p">]</span>                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span>                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;margins&#39;</span><span class="p">]</span>                       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>                         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_bounds&#39;</span><span class="p">]</span>                   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;original_data_source_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_data_source_position</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_source_position&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span>                        <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;source_position&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;source_radius&#39;</span><span class="p">]</span>                 <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;interpolation_method&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;preprocess_data&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_processed&#39;</span><span class="p">]</span>                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;boundary_condition&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;start_type&#39;</span><span class="p">]</span>                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_type</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>                          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span>

        <span class="c1"># Check how the start probabilities were built</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">save_arrays</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Start probabilities have been set from a custom array, please enable save_arrays to be able to reconstruct the environment later.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;odor_present_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span>

        <span class="c1"># Output the arguments to a METADATA file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/METADATA.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># Output the numpy arrays</span>
        <span class="k">if</span> <span class="n">save_arrays</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/data.npy&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The saving of data that is not a Numpy array was not implemented yet.&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/start_probabilities.npy&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="p">)</span>

        <span class="c1"># Success print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_at</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Environment saved to: </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
             <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to load an environment from a given folder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folder : str</span>
<span class="sd">            The folder of the Environment.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loaded_env : Environment</span>
<span class="sd">            The loaded environment.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;Folder doesn&#39;t exist...&quot;</span>
        <span class="k">assert</span> <span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Env-&#39;</span><span class="p">),</span> <span class="s2">&quot;The folder provided is not the data of en Environment object.&quot;</span>

        <span class="c1"># Load arguments</span>
        <span class="n">arguments</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/METADATA.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

        <span class="c1"># Check if numpy arrays are provided, if not, recreate a new environment model</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/data.npy&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/start_probabilities.npy&#39;</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/data.npy&#39;</span><span class="p">)</span>
            <span class="n">start_probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/start_probabilities.npy&#39;</span><span class="p">)</span>

            <span class="n">loaded_env</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

            <span class="c1"># Set the arguments</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">name</span>                          <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">timesteps</span>                     <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;timesteps&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">data_shape</span>                    <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_shape&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">dimensions</span>                    <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">margins</span>                       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;margins&#39;</span><span class="p">])</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">shape</span>                         <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">data_bounds</span>                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_bounds&#39;</span><span class="p">])</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">original_data_source_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;original_data_source_position&#39;</span><span class="p">])</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">data_source_position</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_source_position&#39;</span><span class="p">])</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">source_position</span>               <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;source_position&#39;</span><span class="p">])</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">source_radius</span>                 <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;source_radius&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">has_layers</span>                    <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">layers</span>                        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">loaded_env</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">layer_labels</span>                  <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">interpolation_method</span>          <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;interpolation_method&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">_preprocess_data</span>              <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;preprocess_data&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">data_processed</span>                <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_processed&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">boundary_condition</span>            <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;boundary_condition&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">on_gpu</span>                        <span class="o">=</span> <span class="kc">False</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">seed</span>                          <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">rnd_state</span>                     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">])</span>

            <span class="c1"># Optional arguments</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">data_file_path</span>                <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_file_path&#39;</span><span class="p">)</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">odor_present_threshold</span>        <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;odor_present_threshold&#39;</span><span class="p">)</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">start_type</span>                    <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_type&#39;</span><span class="p">)</span>

            <span class="c1"># Arrays</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">loaded_env</span><span class="o">.</span><span class="n">start_probabilities</span> <span class="o">=</span> <span class="n">start_probabilities</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_zone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;start_type&#39;</span><span class="p">]</span>
            <span class="n">start_zone_boundaries</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">start_zone</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">):</span>
                <span class="n">start_zone_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_zone</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="n">loaded_env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
                <span class="n">data_file</span>              <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_file_path&#39;</span><span class="p">],</span>
                <span class="n">data_source_position</span>   <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;original_data_source_position&#39;</span><span class="p">],</span>
                <span class="n">source_radius</span>          <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;source_radius&#39;</span><span class="p">],</span>
                <span class="n">layers</span>                 <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">],</span>
                <span class="n">shape</span>                  <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">],</span>
                <span class="n">margins</span>                <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;margins&#39;</span><span class="p">],</span>
                <span class="n">interpolation_method</span>   <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;interpolation_method&#39;</span><span class="p">],</span>
                <span class="n">preprocess_data</span>        <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;preprocess_data&#39;</span><span class="p">],</span>
                <span class="n">boundary_condition</span>     <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;boundary_condition&#39;</span><span class="p">],</span>
                <span class="n">start_zone</span>             <span class="o">=</span> <span class="p">(</span><span class="n">start_zone_boundaries</span> <span class="k">if</span> <span class="n">start_zone_boundaries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">start_zone</span><span class="p">),</span>
                <span class="n">odor_present_threshold</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;odor_present_threshold&#39;</span><span class="p">),</span>
                <span class="n">name</span>                   <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="n">seed</span>                   <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Folder where the environment was pulled from</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">saved_at</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loaded_env</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">to_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to send the numpy arrays of the environment to the gpu memory.</span>
<span class="sd">        It returns a new instance of the Environment with the arrays as cupy arrays.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gpu_environment : Environment</span>
<span class="sd">            A new environment instance where the arrays are on the gpu memory.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Check whether the environment is already on the gpu or not</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Warn and overwrite alternate_version in case it already exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[warning] A GPU instance already existed and is being recreated.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="n">gpu_support</span><span class="p">,</span> <span class="s2">&quot;GPU support is not enabled...&quot;</span>

        <span class="c1"># Generating a new instance</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">gpu_environment</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="c1"># Copying arguments to gpu</span>
        <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;rnd_state&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># Self reference instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="n">gpu_environment</span>
        <span class="n">gpu_environment</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">gpu_environment</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">gpu_environment</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">to_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to send the numpy arrays of the environment to the cpu memory.</span>
<span class="sd">        It returns a new instance of the Environment with the arrays as numpy arrays.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cpu_environment : Environment</span>
<span class="sd">            A new environment instance where the arrays are on the cpu memory.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Check whether the agent is already on the cpu or not</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[warning] A CPU instance already existed and is being recreated.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Generating a new instance</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">cpu_environment</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="c1"># Copying arguments to gpu</span>
        <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;rnd_state&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># Self reference instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="n">cpu_environment</span>
        <span class="n">cpu_environment</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">cpu_environment</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">cpu_environment</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gpu_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A version of the Environment on the GPU.</span>
<span class="sd">        If the environment is already on the GPU it returns itself, otherwise the to_gpu function is called to generate a new one.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Check if an alternate version already exists</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Generate an alternate version on the gpu</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_gpu</span><span class="p">()</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cpu_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A version of the Environment on the CPU.</span>
<span class="sd">        If the environment is already on the CPU it returns itself, otherwise the to_cpu function is called to generate a new one.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Check if an alternate version already exists</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Generate an alternate version on the cpu</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_cpu</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">modify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">data_source_position</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">source_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">shape</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">margins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">multiplier</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">interpolation_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">boundary_condition</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
               <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a copy of the environment with one or more parameters modified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_source_position: list or np.ndarray, optional</span>
<span class="sd">            A new position for the source relative to the data file.</span>
<span class="sd">        source_radius: float, optional</span>
<span class="sd">            A new source radius.</span>
<span class="sd">        shape: list or np.ndarray, optional</span>
<span class="sd">            A new shape of environment.</span>
<span class="sd">        margins: int or list or np.ndarray, optional</span>
<span class="sd">            A new set of margins.</span>
<span class="sd">        multiplier: list or np.ndarray, optional</span>
<span class="sd">            A new multiplier to be applied to the data file (this will in turn increase or reduce the margins).</span>
<span class="sd">        interpolation_method: str, optional</span>
<span class="sd">            A new interpolation method to be used.</span>
<span class="sd">        boundary_condition: str, optional</span>
<span class="sd">            New boundary conditions for how the agent should behave at the edges.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        modified_environment</span>
<span class="sd">            A copy of the environment where the modified parameters have been applied.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
            <span class="n">cpu_environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_version</span>
            <span class="n">new_cpu_environment</span> <span class="o">=</span> <span class="n">cpu_environment</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span>
                <span class="n">data_source_position</span> <span class="o">=</span> <span class="n">data_source_position</span><span class="p">,</span>
                <span class="n">source_radius</span>        <span class="o">=</span> <span class="n">source_radius</span><span class="p">,</span>
                <span class="n">shape</span>                <span class="o">=</span> <span class="n">shape</span><span class="p">,</span>
                <span class="n">margins</span>              <span class="o">=</span> <span class="n">margins</span><span class="p">,</span>
                <span class="n">multiplier</span>           <span class="o">=</span> <span class="n">multiplier</span><span class="p">,</span>
                <span class="n">interpolation_method</span> <span class="o">=</span> <span class="n">interpolation_method</span><span class="p">,</span>
                <span class="n">boundary_condition</span>   <span class="o">=</span> <span class="n">boundary_condition</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">new_cpu_environment</span><span class="o">.</span><span class="n">to_gpu</span><span class="p">()</span>

        <span class="n">modified_environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
            <span class="n">data_file</span>              <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">),</span>
            <span class="n">data_source_position</span>   <span class="o">=</span> <span class="p">(</span><span class="n">data_source_position</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_source_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_data_source_position</span><span class="p">),</span>
            <span class="n">source_radius</span>          <span class="o">=</span> <span class="p">(</span><span class="n">source_radius</span> <span class="k">if</span> <span class="p">(</span><span class="n">source_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span><span class="p">),</span>
            <span class="n">layers</span>                 <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">shape</span>                  <span class="o">=</span> <span class="p">(</span><span class="n">shape</span> <span class="k">if</span> <span class="p">(</span><span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="n">margins</span>                <span class="o">=</span> <span class="p">(</span><span class="n">margins</span> <span class="k">if</span> <span class="p">(</span><span class="n">margins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">),</span>
            <span class="n">multiplier</span>             <span class="o">=</span> <span class="p">(</span><span class="n">multiplier</span> <span class="k">if</span> <span class="p">(</span><span class="n">multiplier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
            <span class="n">interpolation_method</span>   <span class="o">=</span> <span class="p">(</span><span class="n">interpolation_method</span> <span class="k">if</span> <span class="p">(</span><span class="n">interpolation_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="p">),</span>
            <span class="n">preprocess_data</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">,</span>
            <span class="n">boundary_condition</span>     <span class="o">=</span> <span class="p">(</span><span class="n">boundary_condition</span> <span class="k">if</span> <span class="p">(</span><span class="n">boundary_condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="p">),</span>
            <span class="n">start_zone</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_type</span><span class="p">,</span>
            <span class="n">odor_present_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span><span class="p">,</span>
            <span class="n">name</span>                   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">seed</span>                   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">modified_environment</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">modify_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">scale_factor</span><span class="p">:</span> <span class="nb">float</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to modify the size of the environment by a scale factor.</span>
<span class="sd">        Everything will be scaled this factor. This includes: shape, margins, source radius, and data shape.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scale_factor : float</span>
<span class="sd">            By how much to modify the size of the current environment.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        modified_environment : Environment</span>
<span class="sd">            The environment with the scale factor applied.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">modified_source_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span> <span class="o">*</span> <span class="n">scale_factor</span>
        <span class="n">modified_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">modified_margins</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">modified_environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
            <span class="n">data_file</span>              <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">),</span>
            <span class="n">data_source_position</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_data_source_position</span><span class="p">,</span>
            <span class="n">source_radius</span>          <span class="o">=</span> <span class="n">modified_source_radius</span><span class="p">,</span>
            <span class="n">layers</span>                 <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">shape</span>                  <span class="o">=</span> <span class="n">modified_shape</span><span class="p">,</span>
            <span class="n">margins</span>                <span class="o">=</span> <span class="n">modified_margins</span><span class="p">,</span>
            <span class="n">multiplier</span>             <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],</span>
            <span class="n">interpolation_method</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="p">,</span>
            <span class="n">preprocess_data</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">,</span>
            <span class="n">boundary_condition</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="p">,</span>
            <span class="n">start_zone</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_type</span><span class="p">,</span>
            <span class="n">odor_present_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span><span class="p">,</span>
            <span class="n">name</span>                   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">seed</span>                   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">modified_environment</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.Environment.cpu_version" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cpu_version</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>A version of the Environment on the CPU.
If the environment is already on the CPU it returns itself, otherwise the to_cpu function is called to generate a new one.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.Environment.data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">data</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>The whole dataset with the right shape. If not preprocessed to modify its shape the data will be processed when querrying this object.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.Environment.gpu_version" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">gpu_version</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>A version of the Environment on the GPU.
If the environment is already on the GPU it returns itself, otherwise the to_gpu function is called to generate a new one.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.distance_to_source" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">distance_to_source</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;manhattan&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to compute the distance(s) between given points and the source point.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>point</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A single or an Nx2 array containing N points.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metric</code>
            </td>
            <td>
                  <code><span title="manhattan">manhattan</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The metric to use to compute the distance.</p>
              </div>
            </td>
            <td>
                  <code>&#39;manhattan&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dist</code></td>            <td>
                  <code><span title="float">float</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A single distance or a list of distance in a 1D distance array.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">distance_to_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">point</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                       <span class="n">metric</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;manhattan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;manhattan&#39;</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to compute the distance(s) between given points and the source point.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    point : np.ndarray</span>
<span class="sd">        A single or an Nx2 array containing N points.</span>
<span class="sd">    metric : &#39;manhattan&#39;</span>
<span class="sd">        The metric to use to compute the distance.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dist : float or np.ndarray</span>
<span class="sd">        A single distance or a list of distance in a 1D distance array.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>

    <span class="c1"># Handling the case we have a single point</span>
    <span class="n">is_single_point</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_single_point</span><span class="p">:</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

    <span class="c1"># Computing dist</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;manhattan&#39;</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">point</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span>

    <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Meaning it was not computed</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This distance metric has not yet been implemented&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_single_point</span> <span class="k">else</span> <span class="n">dist</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.get_observation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_observation</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to get an observation at a given position on the grid at a given time.
A set of observations can also be requested, either at a single position for multiple timestamps or with the same amoung of positions as timestamps provided.</p>
<p>Note: The position will not be checked against boundary conditions; if a position is out-of-bounds it will simply return 0.0!</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pos</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The position or list of positions to get observations at.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time</code>
            </td>
            <td>
                  <code><span title="int">int</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A timestamp or list of timestamps to get the observations at.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer</code>
            </td>
            <td>
                  <code><span title="int">int</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A layer or list of timestamps to get the observations at.
Note: If the environment doesnt have layers, this parameter will be ignored.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>observation</code></td>            <td>
                  <code><span title="float">float</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A single observation or list of observations.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                    <span class="n">time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to get an observation at a given position on the grid at a given time.</span>
<span class="sd">    A set of observations can also be requested, either at a single position for multiple timestamps or with the same amoung of positions as timestamps provided.</span>

<span class="sd">    Note: The position will not be checked against boundary conditions; if a position is out-of-bounds it will simply return 0.0!</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos : np.ndarray</span>
<span class="sd">        The position or list of positions to get observations at.</span>
<span class="sd">    time : int or np.ndarray, default=0</span>
<span class="sd">        A timestamp or list of timestamps to get the observations at.</span>
<span class="sd">    layer : int or np.ndarray, default=0</span>
<span class="sd">        A layer or list of timestamps to get the observations at.</span>
<span class="sd">        Note: If the environment doesnt have layers, this parameter will be ignored.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    observation : float or np.ndarray</span>
<span class="sd">        A single observation or list of observations.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>

    <span class="c1"># Handling the case of a single point</span>
    <span class="n">is_single_point</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_single_point</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

    <span class="c1"># Counting how many position points we are dealing with</span>
    <span class="n">pos_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

    <span class="c1"># Time looping</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span>

    <span class="c1"># Determine unique layers and reindexing them if needed</span>
    <span class="n">unique_layers</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">layer</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">layer</span> <span class="o">==</span> <span class="n">unique_layers</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">layer_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_layers</span><span class="p">)</span>

    <span class="c1"># Determine unique times and reindexing them if needed</span>
    <span class="n">unique_times</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">time</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">unique_time_indices</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">time</span> <span class="o">==</span> <span class="n">unique_times</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">time_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_times</span><span class="p">)</span>

    <span class="c1"># Handling the case where the data is a sequence of slices (h5, so not numpy array)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="c1"># Selecting the required slices</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_is_numpy</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">unique_layers</span><span class="p">][:,</span><span class="n">unique_times</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="n">unique_times</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Case where we are dealing with a h5 file</span>
        <span class="c1"># Note: Can&#39;t use self.data_shape because we don&#39;t know whether the data is processed yet or no</span>
        <span class="n">selected_slices</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">layer_count</span><span class="p">,</span> <span class="n">time_count</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">time_count</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_times</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_layers</span><span class="p">):</span>
                    <span class="n">selected_slices</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)][</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_slices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">selected_slices</span><span class="p">)</span>

    <span class="c1"># Handle the case it needs to be processed on the fly</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span><span class="p">:</span>
        <span class="n">reshaped_data</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">layer_count</span><span class="p">,</span> <span class="n">time_count</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">time_count</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">time_count</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_count</span><span class="p">):</span>
                    <span class="n">reshaped_data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">],</span>
                                                       <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                                       <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reshaped_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                 <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                                 <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reshaped_data</span><span class="p">)</span>

    <span class="c1"># Return 0.0 if outside of data zone</span>
    <span class="n">data_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">,:]</span>
    <span class="n">data_pos_valid</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">data_pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_pos</span> <span class="o">&lt;</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">observation</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pos_count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Gathering data on layered data on not</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span><span class="p">:</span>
        <span class="n">observation</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">layer</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">layer</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">]),</span> <span class="c1"># layer</span>
                                           <span class="p">(</span><span class="n">unique_time_indices</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unique_time_indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">unique_time_indices</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">]),</span> <span class="c1"># t</span>
                                           <span class="o">*</span><span class="n">data_pos</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="c1"># physical position</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">observation</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">unique_time_indices</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unique_time_indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">unique_time_indices</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">]),</span> <span class="c1"># t</span>
                                           <span class="o">*</span><span class="n">data_pos</span><span class="p">[</span><span class="n">data_pos_valid</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="c1"># physical position</span>

    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">observation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_single_point</span> <span class="k">else</span> <span class="n">observation</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.load" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Function to load an environment from a given folder.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The folder of the Environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>loaded_env</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.environment.Environment)" href="environment/#olfactory_navigation.environment.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded environment.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
         <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to load an environment from a given folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str</span>
<span class="sd">        The folder of the Environment.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    loaded_env : Environment</span>
<span class="sd">        The loaded environment.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;Folder doesn&#39;t exist...&quot;</span>
    <span class="k">assert</span> <span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Env-&#39;</span><span class="p">),</span> <span class="s2">&quot;The folder provided is not the data of en Environment object.&quot;</span>

    <span class="c1"># Load arguments</span>
    <span class="n">arguments</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/METADATA.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

    <span class="c1"># Check if numpy arrays are provided, if not, recreate a new environment model</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/data.npy&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/start_probabilities.npy&#39;</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/data.npy&#39;</span><span class="p">)</span>
        <span class="n">start_probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/start_probabilities.npy&#39;</span><span class="p">)</span>

        <span class="n">loaded_env</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="c1"># Set the arguments</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">name</span>                          <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">timesteps</span>                     <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;timesteps&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">data_shape</span>                    <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_shape&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">dimensions</span>                    <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">margins</span>                       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;margins&#39;</span><span class="p">])</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">shape</span>                         <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">data_bounds</span>                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_bounds&#39;</span><span class="p">])</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">original_data_source_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;original_data_source_position&#39;</span><span class="p">])</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">data_source_position</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_source_position&#39;</span><span class="p">])</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">source_position</span>               <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;source_position&#39;</span><span class="p">])</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">source_radius</span>                 <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;source_radius&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">has_layers</span>                    <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">layers</span>                        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">loaded_env</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">layer_labels</span>                  <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">interpolation_method</span>          <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;interpolation_method&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">_preprocess_data</span>              <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;preprocess_data&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">data_processed</span>                <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_processed&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">boundary_condition</span>            <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;boundary_condition&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">on_gpu</span>                        <span class="o">=</span> <span class="kc">False</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">seed</span>                          <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">rnd_state</span>                     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">])</span>

        <span class="c1"># Optional arguments</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">data_file_path</span>                <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_file_path&#39;</span><span class="p">)</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">odor_present_threshold</span>        <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;odor_present_threshold&#39;</span><span class="p">)</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">start_type</span>                    <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_type&#39;</span><span class="p">)</span>

        <span class="c1"># Arrays</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">loaded_env</span><span class="o">.</span><span class="n">start_probabilities</span> <span class="o">=</span> <span class="n">start_probabilities</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_zone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;start_type&#39;</span><span class="p">]</span>
        <span class="n">start_zone_boundaries</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">start_zone</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">):</span>
            <span class="n">start_zone_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_zone</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">loaded_env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
            <span class="n">data_file</span>              <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_file_path&#39;</span><span class="p">],</span>
            <span class="n">data_source_position</span>   <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;original_data_source_position&#39;</span><span class="p">],</span>
            <span class="n">source_radius</span>          <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;source_radius&#39;</span><span class="p">],</span>
            <span class="n">layers</span>                 <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">],</span>
            <span class="n">shape</span>                  <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">],</span>
            <span class="n">margins</span>                <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;margins&#39;</span><span class="p">],</span>
            <span class="n">interpolation_method</span>   <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;interpolation_method&#39;</span><span class="p">],</span>
            <span class="n">preprocess_data</span>        <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;preprocess_data&#39;</span><span class="p">],</span>
            <span class="n">boundary_condition</span>     <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;boundary_condition&#39;</span><span class="p">],</span>
            <span class="n">start_zone</span>             <span class="o">=</span> <span class="p">(</span><span class="n">start_zone_boundaries</span> <span class="k">if</span> <span class="n">start_zone_boundaries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">start_zone</span><span class="p">),</span>
            <span class="n">odor_present_threshold</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;odor_present_threshold&#39;</span><span class="p">),</span>
            <span class="n">name</span>                   <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">seed</span>                   <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Folder where the environment was pulled from</span>
    <span class="n">loaded_env</span><span class="o">.</span><span class="n">saved_at</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loaded_env</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.modify" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">modify</span><span class="p">(</span><span class="n">data_source_position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source_radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multiplier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interpolation_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">boundary_condition</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns a copy of the environment with one or more parameters modified.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_source_position</code>
            </td>
            <td>
                  <code><span title="list">list</span> | <span title="numpy.ndarray">ndarray</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new position for the source relative to the data file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_radius</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new source radius.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shape</code>
            </td>
            <td>
                  <code><span title="list">list</span> | <span title="numpy.ndarray">ndarray</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new shape of environment.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>margins</code>
            </td>
            <td>
                  <code><span title="int">int</span> | <span title="list">list</span> | <span title="numpy.ndarray">ndarray</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new set of margins.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>multiplier</code>
            </td>
            <td>
                  <code><span title="list">list</span> | <span title="numpy.ndarray">ndarray</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new multiplier to be applied to the data file (this will in turn increase or reduce the margins).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interpolation_method</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new interpolation method to be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>boundary_condition</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New boundary conditions for how the agent should behave at the edges.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="modified_environment">modified_environment</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A copy of the environment where the modified parameters have been applied.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">modify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
           <span class="n">data_source_position</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
           <span class="n">source_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
           <span class="n">shape</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
           <span class="n">margins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
           <span class="n">multiplier</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
           <span class="n">interpolation_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
           <span class="n">boundary_condition</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
           <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns a copy of the environment with one or more parameters modified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_source_position: list or np.ndarray, optional</span>
<span class="sd">        A new position for the source relative to the data file.</span>
<span class="sd">    source_radius: float, optional</span>
<span class="sd">        A new source radius.</span>
<span class="sd">    shape: list or np.ndarray, optional</span>
<span class="sd">        A new shape of environment.</span>
<span class="sd">    margins: int or list or np.ndarray, optional</span>
<span class="sd">        A new set of margins.</span>
<span class="sd">    multiplier: list or np.ndarray, optional</span>
<span class="sd">        A new multiplier to be applied to the data file (this will in turn increase or reduce the margins).</span>
<span class="sd">    interpolation_method: str, optional</span>
<span class="sd">        A new interpolation method to be used.</span>
<span class="sd">    boundary_condition: str, optional</span>
<span class="sd">        New boundary conditions for how the agent should behave at the edges.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    modified_environment</span>
<span class="sd">        A copy of the environment where the modified parameters have been applied.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
        <span class="n">cpu_environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_version</span>
        <span class="n">new_cpu_environment</span> <span class="o">=</span> <span class="n">cpu_environment</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span>
            <span class="n">data_source_position</span> <span class="o">=</span> <span class="n">data_source_position</span><span class="p">,</span>
            <span class="n">source_radius</span>        <span class="o">=</span> <span class="n">source_radius</span><span class="p">,</span>
            <span class="n">shape</span>                <span class="o">=</span> <span class="n">shape</span><span class="p">,</span>
            <span class="n">margins</span>              <span class="o">=</span> <span class="n">margins</span><span class="p">,</span>
            <span class="n">multiplier</span>           <span class="o">=</span> <span class="n">multiplier</span><span class="p">,</span>
            <span class="n">interpolation_method</span> <span class="o">=</span> <span class="n">interpolation_method</span><span class="p">,</span>
            <span class="n">boundary_condition</span>   <span class="o">=</span> <span class="n">boundary_condition</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">new_cpu_environment</span><span class="o">.</span><span class="n">to_gpu</span><span class="p">()</span>

    <span class="n">modified_environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
        <span class="n">data_file</span>              <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">),</span>
        <span class="n">data_source_position</span>   <span class="o">=</span> <span class="p">(</span><span class="n">data_source_position</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_source_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_data_source_position</span><span class="p">),</span>
        <span class="n">source_radius</span>          <span class="o">=</span> <span class="p">(</span><span class="n">source_radius</span> <span class="k">if</span> <span class="p">(</span><span class="n">source_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span><span class="p">),</span>
        <span class="n">layers</span>                 <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">shape</span>                  <span class="o">=</span> <span class="p">(</span><span class="n">shape</span> <span class="k">if</span> <span class="p">(</span><span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
        <span class="n">margins</span>                <span class="o">=</span> <span class="p">(</span><span class="n">margins</span> <span class="k">if</span> <span class="p">(</span><span class="n">margins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">),</span>
        <span class="n">multiplier</span>             <span class="o">=</span> <span class="p">(</span><span class="n">multiplier</span> <span class="k">if</span> <span class="p">(</span><span class="n">multiplier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
        <span class="n">interpolation_method</span>   <span class="o">=</span> <span class="p">(</span><span class="n">interpolation_method</span> <span class="k">if</span> <span class="p">(</span><span class="n">interpolation_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="p">),</span>
        <span class="n">preprocess_data</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">,</span>
        <span class="n">boundary_condition</span>     <span class="o">=</span> <span class="p">(</span><span class="n">boundary_condition</span> <span class="k">if</span> <span class="p">(</span><span class="n">boundary_condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="p">),</span>
        <span class="n">start_zone</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_type</span><span class="p">,</span>
        <span class="n">odor_present_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span><span class="p">,</span>
        <span class="n">name</span>                   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">seed</span>                   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">modified_environment</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.modify_scale" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">modify_scale</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to modify the size of the environment by a scale factor.
Everything will be scaled this factor. This includes: shape, margins, source radius, and data shape.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>scale_factor</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>By how much to modify the size of the current environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>modified_environment</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.environment.Environment)" href="environment/#olfactory_navigation.environment.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The environment with the scale factor applied.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">modify_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">scale_factor</span><span class="p">:</span> <span class="nb">float</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to modify the size of the environment by a scale factor.</span>
<span class="sd">    Everything will be scaled this factor. This includes: shape, margins, source radius, and data shape.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scale_factor : float</span>
<span class="sd">        By how much to modify the size of the current environment.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    modified_environment : Environment</span>
<span class="sd">        The environment with the scale factor applied.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">modified_source_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span> <span class="o">*</span> <span class="n">scale_factor</span>
    <span class="n">modified_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">modified_margins</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">modified_environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
        <span class="n">data_file</span>              <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">),</span>
        <span class="n">data_source_position</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_data_source_position</span><span class="p">,</span>
        <span class="n">source_radius</span>          <span class="o">=</span> <span class="n">modified_source_radius</span><span class="p">,</span>
        <span class="n">layers</span>                 <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">shape</span>                  <span class="o">=</span> <span class="n">modified_shape</span><span class="p">,</span>
        <span class="n">margins</span>                <span class="o">=</span> <span class="n">modified_margins</span><span class="p">,</span>
        <span class="n">multiplier</span>             <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],</span>
        <span class="n">interpolation_method</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="p">,</span>
        <span class="n">preprocess_data</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span><span class="p">,</span>
        <span class="n">boundary_condition</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span><span class="p">,</span>
        <span class="n">start_zone</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_type</span><span class="p">,</span>
        <span class="n">odor_present_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span><span class="p">,</span>
        <span class="n">name</span>                   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">seed</span>                   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">modified_environment</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.move" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">move</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">movement</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Applies a movement vector to a position point and returns a new position point while respecting the boundary conditions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pos</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The start position of the movement.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>movement</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 2D movement vector.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>new_pos</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The new position after applying the movement.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
         <span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
         <span class="n">movement</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Applies a movement vector to a position point and returns a new position point while respecting the boundary conditions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos : np.ndarray</span>
<span class="sd">        The start position of the movement.</span>
<span class="sd">    movement : np.ndarray</span>
<span class="sd">        A 2D movement vector.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_pos : np.ndarray</span>
<span class="sd">        The new position after applying the movement.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>

    <span class="c1"># Applying the movement vector</span>
    <span class="n">new_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">movement</span>

    <span class="c1"># Handling the case we are dealing with a single point.</span>
    <span class="n">is_single_point</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_single_point</span><span class="p">:</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">new_pos</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

    <span class="n">shape_array</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:]</span>

    <span class="c1"># Wrap boundary</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;wrap&#39;</span><span class="p">:</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">new_pos</span> <span class="o">+</span> <span class="n">shape_array</span><span class="p">),</span> <span class="n">new_pos</span><span class="p">)</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">&gt;=</span> <span class="n">shape_array</span><span class="p">,</span> <span class="p">(</span><span class="n">new_pos</span> <span class="o">-</span> <span class="n">shape_array</span><span class="p">),</span> <span class="n">new_pos</span><span class="p">)</span>

    <span class="c1"># Stop boundary</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">new_pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">shape_array</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Special wrap - vertical only</span>
    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;wrap_vertical&#39;</span><span class="p">):</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">new_pos</span><span class="p">[</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">height</span>
        <span class="n">new_pos</span><span class="p">[</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">height</span>

        <span class="n">new_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Special wrap - horizontal only</span>
    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;wrap_horizontal&#39;</span><span class="p">):</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">new_pos</span><span class="p">[</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">width</span>
        <span class="n">new_pos</span><span class="p">[</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">width</span>

        <span class="n">new_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">new_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">is_single_point</span> <span class="k">else</span> <span class="n">new_pos</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.plot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Simple function to plot the environment with a single frame of odor cues.
The starting zone is also market down with a blue contour.
The source of the odor is marked by a red circle.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>frame</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The frame of odor cues to print.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The layer of the odor cues to print. (Ignored if the environment is not layered.)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ax</code>
            </td>
            <td>
                  <code><span title="matplotlib.pyplot.Axes">Axes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An ax on which the environment can be plot.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
         <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
         <span class="n">layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
         <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Simple function to plot the environment with a single frame of odor cues.</span>
<span class="sd">    The starting zone is also market down with a blue contour.</span>
<span class="sd">    The source of the odor is marked by a red circle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    frame : int, default=0</span>
<span class="sd">        The frame of odor cues to print.</span>
<span class="sd">    layer : int, default=0</span>
<span class="sd">        The layer of the odor cues to print. (Ignored if the environment is not layered.)</span>
<span class="sd">    ax : plt.Axes, optional</span>
<span class="sd">        An ax on which the environment can be plot.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># If on GPU use the CPU version to plot</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="c1"># Blank return</span>

    <span class="c1"># TODO: Implement plotting for 3D</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Plotting function only available for 2D environments for now...&quot;</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

    <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[[],[]]</span>

    <span class="c1"># Gather data frame</span>
    <span class="n">data_frame</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">frame</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_frame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">data_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_frame</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span><span class="p">:</span>
        <span class="n">data_frame</span> <span class="o">=</span> <span class="n">_resize_array</span><span class="p">(</span><span class="n">data_frame</span><span class="p">,</span>
                                   <span class="n">new_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
                                   <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="c1"># Odor grid</span>
    <span class="n">odor</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_frame</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">environment_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">environment_frame</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">frame_data</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">environment_frame</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">)</span>

    <span class="n">legend_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">odor</span><span class="p">)</span>
    <span class="n">legend_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frame </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39; (layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; odor cues&#39;</span><span class="p">)</span>

    <span class="c1"># Start zone contour</span>
    <span class="n">start_zone</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

    <span class="n">legend_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_zone</span><span class="p">)</span>
    <span class="n">legend_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Start zone&#39;</span><span class="p">)</span>

    <span class="c1"># Source circle</span>
    <span class="n">goal_circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">legend_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">goal_circle</span><span class="p">)</span>
    <span class="n">legend_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Source&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">goal_circle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="c1"># Legend</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">legend_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.random_start_points" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">random_start_points</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to generate n starting positions following the starting probabilities.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many random starting positions to generate</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>random_states_2d</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The n random 2d points in a n x 2 array.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">random_start_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to generate n starting positions following the starting probabilities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int, default=1</span>
<span class="sd">        How many random starting positions to generate</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    random_states_2d : np.ndarray</span>
<span class="sd">        The n random 2d points in a n x 2 array.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;n has to be a strictly positive number (&gt;0)&quot;</span>

    <span class="n">random_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnd_state</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))),</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">random_states_2d</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">random_states</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">random_states_2d</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_arrays</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to save the environment to the memory.</p>
<p>By default it saved in a new folder at the current path in a new folder with the name 'Env-<name>' where <name> is the name set when initializing an environment.
In this folder a file "METADATA.json" is created containing all the properties of the environment.</p>
<p>The numpy arrays of the environment (grid and start_probabilities) can be saved or not. If not, when the environment is loaded it needs to be reconstructed from the original data file.
The arrays are saved to .npy files along with the METADATA file.</p>
<p>If an environment of the same name is already saved, the saving will be interupted. It can however be forced with the force parameter.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The folder to which to save the environment data. If it is not provided, it will be created in the current folder.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_arrays</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to save the numpy arrays to memory. (The arrays can be heavy)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>In case an environment of the same name is already saved, it will be overwritten.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
         <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">save_arrays</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
         <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to save the environment to the memory.</span>

<span class="sd">    By default it saved in a new folder at the current path in a new folder with the name &#39;Env-&lt;name&gt;&#39; where &lt;name&gt; is the name set when initializing an environment.</span>
<span class="sd">    In this folder a file &quot;METADATA.json&quot; is created containing all the properties of the environment.</span>

<span class="sd">    The numpy arrays of the environment (grid and start_probabilities) can be saved or not. If not, when the environment is loaded it needs to be reconstructed from the original data file.</span>
<span class="sd">    The arrays are saved to .npy files along with the METADATA file.</span>

<span class="sd">    If an environment of the same name is already saved, the saving will be interupted. It can however be forced with the force parameter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str, optional</span>
<span class="sd">        The folder to which to save the environment data. If it is not provided, it will be created in the current folder.</span>
<span class="sd">    save_arrays : bool, default=False</span>
<span class="sd">        Whether or not to save the numpy arrays to memory. (The arrays can be heavy)</span>
<span class="sd">    force : bool, default=False</span>
<span class="sd">        In case an environment of the same name is already saved, it will be overwritten.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># If on gpu, use the cpu version to save</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
            <span class="n">save_arrays</span><span class="o">=</span><span class="n">save_arrays</span><span class="p">,</span>
            <span class="n">force</span><span class="o">=</span><span class="n">force</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="c1"># Blank return</span>

    <span class="c1"># Assert either data_file is provided or save_arrays is enabled</span>
    <span class="k">assert</span> <span class="n">save_arrays</span> <span class="ow">or</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)),</span> <span class="s2">&quot;The environment was not created from a data file so &#39;save_arrays&#39; has to be set to True.&quot;</span>

    <span class="c1"># Adding env name to folder path</span>
    <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./Env-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">+=</span> <span class="s1">&#39;/Env-&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="c1"># Checking the folder exists or creates it</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1"> is not empty. If you want to overwrite the saved model, enable &quot;force&quot;.&#39;</span><span class="p">)</span>

    <span class="c1"># Generating the metadata arguments dictionary</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_file_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_file_path</span>

    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;timesteps&#39;</span><span class="p">]</span>                     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timesteps</span><span class="p">)</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_shape&#39;</span><span class="p">]</span>                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_shape</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span>                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;margins&#39;</span><span class="p">]</span>                       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>                         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_bounds&#39;</span><span class="p">]</span>                   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bounds</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;original_data_source_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_data_source_position</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_source_position&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source_position</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span>                        <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_labels</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;source_position&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;source_radius&#39;</span><span class="p">]</span>                 <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;interpolation_method&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_method</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;preprocess_data&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_data</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;data_processed&#39;</span><span class="p">]</span>                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_processed</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;boundary_condition&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;start_type&#39;</span><span class="p">]</span>                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_type</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>                          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span>

    <span class="c1"># Check how the start probabilities were built</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">save_arrays</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Start probabilities have been set from a custom array, please enable save_arrays to be able to reconstruct the environment later.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;odor_present_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_present_threshold</span>

    <span class="c1"># Output the arguments to a METADATA file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/METADATA.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Output the numpy arrays</span>
    <span class="k">if</span> <span class="n">save_arrays</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/data.npy&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The saving of data that is not a Numpy array was not implemented yet.&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/start_probabilities.npy&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_probabilities</span><span class="p">)</span>

    <span class="c1"># Success print</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">saved_at</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Environment saved to: </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.source_reached" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">source_reached</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Checks whether a given position is within the source radius.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pos</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The position to check whether in the radius of the source.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>is_at_source</code></td>            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not the position is within the radius of the source.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">source_reached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks whether a given position is within the source radius.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos : np.ndarray</span>
<span class="sd">        The position to check whether in the radius of the source.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    is_at_source : bool</span>
<span class="sd">        Whether or not the position is within the radius of the source.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span> <span class="k">else</span> <span class="n">np</span>

    <span class="c1"># Handling the case of a single point</span>
    <span class="n">is_single_point</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_single_point</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

    <span class="n">is_at_source</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_position</span><span class="p">[</span><span class="kc">None</span><span class="p">,:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_radius</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">is_at_source</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_single_point</span> <span class="k">else</span> <span class="n">is_at_source</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.to_cpu" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_cpu</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to send the numpy arrays of the environment to the cpu memory.
It returns a new instance of the Environment with the arrays as numpy arrays.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>cpu_environment</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.environment.Environment)" href="environment/#olfactory_navigation.environment.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new environment instance where the arrays are on the cpu memory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to send the numpy arrays of the environment to the cpu memory.</span>
<span class="sd">    It returns a new instance of the Environment with the arrays as numpy arrays.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cpu_environment : Environment</span>
<span class="sd">        A new environment instance where the arrays are on the cpu memory.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Check whether the agent is already on the cpu or not</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[warning] A CPU instance already existed and is being recreated.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Generating a new instance</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="n">cpu_environment</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="c1"># Copying arguments to gpu</span>
    <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;rnd_state&#39;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Self reference instances</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="n">cpu_environment</span>
    <span class="n">cpu_environment</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="n">cpu_environment</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">cpu_environment</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.Environment.to_gpu" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_gpu</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to send the numpy arrays of the environment to the gpu memory.
It returns a new instance of the Environment with the arrays as cupy arrays.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>gpu_environment</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.environment.Environment)" href="environment/#olfactory_navigation.environment.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new environment instance where the arrays are on the gpu memory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/environment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Environment&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to send the numpy arrays of the environment to the gpu memory.</span>
<span class="sd">    It returns a new instance of the Environment with the arrays as cupy arrays.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gpu_environment : Environment</span>
<span class="sd">        A new environment instance where the arrays are on the gpu memory.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Check whether the environment is already on the gpu or not</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># Warn and overwrite alternate_version in case it already exists</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[warning] A GPU instance already existed and is being recreated.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">assert</span> <span class="n">gpu_support</span><span class="p">,</span> <span class="s2">&quot;GPU support is not enabled...&quot;</span>

    <span class="c1"># Generating a new instance</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="n">gpu_environment</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="c1"># Copying arguments to gpu</span>
    <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;rnd_state&#39;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">gpu_environment</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Self reference instances</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="n">gpu_environment</span>
    <span class="n">gpu_environment</span><span class="o">.</span><span class="n">_alternate_version</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="n">gpu_environment</span><span class="o">.</span><span class="n">on_gpu</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">gpu_environment</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="olfactory_navigation.SimulationHistory" class="doc doc-heading">
            <code>SimulationHistory</code>


</h2>


    <div class="doc doc-contents ">


        <p>Class to record the steps that happened during a simulation with the following information being saved:</p>
<ul>
<li>the positions the agents pass by</li>
<li>the actions the agents take</li>
<li>the observations the agents receive ('observations')</li>
<li>the time in the simulation process</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>start_points</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The initial points of the agents in the simulation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>environment</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.agent.Environment)" href="#olfactory_navigation.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The environment on which the simulation is run (can be different from the one associated with the agent).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>agent</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Agent (olfactory_navigation.agent.Agent)" href="agent/#olfactory_navigation.agent.Agent">Agent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The agent used in the simulation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_shift</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of time shifts in the simulation data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>horizon</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The horizon of the simulation. i.e. how many steps can be taken by the agent during the simulation before he is considered lost.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reward_discount</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A discount to be applied to the rewards received by the agent. (eg: reward of 1 received at time n would be: 1 * reward_discount^n)</p>
              </div>
            </td>
            <td>
                  <code>0.99</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.start_points">start_points</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.environment">environment</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.agent.Environment)" href="#olfactory_navigation.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.agent">agent</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Agent (olfactory_navigation.agent.Agent)" href="agent/#olfactory_navigation.agent.Agent">Agent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.time_shift">time_shift</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.horizon">horizon</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.reward_discount">reward_discount</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.environment_dimensions">environment_dimensions</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The amount of dimensions of the environment.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.environment_shape">environment_shape</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The shape of the environment.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.environment_source_position">environment_source_position</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The position of the odor source in the environment.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.environment_source_radius">environment_source_radius</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The radius of the odor source in the environment.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.environment_layer_labels">environment_layer_labels</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] or None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of the layer labels if the environment has layers.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.agent_thresholds">agent_thresholds</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array of the olfaction thresholds of the agent.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.n">n</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The amount of simulations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.actions">actions</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of numpy arrays. At each step of the simulation, an array of shape n by 2 is appended to this list representing the n actions as dy,dx vectors.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.positions">positions</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of numpy arrays. At each step of the simulation, an array of shape n by 2 is appended to this list representing the n positions as y,x vectors.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.observations">observations</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of numpy arrays. At each step of the simulation, an array of shape n is appended to this list representing the n observations received by the agents.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.timestamps">timestamps</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="int">int</span>, <span title="list">list</span>[<span title="datetime.datetime">datetime</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionay of the timestamps at which the simulation steps were recorded where the key is the id of the first run with these timestamps.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.reached_source">reached_source</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A numpy array of booleans saying whether the simulations reached the source or not.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.done_at_step">done_at_step</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A numpy array containing n elements that records when a given simulation reaches the source (-1 is not reached).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="start_time

  
      property
   (olfactory_navigation.SimulationHistory.start_time)" href="#olfactory_navigation.SimulationHistory.start_time">start_time</a></code></td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time at which the first simulation was started.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="simulation_dfs

  
      property
   (olfactory_navigation.SimulationHistory.simulation_dfs)" href="#olfactory_navigation.SimulationHistory.simulation_dfs">simulation_dfs</a></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="pandas.DataFrame">DataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of the pandas DataFrame where each dataframe is a single simulation history.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="runs_analysis_df

  
      property
   (olfactory_navigation.SimulationHistory.runs_analysis_df)" href="#olfactory_navigation.SimulationHistory.runs_analysis_df">runs_analysis_df</a></code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A Pandas DataFrame analyzing the results of the simulations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="general_analysis_df

  
      property
   (olfactory_navigation.SimulationHistory.general_analysis_df)" href="#olfactory_navigation.SimulationHistory.general_analysis_df">general_analysis_df</a></code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A Pandas DataFrame analyzing the results of the simulations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="done_count

  
      property
   (olfactory_navigation.SimulationHistory.done_count)" href="#olfactory_navigation.SimulationHistory.done_count">done_count</a></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many simulations are terminated (whether they reached the source or not).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="olfactory_navigation.SimulationHistory.successful_simulation">successful_simulation</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A boolean array of which simulations reached the source.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="success_count

  
      property
   (olfactory_navigation.SimulationHistory.success_count)" href="#olfactory_navigation.SimulationHistory.success_count">success_count</a></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many simulations reached the source.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="simulations_at_horizon

  
      property
   (olfactory_navigation.SimulationHistory.simulations_at_horizon)" href="#olfactory_navigation.SimulationHistory.simulations_at_horizon">simulations_at_horizon</a></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A boolean array of which simulations reached the horizon.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="summary

  
      property
   (olfactory_navigation.SimulationHistory.summary)" href="#olfactory_navigation.SimulationHistory.summary">summary</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string summarizing the performances of all the simulations.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>olfactory_navigation/simulation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  32</span>
<span class="normal">  33</span>
<span class="normal">  34</span>
<span class="normal">  35</span>
<span class="normal">  36</span>
<span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SimulationHistory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class to record the steps that happened during a simulation with the following information being saved:</span>

<span class="sd">    - the positions the agents pass by</span>
<span class="sd">    - the actions the agents take</span>
<span class="sd">    - the observations the agents receive (&#39;observations&#39;)</span>
<span class="sd">    - the time in the simulation process</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start_points : np.ndarray</span>
<span class="sd">        The initial points of the agents in the simulation.</span>
<span class="sd">    environment : Environment</span>
<span class="sd">        The environment on which the simulation is run (can be different from the one associated with the agent).</span>
<span class="sd">    agent : Agent</span>
<span class="sd">        The agent used in the simulation.</span>
<span class="sd">    time_shift : np.ndarray</span>
<span class="sd">        An array of time shifts in the simulation data.</span>
<span class="sd">    horizon : int</span>
<span class="sd">        The horizon of the simulation. i.e. how many steps can be taken by the agent during the simulation before he is considered lost.</span>
<span class="sd">    reward_discount : float, default=0.99</span>
<span class="sd">        A discount to be applied to the rewards received by the agent. (eg: reward of 1 received at time n would be: 1 * reward_discount^n)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    start_points : np.ndarray</span>
<span class="sd">    environment : Environment</span>
<span class="sd">    agent : Agent</span>
<span class="sd">    time_shift : np.ndarray</span>
<span class="sd">    horizon : int</span>
<span class="sd">    reward_discount : float</span>
<span class="sd">    environment_dimensions : int</span>
<span class="sd">        The amount of dimensions of the environment.</span>
<span class="sd">    environment_shape : tuple[int]</span>
<span class="sd">        The shape of the environment.</span>
<span class="sd">    environment_source_position : np.ndarray</span>
<span class="sd">        The position of the odor source in the environment.</span>
<span class="sd">    environment_source_radius : float</span>
<span class="sd">        The radius of the odor source in the environment.</span>
<span class="sd">    environment_layer_labels : list[str] or None</span>
<span class="sd">        A list of the layer labels if the environment has layers.</span>
<span class="sd">    agent_thresholds : np.ndarray</span>
<span class="sd">        An array of the olfaction thresholds of the agent.</span>
<span class="sd">    n : int</span>
<span class="sd">        The amount of simulations.</span>
<span class="sd">    actions : list[np.ndarray]</span>
<span class="sd">        A list of numpy arrays. At each step of the simulation, an array of shape n by 2 is appended to this list representing the n actions as dy,dx vectors.</span>
<span class="sd">    positions : list[np.ndarray]</span>
<span class="sd">        A list of numpy arrays. At each step of the simulation, an array of shape n by 2 is appended to this list representing the n positions as y,x vectors.</span>
<span class="sd">    observations : list[np.ndarray]</span>
<span class="sd">        A list of numpy arrays. At each step of the simulation, an array of shape n is appended to this list representing the n observations received by the agents.</span>
<span class="sd">    timestamps : dict[int, list[datetime]]</span>
<span class="sd">        A dictionay of the timestamps at which the simulation steps were recorded where the key is the id of the first run with these timestamps.</span>
<span class="sd">    reached_source : np.ndarray</span>
<span class="sd">        A numpy array of booleans saying whether the simulations reached the source or not.</span>
<span class="sd">    done_at_step : np.ndarray</span>
<span class="sd">        A numpy array containing n elements that records when a given simulation reaches the source (-1 is not reached).</span>
<span class="sd">    start_time : datetime</span>
<span class="sd">        The time at which the first simulation was started.</span>
<span class="sd">    simulation_dfs : list[pd.DataFrame]</span>
<span class="sd">        A list of the pandas DataFrame where each dataframe is a single simulation history.</span>
<span class="sd">    runs_analysis_df : pd.DataFrame</span>
<span class="sd">        A Pandas DataFrame analyzing the results of the simulations.</span>
<span class="sd">    general_analysis_df : pd.DataFrame</span>
<span class="sd">        A Pandas DataFrame analyzing the results of the simulations.</span>
<span class="sd">    done_count : int</span>
<span class="sd">        How many simulations are terminated (whether they reached the source or not).</span>
<span class="sd">    successful_simulation : np.ndarray</span>
<span class="sd">        A boolean array of which simulations reached the source.</span>
<span class="sd">    success_count : int</span>
<span class="sd">        How many simulations reached the source.</span>
<span class="sd">    simulations_at_horizon : np.ndarray</span>
<span class="sd">        A boolean array of which simulations reached the horizon.</span>
<span class="sd">    summary : str</span>
<span class="sd">        A string summarizing the performances of all the simulations.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">start_points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">environment</span><span class="p">:</span> <span class="n">Environment</span><span class="p">,</span>
                 <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">,</span>
                 <span class="n">time_shift</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">reward_discount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If only on state is provided, we make it a 1x2 vector</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_points</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">start_points</span> <span class="o">=</span> <span class="n">start_points</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

        <span class="c1"># Fixed parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">cpu_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">cpu_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_shift</span> <span class="o">=</span> <span class="n">time_shift</span> <span class="k">if</span> <span class="n">gpu_support</span> <span class="ow">and</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">time_shift</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">time_shift</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span> <span class="o">=</span> <span class="n">horizon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_discount</span> <span class="o">=</span> <span class="n">reward_discount</span>

        <span class="c1"># Simulation Tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_points</span> <span class="o">=</span> <span class="n">start_points</span> <span class="k">if</span> <span class="n">gpu_support</span> <span class="ow">and</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">start_points</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">start_points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()]}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reached_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_at_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Environment and agent attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">source_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">source_radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">layer_labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">thresholds</span>

        <span class="c1"># Other parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_dfs</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">add_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">actions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">next_positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">observations</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">reached_source</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">interupt</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to add a step in the simulation history.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        actions : np.ndarray</span>
<span class="sd">            The actions that were taken by the agents.</span>
<span class="sd">        next_positions : np.ndarray</span>
<span class="sd">            The positions that were reached by the agents after having taken actions.</span>
<span class="sd">        observations : np.ndarray</span>
<span class="sd">            The observations the agents receive after having taken actions.</span>
<span class="sd">        reached_source : np.ndarray</span>
<span class="sd">            A boolean array of whether each agent has reached the source or not.</span>
<span class="sd">        interupt : np.ndarray</span>
<span class="sd">            A boolean array of whether each agent has to be terminated even if it hasnt reached the source yet.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_dfs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Time tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="c1"># Check if environment if layered and/or 3D</span>
        <span class="n">layered</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="c1"># Handle case cupy arrays are provided</span>
        <span class="k">if</span> <span class="n">gpu_support</span><span class="p">:</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="n">actions</span> <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
            <span class="n">next_positions</span> <span class="o">=</span> <span class="n">next_positions</span> <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">next_positions</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">next_positions</span><span class="p">)</span>
            <span class="n">observations</span> <span class="o">=</span> <span class="n">observations</span> <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
            <span class="n">reached_source</span> <span class="o">=</span> <span class="n">reached_source</span> <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">reached_source</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">reached_source</span><span class="p">)</span>
            <span class="n">interupt</span> <span class="o">=</span> <span class="n">interupt</span> <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">interupt</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">interupt</span><span class="p">)</span>

        <span class="c1"># Actions tracking</span>
        <span class="n">action_all_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">layered</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">)),</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">action_all_sims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">]</span> <span class="o">=</span> <span class="n">actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action_all_sims</span><span class="p">)</span>

        <span class="c1"># Next states tracking</span>
        <span class="n">next_position_all_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_position_all_sims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_position_all_sims</span><span class="p">)</span>

        <span class="c1"># Observation tracking</span>
        <span class="n">observation_all_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,),</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">observation_all_sims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">]</span> <span class="o">=</span> <span class="n">observations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observation_all_sims</span><span class="p">)</span>

        <span class="c1"># Recording at which step the simulation is done if it is done and whether it reached the source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_at_step</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">[</span><span class="n">reached_source</span> <span class="o">|</span> <span class="n">interupt</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reached_source</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">[</span><span class="n">reached_source</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Updating the list of running sims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">[</span><span class="o">~</span><span class="n">reached_source</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">interupt</span><span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">compute_distance_to_source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to compute the optimal distance to the source of each starting point according to the optimal_distance_metric attribute.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        distance : np.ndarray</span>
<span class="sd">            The optimal distances to the source point.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_points</span>

        <span class="c1"># Handling the case we have a single point</span>
        <span class="n">is_single_point</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_single_point</span><span class="p">:</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

        <span class="c1"># Computing dist</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># if self.optimal_distance_metric == &#39;manhattan&#39;: # TODO Allow for other metrics to be used</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_source_position</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">point</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_radius</span>

        <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Meaning it was not computed</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This distance metric has not yet been implemented&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_single_point</span> <span class="k">else</span> <span class="n">dist</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">runs_analysis_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A Pandas DataFrame analyzing the results of the simulations.</span>
<span class="sd">        It aggregates the simulations in single rows, recording:</span>

<span class="sd">         - &lt;axis&gt;:              The starting positions at the given axis</span>
<span class="sd">         - optimal_steps_count: The minimal amount of steps to reach the source</span>
<span class="sd">         - converged:           Whether or not the simulation reached the source</span>
<span class="sd">         - reached_horizon:     Whether the failed simulation reached to horizon</span>
<span class="sd">         - steps_taken:         The amount of steps the agent took to reach the source, (horizon if the simulation did not reach the source)</span>
<span class="sd">         - discounted_rewards:  The discounted reward received by the agent over the course of the simulation</span>
<span class="sd">         - extra_steps:         The amount of extra steps compared to the optimal trajectory</span>
<span class="sd">         - t_min_over_t:        Normalized version of the extra steps measure, where it tends to 1 the least amount of time the agent took to reach the source compared to an optimal trajectory.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Get axes labels</span>
        <span class="n">axes_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">axes_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">)]</span>

        <span class="c1"># Dataframe creation</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_points</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">axes_labels</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;optimal_steps_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_distance_to_source</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reached_source</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;reached_horizon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">reached_source</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;steps_taken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">done_at_step</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_at_step</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;discounted_rewards&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_discount</span> <span class="o">**</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;steps_taken&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;extra_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;steps_taken&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;optimal_steps_count&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;t_min_over_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;optimal_steps_count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;steps_taken&#39;</span><span class="p">]</span>

        <span class="c1"># Reindex</span>
        <span class="n">runs_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;run_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">runs_list</span>

        <span class="k">return</span> <span class="n">df</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">general_analysis_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A Pandas DataFrame analyzing the results of the simulations.</span>
<span class="sd">        Summarizing the performance of all the simulations with the following metrics:</span>

<span class="sd">         - converged:           Whether or not the simulation reached the source</span>
<span class="sd">         - reached_horizon:     Whether the failed simulation reached to horizon</span>
<span class="sd">         - steps_taken:         The amount of steps the agent took to reach the source, (horizon if the simulation did not reach the source)</span>
<span class="sd">         - discounted_rewards:  The discounted reward received by the agent over the course of the simulation</span>
<span class="sd">         - extra_steps:         The amount of extra steps compared to the optimal trajectory</span>
<span class="sd">         - t_min_over_t:        Normalized version of the extra steps measure, where it tends to 1 the least amount of time the agent took to reach the source compared to an optimal trajectory.</span>

<span class="sd">        For the measures (converged, steps_taken, discounted_rewards, extra_steps, t_min_over_t), the average and standard deviations are computed in rows at the top.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs_analysis_df</span>

        <span class="c1"># Analysis aggregations</span>
        <span class="n">columns_to_analyze</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">,</span> <span class="s1">&#39;reached_horizon&#39;</span><span class="p">,</span> <span class="s1">&#39;steps_taken&#39;</span><span class="p">,</span> <span class="s1">&#39;discounted_rewards&#39;</span><span class="p">,</span> <span class="s1">&#39;extra_steps&#39;</span><span class="p">,</span> <span class="s1">&#39;t_min_over_t&#39;</span><span class="p">]</span>
        <span class="n">row_names</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;standard_deviation&#39;</span><span class="p">,</span> <span class="s1">&#39;success_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;success_standard_deviation&#39;</span><span class="p">]]</span>
        <span class="n">general_analysis_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">df</span><span class="p">[</span><span class="n">columns_to_analyze</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">df</span><span class="p">[</span><span class="n">columns_to_analyze</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">],</span> <span class="n">columns_to_analyze</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">],</span> <span class="n">columns_to_analyze</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">general_analysis_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">row_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns_to_analyze</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">done_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns how many simulations are terminated (whether they reached the source or not).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">successful_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reached_source</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">success_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns how many simulations reached the source.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">successful_simulation</span><span class="p">))</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulations_at_horizon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a boolean array of which simulations reached the horizon.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">last_position_exists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">simulation_reached_horizon</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">last_position_exists</span> <span class="o">&amp;</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">reached_source</span> <span class="o">&amp;</span> <span class="n">simulation_reached_horizon</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A string summarizing the performances of all the simulations.</span>
<span class="sd">        The metrics used are averages of:</span>

<span class="sd">         - Step count</span>
<span class="sd">         - Extra steps</span>
<span class="sd">         - Discounted rewards</span>
<span class="sd">         - Tmin / T</span>

<span class="sd">        Along with the respective the standard deviations and equally for only for the successful simulations.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">success_sim_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_count</span>
        <span class="n">failed_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="n">success_sim_count</span>
        <span class="n">reached_horizon_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulations_at_horizon</span><span class="p">))</span>
        <span class="n">summary_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Simulations reached goal: </span><span class="si">{</span><span class="n">success_sim_count</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">failed_count</span><span class="si">}</span><span class="s1"> failures (reached horizon: </span><span class="si">{</span><span class="n">reached_horizon_count</span><span class="si">}</span><span class="s1">)) (</span><span class="si">{</span><span class="p">(</span><span class="n">success_sim_count</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% success)&#39;</span>

        <span class="k">if</span> <span class="n">success_sim_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">summary_str</span>

        <span class="c1"># Metrics</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_analysis_df</span>

        <span class="n">summary_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{</span><span class="s1">&#39;Average step count:&#39;</span><span class="si">:</span><span class="s2">&lt;35</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;steps_taken&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;standard_deviation&#39;</span><span class="p">,</span><span class="s1">&#39;steps_taken&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">summary_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(Successful only: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;success_mean&#39;</span><span class="p">,</span><span class="s1">&#39;steps_taken&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;success_standard_deviation&#39;</span><span class="p">,</span><span class="s1">&#39;steps_taken&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">summary_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{</span><span class="s1">&#39;Extra steps:&#39;</span><span class="si">:</span><span class="s2">&lt;35</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;extra_steps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;standard_deviation&#39;</span><span class="p">,</span><span class="s1">&#39;extra_steps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">summary_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(Successful only: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;success_mean&#39;</span><span class="p">,</span><span class="s1">&#39;extra_steps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;success_standard_deviation&#39;</span><span class="p">,</span><span class="s1">&#39;extra_steps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">summary_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{</span><span class="s1">&#39;Average discounted rewards (ADR):&#39;</span><span class="si">:</span><span class="s2">&lt;35</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;discounted_rewards&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;standard_deviation&#39;</span><span class="p">,</span><span class="s1">&#39;discounted_rewards&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">summary_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(Successful only: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;success_mean&#39;</span><span class="p">,</span><span class="s1">&#39;discounted_rewards&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;success_standard_deviation&#39;</span><span class="p">,</span><span class="s1">&#39;discounted_rewards&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">summary_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - </span><span class="si">{</span><span class="s1">&#39;Tmin/T:&#39;</span><span class="si">:</span><span class="s2">&lt;35</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;t_min_over_t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;standard_deviation&#39;</span><span class="p">,</span><span class="s1">&#39;t_min_over_t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">summary_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(Successful only: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;success_mean&#39;</span><span class="p">,</span><span class="s1">&#39;t_min_over_t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;success_standard_deviation&#39;</span><span class="p">,</span><span class="s1">&#39;t_min_over_t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="k">return</span> <span class="n">summary_str</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The time at which the first simulation was started.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulation_dfs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A list of the pandas DataFrame where each dataframe is a single simulation history.</span>
<span class="sd">        Each row is a different time instant of simulation process with each column being:</span>

<span class="sd">         - time (of the simulation data)</span>
<span class="sd">         - [position] (z,) y, x  OR  x0, x1, ... xn</span>
<span class="sd">         - (layer)</span>
<span class="sd">         - [movement] (dz,) dy, dx  OR  dx0, dx1, ... dxn</span>
<span class="sd">         - o (pure, not thresholded)</span>
<span class="sd">         - reached_source (boolean)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_dfs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_dfs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Converting state, actions and observation to numpy arrays</span>
            <span class="n">states_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">action_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
            <span class="n">observation_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">)</span>

            <span class="c1"># Get axes labels</span>
            <span class="n">axes_labels</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">axes_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">)]</span>

            <span class="c1"># Loop through the n simulations</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
                <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_at_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_at_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">states_array</span><span class="p">)</span>

                <span class="c1"># Creation of the dataframe</span>
                <span class="n">df</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># - Position variables</span>
                <span class="k">for</span> <span class="n">axis_i</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes_labels</span><span class="p">):</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">start_points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">axis_i</span><span class="p">],</span> <span class="n">states_array</span><span class="p">[:</span><span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis_i</span><span class="p">]])</span>

                <span class="c1"># - Action variables</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([[</span><span class="kc">None</span><span class="p">],</span> <span class="n">action_array</span><span class="p">[:</span><span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>

                <span class="k">for</span> <span class="n">axis_i</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes_labels</span><span class="p">):</span>
                    <span class="n">axis_i</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([[</span><span class="kc">None</span><span class="p">],</span> <span class="n">action_array</span><span class="p">[:</span><span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis_i</span><span class="p">]])</span>

                <span class="c1"># - Other variables</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([[</span><span class="kc">None</span><span class="p">],</span> <span class="n">observation_array</span><span class="p">[:</span><span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="p">]])</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;reached_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([[</span><span class="kc">None</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_at_step</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reached_source</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)])</span>

                <span class="c1"># Append</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_dfs</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_hist</span><span class="p">:</span> <span class="s1">&#39;SimulationHistory&#39;</span><span class="p">):</span>
        <span class="c1"># Asserting the SimulationHistory objects are compatible</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span> <span class="o">==</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span> <span class="s2">&quot;The &#39;horizon&#39; parameters must match between the two SimulationHistory objects...&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_discount</span> <span class="o">==</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">reward_discount</span><span class="p">,</span> <span class="s2">&quot;The &#39;reward_discount&#39; parameters must match between the two SimulationHistory objects...&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">==</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">,</span> <span class="s2">&quot;The &#39;environment_dimensions&#39; parameters must match between the two SimulationHistory objects...&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span> <span class="o">==</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">environment_shape</span><span class="p">,</span> <span class="s2">&quot;The &#39;environment_shape&#39; parameters must match between the two SimulationHistory objects...&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="o">==</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">environment_layer_labels</span><span class="p">,</span> <span class="s2">&quot;The &#39;environment_layer_labels&#39; parameters must match between the two SimulationHistory objects...&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_source_position</span> <span class="o">==</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">environment_source_position</span><span class="p">),</span> <span class="s2">&quot;The &#39;environment_source_position&#39; parameters must match between the two SimulationHistory objects...&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_radius</span> <span class="o">==</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">environment_source_radius</span><span class="p">,</span> <span class="s2">&quot;The &#39;environment_source_radius&#39; parameters must match between the two SimulationHistory objects...&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span> <span class="o">==</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">),</span> <span class="s2">&quot;The &#39;agent_thresholds&#39; parameters must match between the two SimulationHistory objects...&quot;</span>

        <span class="c1"># Combining arrays</span>
        <span class="n">combined_start_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">start_points</span><span class="p">,</span>
                                           <span class="n">other_hist</span><span class="o">.</span><span class="n">start_points</span><span class="p">])</span>
        <span class="n">combined_time_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">time_shift</span><span class="p">,</span>
                                          <span class="n">other_hist</span><span class="o">.</span><span class="n">time_shift</span><span class="p">])</span>
        <span class="n">combined_reached_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">reached_source</span><span class="p">,</span>
                                             <span class="n">other_hist</span><span class="o">.</span><span class="n">reached_source</span><span class="p">])</span>
        <span class="n">combined_done_at_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">done_at_step</span><span class="p">,</span>
                                           <span class="n">other_hist</span><span class="o">.</span><span class="n">done_at_step</span><span class="p">])</span>

        <span class="n">combined_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">combined_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">combined_observations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">step_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_hist</span><span class="o">.</span><span class="n">actions</span><span class="p">)])):</span>
            <span class="n">self_in_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">))</span>
            <span class="n">other_in_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_hist</span><span class="o">.</span><span class="n">actions</span><span class="p">))</span>
            <span class="n">combined_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">step_i</span><span class="p">]</span> <span class="k">if</span> <span class="n">self_in_range</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
                                               <span class="n">other_hist</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">step_i</span><span class="p">]</span> <span class="k">if</span> <span class="n">other_in_range</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">other_hist</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]))</span>
            <span class="n">combined_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">step_i</span><span class="p">]</span> <span class="k">if</span> <span class="n">self_in_range</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
                                                 <span class="n">other_hist</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">step_i</span><span class="p">]</span> <span class="k">if</span> <span class="n">other_in_range</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">other_hist</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]))</span>
            <span class="n">combined_observations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="n">step_i</span><span class="p">]</span> <span class="k">if</span> <span class="n">self_in_range</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
                                                    <span class="n">other_hist</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="n">step_i</span><span class="p">]</span> <span class="k">if</span> <span class="n">other_in_range</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">other_hist</span><span class="o">.</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]))</span>

        <span class="c1"># Combining timestamps</span>
        <span class="n">combined_timestamps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">|</span> <span class="p">{</span><span class="n">k</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># Creating the combined simulation history object</span>
        <span class="n">combined_hist</span> <span class="o">=</span> <span class="n">SimulationHistory</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">SimulationHistory</span><span class="p">)</span>

        <span class="n">combined_hist</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">n</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">cpu_version</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">other_hist</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">cpu_version</span> <span class="k">if</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cpu_version</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">other_hist</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cpu_version</span> <span class="k">if</span> <span class="n">other_hist</span><span class="o">.</span><span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">time_shift</span> <span class="o">=</span> <span class="n">combined_time_shifts</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">horizon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">reward_discount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_discount</span>

        <span class="n">combined_hist</span><span class="o">.</span><span class="n">start_points</span> <span class="o">=</span> <span class="n">combined_start_points</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">_running_sims</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">combined_hist</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">combined_positions</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="n">combined_actions</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">observations</span> <span class="o">=</span> <span class="n">combined_observations</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">reached_source</span> <span class="o">=</span> <span class="n">combined_reached_source</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">done_at_step</span> <span class="o">=</span> <span class="n">combined_done_at_step</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">combined_timestamps</span>

        <span class="c1"># Other attributes</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">environment_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">environment_source_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_position</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">environment_source_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_radius</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">agent_thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span>
        <span class="n">combined_hist</span><span class="o">.</span><span class="n">_simulation_dfs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">combined_hist</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">save_analysis</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">save_components</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to save the simulation history to a csv file in a given folder.</span>
<span class="sd">        Additionally, an analysis of the runs can be saved if the save_analysis is enabled.</span>
<span class="sd">        The environment and agent used can be saved in the saved folder by enabling the &#39;save_component&#39; parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : str, optional</span>
<span class="sd">            The name of the file the simulation histories will be saved to.</span>
<span class="sd">            If it is not provided, it will be by default &quot;Simulations-&lt;env_name&gt;-n_&lt;sim_count&gt;-&lt;sim_start_timestamp&gt;-horizon_&lt;max_sim_length&gt;.csv&quot;</span>
<span class="sd">        folder : str, optional</span>
<span class="sd">            Folder to save the simulation histories to.</span>
<span class="sd">            If the folder name is not provided the current folder will be used.</span>
<span class="sd">        save_analysis : bool, default=True</span>
<span class="sd">            Whether to save an additional csv file with an analysis of the runs of the simulation.</span>
<span class="sd">            It will contain the amount of steps taken, the amount of extra steps compared to optimality, the discounted rewards and the ratio between optimal trajectory and the steps taken.</span>
<span class="sd">            The means and standard deviations of all the runs are also computed.</span>
<span class="sd">            The file will have the same name as the simulation history file with an additional &#39;-analysis&#39; tag at the end.</span>
<span class="sd">        save_components : bool, default=False</span>
<span class="sd">            Whether or not to save the environment and agent along with the simulation histories in the given folder.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;Function not available, the agent and/or the environment is not set.&quot;</span>

        <span class="c1"># Handle file name</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;s_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">axis_shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis_shape</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span><span class="p">])</span>
            <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Simulations-</span><span class="si">{</span><span class="n">env_name</span><span class="si">}</span><span class="s1">-n_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">-horizon_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span><span class="si">}</span><span class="s1">.csv&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">+=</span> <span class="s1">&#39;.csv&#39;</span>

        <span class="c1"># Handle folder</span>
        <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="n">folder</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">folder</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>

        <span class="c1"># Save components if requested</span>
        <span class="k">if</span> <span class="n">save_components</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">saved_at</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">folder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">saved_at</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">saved_at</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">folder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">saved_at</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span>

        <span class="c1"># Create csv file</span>
        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_dfs</span><span class="p">)</span>

        <span class="c1"># timestamps information</span>
        <span class="n">simulation_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_dfs</span><span class="p">])</span>
        <span class="n">timestamps_column</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n_start</span><span class="p">,</span> <span class="n">run_timestamps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">i_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">simulation_lengths</span><span class="p">[:</span><span class="n">n_start</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ts_i</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">run_timestamps</span><span class="p">):</span>
                <span class="n">timestamps_column</span><span class="p">[</span><span class="n">i_start</span> <span class="o">+</span> <span class="n">ts_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">ts</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamps_column</span>

        <span class="c1"># Adding other useful info</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;reward_discount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_discount</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">environment_info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">saved_at</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">),</span> <span class="c1"># int</span>
            <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">axis_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis_size</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span><span class="p">),</span>
            <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">axis_position</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis_position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_position</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_source_radius</span><span class="p">),</span> <span class="c1"># float</span>
            <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span><span class="p">)</span> <span class="c1"># Using &#39;&amp;&#39; as splitter as &#39;_&#39; could be used in the labels themselves</span>
        <span class="p">]</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">environment_info</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">environment_info</span><span class="p">)])</span>

        <span class="c1"># Converting the thresholds array to a string to be saved</span>
        <span class="n">thresholds_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">thresholds_string</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span><span class="p">])</span> <span class="k">for</span> <span class="n">row_i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span> <span class="c1"># Using &#39;&amp;&#39; as layer splitter as &#39;-&#39; can be used for negative thresholds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thresholds_string</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">])</span>

        <span class="n">agent_info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">class_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">saved_at</span><span class="p">,</span>
            <span class="n">thresholds_string</span>
        <span class="p">]</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_info</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">agent_info</span><span class="p">)])</span>

        <span class="c1"># Saving csv</span>
        <span class="n">combined_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulations saved to: </span><span class="si">{</span><span class="n">folder</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_analysis</span><span class="p">:</span>
            <span class="n">runs_analysis_file_name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;-runs_analysis.csv&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runs_analysis_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">runs_analysis_file_name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation&#39;s runs analysis saved to: </span><span class="si">{</span><span class="n">folder</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">runs_analysis_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">general_analysis_file_name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;-general_analysis.csv&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_analysis_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">general_analysis_file_name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation&#39;s general analysis saved to: </span><span class="si">{</span><span class="n">folder</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">general_analysis_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                       <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">environment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Environment</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">agent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Agent</span> <span class="o">=</span> <span class="kc">False</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SimulationHistory&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
             <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">environment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Environment</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">agent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Agent</span> <span class="o">=</span> <span class="kc">False</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SimulationHistory&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to load the simulation history from a file.</span>
<span class="sd">        This can be useful to use the plot functions on the simulations saved in such file.</span>

<span class="sd">        The environment and agent can provided as a backup in the case they cannot be loaded from the file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : str</span>
<span class="sd">            A file (with the path) of the simulation histories csv. (the analysis file cannot be used for this)</span>
<span class="sd">        environment : bool or Environment, default=False</span>
<span class="sd">            If set to True, it will try to load the environment that was used for the simulation (if the save path is available).</span>
<span class="sd">            Or, an environment instance to be linked with the simulation history object.</span>
<span class="sd">        agent : bool or Agent, default=False</span>
<span class="sd">            If set to True, it will try to load the agent that was used for the simulation (if the save path is available).</span>
<span class="sd">            An agent instance to be linked with the simulation history object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hist : SimulationHistory</span>
<span class="sd">            The loaded instance of a simulation history object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Retrieving columns</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="c1"># Setting the datatypes of columns</span>
        <span class="n">column_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="nb">float</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">}</span>
        <span class="n">column_dtypes</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span>
        <span class="k">if</span> <span class="s1">&#39;layer&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">column_dtypes</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span>
        <span class="n">column_dtypes</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="n">column_dtypes</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="n">column_dtypes</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span>

        <span class="c1"># Retrieving the combined dataframe</span>
        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">column_dtypes</span><span class="p">)</span>

        <span class="c1"># Retrieving horizon and reward discount</span>
        <span class="n">horizon</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">reward_discount</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;reward_discount&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Retrieving environment</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">Environment</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">environment</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">environment_name</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">environment_path</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">environment_path_check</span> <span class="o">=</span> <span class="p">(</span><span class="n">environment_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">environment_path</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">environment_path_check</span><span class="p">,</span> <span class="s2">&quot;Environment was not saved at the time of the saving of the simulation history. Input an environment to the environment parameter or toggle the parameter to False.&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">environment_path</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to retrieve &quot;</span><span class="si">{</span><span class="n">environment_name</span><span class="si">}</span><span class="s1">&quot; environment from memory&#39;</span><span class="p">)</span>

        <span class="c1"># Retrieving agent</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">Agent</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">agent</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">agent_name</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">agent_class</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">agent_path</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">agent_path_check</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">agent_path</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">agent_path_check</span><span class="p">,</span> <span class="s2">&quot;Agent was not saved at the time of the saving of the simulation history. Input an agent to the agent parameter or toggle the parameter to False.&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">class_instance</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">class_obj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">class_name</span> <span class="o">==</span> <span class="n">agent_class</span><span class="p">:</span>
                        <span class="n">class_instance</span> <span class="o">=</span> <span class="n">class_obj</span>
                        <span class="k">break</span>
                <span class="n">agent</span> <span class="o">=</span> <span class="n">class_instance</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to retrieve &quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s1">&quot; agent from memory&#39;</span><span class="p">)</span>

        <span class="c1"># Other attributes</span>
        <span class="n">environment_dimensions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">environment_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">axis_shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis_shape</span> <span class="ow">in</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)])</span>
        <span class="n">environment_source_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">pos_axis</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos_axis</span> <span class="ow">in</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)])</span>
        <span class="n">environment_source_radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">layer_entery</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">environment_layer_labels</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer_entery</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layer_entery</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="n">layer_entery</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">))</span>

        <span class="c1"># Processing the threshold string</span>
        <span class="n">thresholds_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;&amp;&#39;</span> <span class="ow">in</span> <span class="n">thresholds_string</span><span class="p">:</span>
            <span class="n">rows_thresholds_string</span> <span class="o">=</span> <span class="n">thresholds_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span>
            <span class="n">layer_thresholds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_thresholds_string</span><span class="p">:</span>
                <span class="n">layer_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
            <span class="n">agent_thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layer_thresholds</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">agent_thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thresholds_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>

        <span class="c1"># Columns to retrieve</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;reward_discount&#39;</span><span class="p">,</span> <span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="s1">&#39;agent&#39;</span><span class="p">]]</span>

        <span class="c1"># Checking how many dimensions there are</span>
        <span class="n">has_layers</span> <span class="o">=</span> <span class="p">(((</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Recreation of list of simulations</span>
        <span class="n">sim_start_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[[</span><span class="s1">&#39;reached_source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">simulation_arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">sim_start_rows</span><span class="p">)</span>
        <span class="n">simulation_dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sim_array</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">sim_array</span> <span class="ow">in</span> <span class="n">simulation_arrays</span><span class="p">]</span>

        <span class="c1"># Making a combined numpy array with all the simulations</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">sim_array</span><span class="p">)</span> <span class="k">for</span> <span class="n">sim_array</span> <span class="ow">in</span> <span class="n">simulation_arrays</span><span class="p">])</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">paddings</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="n">sizes</span>

        <span class="n">padded_simulation_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">sim_arr</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">pad</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="n">constant_values</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">sim_arr</span><span class="p">,</span> <span class="n">pad</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">simulation_arrays</span><span class="p">,</span> <span class="n">paddings</span><span class="p">)]</span>
        <span class="n">all_simulation_arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">padded_simulation_arrays</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Timeshift</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="n">all_simulation_arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Gathering start states</span>
        <span class="n">start_points</span> <span class="o">=</span> <span class="n">all_simulation_arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">1</span><span class="p">:(</span><span class="mi">1</span><span class="o">+</span><span class="n">dimensions</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Recreating action, state and observations</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">all_simulation_arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:(</span><span class="mi">1</span><span class="o">+</span><span class="n">dimensions</span><span class="p">)]</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">all_simulation_arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dimensions</span><span class="p">):((</span><span class="mi">1</span><span class="o">+</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">has_layers</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">dimensions</span><span class="p">)]</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="n">all_simulation_arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">has_layers</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">dimensions</span><span class="p">)]</span>
        <span class="n">reached_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;reached_source&#39;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">simulation_dfs</span><span class="p">])</span>
        <span class="n">done_at_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sizes</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">horizon</span><span class="p">),</span> <span class="n">sizes</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Building SimulationHistory instance</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="n">hist</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_points</span><span class="p">)</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">cpu_version</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">Environment</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">cpu_version</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">Agent</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">time_shift</span> <span class="o">=</span> <span class="n">time_shift</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">horizon</span> <span class="o">=</span> <span class="n">horizon</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">reward_discount</span> <span class="o">=</span> <span class="n">reward_discount</span>

        <span class="n">hist</span><span class="o">.</span><span class="n">start_points</span> <span class="o">=</span> <span class="n">start_points</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">_running_sims</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">hist</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">positions</span><span class="p">]</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">actions</span><span class="p">]</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">observations</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">observations</span><span class="p">]</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">reached_source</span> <span class="o">=</span> <span class="n">reached_source</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">done_at_step</span> <span class="o">=</span> <span class="n">done_at_step</span>

        <span class="c1"># Reading timestamps</span>
        <span class="n">timestamp_column</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span>
        <span class="n">timestamp_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">timestamp_column</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamp_column</span><span class="p">)]])</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Reading each group of timestamps (representing of each run)</span>
        <span class="k">for</span> <span class="n">group_i</span><span class="p">,</span> <span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">group_end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">timestamp_groups</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">timestamp_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
            <span class="n">timestamp_group</span> <span class="o">=</span> <span class="n">timestamp_column</span><span class="p">[</span><span class="n">group_start</span><span class="p">:</span><span class="n">group_end</span><span class="p">]</span>

            <span class="c1"># Initial read of the group</span>
            <span class="n">first_timestamp</span> <span class="o">=</span> <span class="n">timestamp_group</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">timestamp_day</span> <span class="o">=</span> <span class="n">first_timestamp</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
            <span class="n">timestamp_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">timestamp_group</span><span class="o">.</span><span class="n">notna</span><span class="p">())</span>
            <span class="n">timestamp_string_list</span> <span class="o">=</span> <span class="n">timestamp_group</span><span class="p">[:</span><span class="n">timestamp_count</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

            <span class="n">day_delta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">timestamp_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp_string_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)]</span>

            <span class="c1"># Reading each timestamp of the list</span>
            <span class="k">for</span> <span class="n">timestamp_string</span> <span class="ow">in</span> <span class="n">timestamp_string_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">timestamp_string</span> <span class="o">=</span> <span class="n">timestamp_day</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_string</span><span class="p">)</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp_string</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">day_delta</span>

                <span class="c1"># If timestamp is smaller than the previous one, it means it is a new day and the day_delta has to be increased</span>
                <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">timestamp_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">day_delta</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">timestamp</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">timestamp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>

            <span class="c1"># Adding the timestamps to the general dictionary</span>
            <span class="n">associate_run_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sim_start_rows</span><span class="p">])</span> <span class="o">==</span> <span class="n">group_start</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">timestamps</span><span class="p">[</span><span class="n">associate_run_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_list</span>

        <span class="c1"># Warn if no timestamps were found</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[Warning] No timestamps were found in the loaded simulation history...&#39;</span><span class="p">)</span>

        <span class="n">hist</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">timestamps</span>

        <span class="c1"># Other attributes</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">=</span> <span class="n">environment_dimensions</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">environment_shape</span> <span class="o">=</span> <span class="n">environment_shape</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">environment_source_position</span> <span class="o">=</span> <span class="n">environment_source_position</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">environment_source_radius</span> <span class="o">=</span> <span class="n">environment_source_radius</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="o">=</span> <span class="n">environment_layer_labels</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">agent_thresholds</span> <span class="o">=</span> <span class="n">agent_thresholds</span>

        <span class="c1"># Saving simulation dfs back</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">_simulation_dfs</span> <span class="o">=</span> <span class="n">simulation_dfs</span>

        <span class="k">return</span> <span class="n">hist</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">sim_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
             <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to plot a the trajectory of a given simulation.</span>
<span class="sd">        An ax can be use to plot it on.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sim_id : int, default=0</span>
<span class="sd">            The id of the simulation to plot.</span>
<span class="sd">        ax : plt.Axes, optional</span>
<span class="sd">            The ax on which to plot the path. (If not provided, a new axis will be created)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># TODO: Setup 3D plotting</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Plotting function only available for 2D environments for now...&quot;</span>

        <span class="c1"># Generate ax is not provided</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="c1"># Retrieving sim</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_dfs</span><span class="p">[</span><span class="n">sim_id</span><span class="p">]</span>

        <span class="c1"># Plot setup</span>
        <span class="n">env_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">env_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">env_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Start</span>
        <span class="n">start_coord</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">start_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">start_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Start&#39;</span><span class="p">)</span>

        <span class="c1"># Source circle</span>
        <span class="n">goal_circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_source_position</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_radius</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Source&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">goal_circle</span><span class="p">)</span>

        <span class="c1"># Until step</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Path</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">seq</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">seq</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Path&#39;</span><span class="p">)</span>

        <span class="c1"># Layer observations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obs_layer</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[[</span><span class="s1">&#39;layer&#39;</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">layer_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">TABLEAU_COLORS</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

            <span class="k">for</span> <span class="n">layer_i</span><span class="p">,</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">layer_i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">layer_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_layer</span> <span class="o">==</span> <span class="n">layer_i</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Reshaping to a single vector and not an n by 1 array</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">layer_mask</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">layer_mask</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># X, Y</span>
                           <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">layer_colors</span><span class="p">[(</span><span class="n">layer_i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer_colors</span><span class="p">)],</span> <span class="c1"># Looping over the colors in case there are more layers than colors</span>
                           <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="n">layer_label</span><span class="p">)</span>

        <span class="c1"># Process odor cues</span>
        <span class="n">odor_cues</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">observation_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">layer_ids</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[[</span><span class="s1">&#39;layer&#39;</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">action_layer_thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">[</span><span class="n">layer_ids</span><span class="p">]</span>
            <span class="n">observation_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">odor_cues</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">action_layer_thresholds</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">odor_cues</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">action_layer_thresholds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]))[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Setting observation ids</span>
            <span class="n">observation_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">odor_cues</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="kc">None</span><span class="p">,:])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">odor_cues</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="kc">None</span><span class="p">,:]))[:,</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Check whether the odor detection is binary or by level</span>
        <span class="n">odor_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">odor_bins</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">odor_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">odor_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">odor_levels</span><span class="p">:</span>
                <span class="n">cues_at_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">observation_ids</span> <span class="o">==</span> <span class="n">level</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">cues_at_level</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">cues_at_level</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">alpha</span><span class="o">=</span><span class="p">(</span><span class="n">level</span> <span class="o">/</span> <span class="n">odor_bins</span><span class="p">),</span>
                           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Sensed level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">something_sensed</span> <span class="o">=</span> <span class="p">(</span><span class="n">observation_ids</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">something_sensed</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">something_sensed</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Something observed&#39;</span><span class="p">)</span>

        <span class="c1"># Generate legend</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">plot_runtimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                      <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to plot the runtimes over the iterations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : plt.Axes, optional</span>
<span class="sd">            The ax on which to plot the path. (If not provided, a new axis will be created)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Generate ax is not provided</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="c1"># Computing differences and plotting</span>
        <span class="n">x_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">consecutive_timestamps</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">time_differences_ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t_diff</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="k">for</span> <span class="n">t_diff</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">consecutive_timestamps</span><span class="p">)])</span> <span class="o">/</span> <span class="mi">1000</span>
            <span class="n">time_differences_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_differences_ms</span><span class="p">)</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_differences_count</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">time_differences_ms</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Simulation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">x_start</span> <span class="o">+=</span> <span class="n">time_differences_count</span>

        <span class="c1"># Axes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Runtime (ms)&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">plot_successes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to plot a 2D map of whether a given starting point was successfull or not (and whether it died early).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : plt.Axes, optional</span>
<span class="sd">            The ax on which to plot the path. (If not provided, a new axis will be created)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Only implemented for 2D environments...&quot;</span>

        <span class="c1"># Generate ax is not provided</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="c1"># Setting up an empty grid of the starting points</span>
        <span class="n">start_points_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span><span class="p">)</span>

        <span class="c1"># Compute the successful, failed and the ones that reached the horizon</span>
        <span class="n">success_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_points</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">successful_simulation</span><span class="p">]</span>
        <span class="n">failed_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_points</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">successful_simulation</span><span class="p">]</span>
        <span class="n">failed_not_at_horizon_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_points</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">successful_simulation</span> <span class="o">&amp;</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">simulations_at_horizon</span><span class="p">]</span>

        <span class="n">start_points_grid</span><span class="p">[</span><span class="n">failed_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">failed_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">start_points_grid</span><span class="p">[</span><span class="n">success_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">success_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">start_points_grid</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">)</span>

        <span class="c1"># The crosses where the points did not reach the horizon</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">failed_not_at_horizon_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">failed_not_at_horizon_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Died early&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.SimulationHistory.done_count" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">done_count</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Returns how many simulations are terminated (whether they reached the source or not).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.SimulationHistory.general_analysis_df" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">general_analysis_df</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>A Pandas DataFrame analyzing the results of the simulations.
Summarizing the performance of all the simulations with the following metrics:</p>
<ul>
<li>converged:           Whether or not the simulation reached the source</li>
<li>reached_horizon:     Whether the failed simulation reached to horizon</li>
<li>steps_taken:         The amount of steps the agent took to reach the source, (horizon if the simulation did not reach the source)</li>
<li>discounted_rewards:  The discounted reward received by the agent over the course of the simulation</li>
<li>extra_steps:         The amount of extra steps compared to the optimal trajectory</li>
<li>t_min_over_t:        Normalized version of the extra steps measure, where it tends to 1 the least amount of time the agent took to reach the source compared to an optimal trajectory.</li>
</ul>
<p>For the measures (converged, steps_taken, discounted_rewards, extra_steps, t_min_over_t), the average and standard deviations are computed in rows at the top.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.SimulationHistory.runs_analysis_df" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">runs_analysis_df</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>A Pandas DataFrame analyzing the results of the simulations.
It aggregates the simulations in single rows, recording:</p>
<ul>
<li><axis>:              The starting positions at the given axis</li>
<li>optimal_steps_count: The minimal amount of steps to reach the source</li>
<li>converged:           Whether or not the simulation reached the source</li>
<li>reached_horizon:     Whether the failed simulation reached to horizon</li>
<li>steps_taken:         The amount of steps the agent took to reach the source, (horizon if the simulation did not reach the source)</li>
<li>discounted_rewards:  The discounted reward received by the agent over the course of the simulation</li>
<li>extra_steps:         The amount of extra steps compared to the optimal trajectory</li>
<li>t_min_over_t:        Normalized version of the extra steps measure, where it tends to 1 the least amount of time the agent took to reach the source compared to an optimal trajectory.</li>
</ul>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.SimulationHistory.simulation_dfs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">simulation_dfs</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>A list of the pandas DataFrame where each dataframe is a single simulation history.
Each row is a different time instant of simulation process with each column being:</p>
<ul>
<li>time (of the simulation data)</li>
<li>[position] (z,) y, x  OR  x0, x1, ... xn</li>
<li>(layer)</li>
<li>[movement] (dz,) dy, dx  OR  dx0, dx1, ... dxn</li>
<li>o (pure, not thresholded)</li>
<li>reached_source (boolean)</li>
</ul>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.SimulationHistory.simulations_at_horizon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">simulations_at_horizon</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Returns a boolean array of which simulations reached the horizon.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.SimulationHistory.start_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start_time</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>The time at which the first simulation was started.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.SimulationHistory.success_count" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">success_count</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Returns how many simulations reached the source.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="olfactory_navigation.SimulationHistory.summary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">summary</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>A string summarizing the performances of all the simulations.
The metrics used are averages of:</p>
<ul>
<li>Step count</li>
<li>Extra steps</li>
<li>Discounted rewards</li>
<li>Tmin / T</li>
</ul>
<p>Along with the respective the standard deviations and equally for only for the successful simulations.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.SimulationHistory.add_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_step</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">next_positions</span><span class="p">,</span> <span class="n">observations</span><span class="p">,</span> <span class="n">reached_source</span><span class="p">,</span> <span class="n">interupt</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to add a step in the simulation history.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>actions</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The actions that were taken by the agents.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>next_positions</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The positions that were reached by the agents after having taken actions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>observations</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The observations the agents receive after having taken actions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reached_source</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A boolean array of whether each agent has reached the source or not.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>interupt</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A boolean array of whether each agent has to be terminated even if it hasnt reached the source yet.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">actions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">next_positions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">observations</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">reached_source</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">interupt</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to add a step in the simulation history.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    actions : np.ndarray</span>
<span class="sd">        The actions that were taken by the agents.</span>
<span class="sd">    next_positions : np.ndarray</span>
<span class="sd">        The positions that were reached by the agents after having taken actions.</span>
<span class="sd">    observations : np.ndarray</span>
<span class="sd">        The observations the agents receive after having taken actions.</span>
<span class="sd">    reached_source : np.ndarray</span>
<span class="sd">        A boolean array of whether each agent has reached the source or not.</span>
<span class="sd">    interupt : np.ndarray</span>
<span class="sd">        A boolean array of whether each agent has to be terminated even if it hasnt reached the source yet.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_dfs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Time tracking</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="c1"># Check if environment if layered and/or 3D</span>
    <span class="n">layered</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>

    <span class="c1"># Handle case cupy arrays are provided</span>
    <span class="k">if</span> <span class="n">gpu_support</span><span class="p">:</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">actions</span> <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
        <span class="n">next_positions</span> <span class="o">=</span> <span class="n">next_positions</span> <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">next_positions</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">next_positions</span><span class="p">)</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="n">observations</span> <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
        <span class="n">reached_source</span> <span class="o">=</span> <span class="n">reached_source</span> <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">reached_source</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">reached_source</span><span class="p">)</span>
        <span class="n">interupt</span> <span class="o">=</span> <span class="n">interupt</span> <span class="k">if</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_array_module</span><span class="p">(</span><span class="n">interupt</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span> <span class="k">else</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">interupt</span><span class="p">)</span>

    <span class="c1"># Actions tracking</span>
    <span class="n">action_all_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">layered</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">)),</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">action_all_sims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">]</span> <span class="o">=</span> <span class="n">actions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action_all_sims</span><span class="p">)</span>

    <span class="c1"># Next states tracking</span>
    <span class="n">next_position_all_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">next_position_all_sims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_positions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_position_all_sims</span><span class="p">)</span>

    <span class="c1"># Observation tracking</span>
    <span class="n">observation_all_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,),</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">observation_all_sims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">]</span> <span class="o">=</span> <span class="n">observations</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observation_all_sims</span><span class="p">)</span>

    <span class="c1"># Recording at which step the simulation is done if it is done and whether it reached the source</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">done_at_step</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">[</span><span class="n">reached_source</span> <span class="o">|</span> <span class="n">interupt</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reached_source</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">[</span><span class="n">reached_source</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Updating the list of running sims</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_sims</span><span class="p">[</span><span class="o">~</span><span class="n">reached_source</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">interupt</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.SimulationHistory.compute_distance_to_source" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_distance_to_source</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to compute the optimal distance to the source of each starting point according to the optimal_distance_metric attribute.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>distance</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The optimal distances to the source point.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_distance_to_source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to compute the optimal distance to the source of each starting point according to the optimal_distance_metric attribute.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    distance : np.ndarray</span>
<span class="sd">        The optimal distances to the source point.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_points</span>

    <span class="c1"># Handling the case we have a single point</span>
    <span class="n">is_single_point</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_single_point</span><span class="p">:</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>

    <span class="c1"># Computing dist</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># if self.optimal_distance_metric == &#39;manhattan&#39;: # TODO Allow for other metrics to be used</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_source_position</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">point</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_radius</span>

    <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Meaning it was not computed</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This distance metric has not yet been implemented&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_single_point</span> <span class="k">else</span> <span class="n">dist</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.SimulationHistory.load" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Function to load the simulation history from a file.
This can be useful to use the plot functions on the simulations saved in such file.</p>
<p>The environment and agent can provided as a backup in the case they cannot be loaded from the file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A file (with the path) of the simulation histories csv. (the analysis file cannot be used for this)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>environment</code>
            </td>
            <td>
                  <code><span title="bool">bool</span> or <a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.agent.Environment)" href="#olfactory_navigation.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set to True, it will try to load the environment that was used for the simulation (if the save path is available).
Or, an environment instance to be linked with the simulation history object.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>agent</code>
            </td>
            <td>
                  <code><span title="bool">bool</span> or <a class="autorefs autorefs-internal" title="Agent (olfactory_navigation.agent.Agent)" href="agent/#olfactory_navigation.agent.Agent">Agent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set to True, it will try to load the agent that was used for the simulation (if the save path is available).
An agent instance to be linked with the simulation history object.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>hist</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="SimulationHistory (olfactory_navigation.simulation.SimulationHistory)" href="simulation/#olfactory_navigation.simulation.SimulationHistory">SimulationHistory</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded instance of a simulation history object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
         <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
         <span class="n">environment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Environment</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
         <span class="n">agent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">Agent</span> <span class="o">=</span> <span class="kc">False</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SimulationHistory&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to load the simulation history from a file.</span>
<span class="sd">    This can be useful to use the plot functions on the simulations saved in such file.</span>

<span class="sd">    The environment and agent can provided as a backup in the case they cannot be loaded from the file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : str</span>
<span class="sd">        A file (with the path) of the simulation histories csv. (the analysis file cannot be used for this)</span>
<span class="sd">    environment : bool or Environment, default=False</span>
<span class="sd">        If set to True, it will try to load the environment that was used for the simulation (if the save path is available).</span>
<span class="sd">        Or, an environment instance to be linked with the simulation history object.</span>
<span class="sd">    agent : bool or Agent, default=False</span>
<span class="sd">        If set to True, it will try to load the agent that was used for the simulation (if the save path is available).</span>
<span class="sd">        An agent instance to be linked with the simulation history object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    hist : SimulationHistory</span>
<span class="sd">        The loaded instance of a simulation history object.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Retrieving columns</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="c1"># Setting the datatypes of columns</span>
    <span class="n">column_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="nb">float</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">}</span>
    <span class="n">column_dtypes</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="k">if</span> <span class="s1">&#39;layer&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">column_dtypes</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">column_dtypes</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">column_dtypes</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">column_dtypes</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span>

    <span class="c1"># Retrieving the combined dataframe</span>
    <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">column_dtypes</span><span class="p">)</span>

    <span class="c1"># Retrieving horizon and reward discount</span>
    <span class="n">horizon</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">reward_discount</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;reward_discount&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Retrieving environment</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">Environment</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">environment</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">environment_name</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">environment_path</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">environment_path_check</span> <span class="o">=</span> <span class="p">(</span><span class="n">environment_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">environment_path</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">environment_path_check</span><span class="p">,</span> <span class="s2">&quot;Environment was not saved at the time of the saving of the simulation history. Input an environment to the environment parameter or toggle the parameter to False.&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">environment_path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to retrieve &quot;</span><span class="si">{</span><span class="n">environment_name</span><span class="si">}</span><span class="s1">&quot; environment from memory&#39;</span><span class="p">)</span>

    <span class="c1"># Retrieving agent</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">Agent</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">agent</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">agent_name</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">agent_class</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">agent_path</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">agent_path_check</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">agent_path</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">agent_path_check</span><span class="p">,</span> <span class="s2">&quot;Agent was not saved at the time of the saving of the simulation history. Input an agent to the agent parameter or toggle the parameter to False.&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">class_instance</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">class_obj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">class_name</span> <span class="o">==</span> <span class="n">agent_class</span><span class="p">:</span>
                    <span class="n">class_instance</span> <span class="o">=</span> <span class="n">class_obj</span>
                    <span class="k">break</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="n">class_instance</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to retrieve &quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s1">&quot; agent from memory&#39;</span><span class="p">)</span>

    <span class="c1"># Other attributes</span>
    <span class="n">environment_dimensions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">environment_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">axis_shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis_shape</span> <span class="ow">in</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)])</span>
    <span class="n">environment_source_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">pos_axis</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos_axis</span> <span class="ow">in</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)])</span>
    <span class="n">environment_source_radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">layer_entery</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">environment_layer_labels</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer_entery</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layer_entery</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="n">layer_entery</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">))</span>

    <span class="c1"># Processing the threshold string</span>
    <span class="n">thresholds_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;&amp;&#39;</span> <span class="ow">in</span> <span class="n">thresholds_string</span><span class="p">:</span>
        <span class="n">rows_thresholds_string</span> <span class="o">=</span> <span class="n">thresholds_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span>
        <span class="n">layer_thresholds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_thresholds_string</span><span class="p">:</span>
            <span class="n">layer_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">agent_thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layer_thresholds</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">agent_thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thresholds_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>

    <span class="c1"># Columns to retrieve</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;reward_discount&#39;</span><span class="p">,</span> <span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="s1">&#39;agent&#39;</span><span class="p">]]</span>

    <span class="c1"># Checking how many dimensions there are</span>
    <span class="n">has_layers</span> <span class="o">=</span> <span class="p">(((</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dimensions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Recreation of list of simulations</span>
    <span class="n">sim_start_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[[</span><span class="s1">&#39;reached_source&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">simulation_arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">sim_start_rows</span><span class="p">)</span>
    <span class="n">simulation_dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sim_array</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">sim_array</span> <span class="ow">in</span> <span class="n">simulation_arrays</span><span class="p">]</span>

    <span class="c1"># Making a combined numpy array with all the simulations</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">sim_array</span><span class="p">)</span> <span class="k">for</span> <span class="n">sim_array</span> <span class="ow">in</span> <span class="n">simulation_arrays</span><span class="p">])</span>
    <span class="n">max_length</span> <span class="o">=</span> <span class="n">sizes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">paddings</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="n">sizes</span>

    <span class="n">padded_simulation_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">sim_arr</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">pad</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="n">constant_values</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">sim_arr</span><span class="p">,</span> <span class="n">pad</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">simulation_arrays</span><span class="p">,</span> <span class="n">paddings</span><span class="p">)]</span>
    <span class="n">all_simulation_arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">padded_simulation_arrays</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Timeshift</span>
    <span class="n">time_shift</span> <span class="o">=</span> <span class="n">all_simulation_arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Gathering start states</span>
    <span class="n">start_points</span> <span class="o">=</span> <span class="n">all_simulation_arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">1</span><span class="p">:(</span><span class="mi">1</span><span class="o">+</span><span class="n">dimensions</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Recreating action, state and observations</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">all_simulation_arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:(</span><span class="mi">1</span><span class="o">+</span><span class="n">dimensions</span><span class="p">)]</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="n">all_simulation_arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dimensions</span><span class="p">):((</span><span class="mi">1</span><span class="o">+</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">has_layers</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">dimensions</span><span class="p">)]</span>
    <span class="n">observations</span> <span class="o">=</span> <span class="n">all_simulation_arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">has_layers</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">dimensions</span><span class="p">)]</span>
    <span class="n">reached_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;reached_source&#39;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">simulation_dfs</span><span class="p">])</span>
    <span class="n">done_at_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sizes</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">horizon</span><span class="p">),</span> <span class="n">sizes</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Building SimulationHistory instance</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="n">hist</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_points</span><span class="p">)</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">cpu_version</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">Environment</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">cpu_version</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">Agent</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">time_shift</span> <span class="o">=</span> <span class="n">time_shift</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">horizon</span> <span class="o">=</span> <span class="n">horizon</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">reward_discount</span> <span class="o">=</span> <span class="n">reward_discount</span>

    <span class="n">hist</span><span class="o">.</span><span class="n">start_points</span> <span class="o">=</span> <span class="n">start_points</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">_running_sims</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">hist</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">positions</span><span class="p">]</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">actions</span><span class="p">]</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">observations</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">observations</span><span class="p">]</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">reached_source</span> <span class="o">=</span> <span class="n">reached_source</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">done_at_step</span> <span class="o">=</span> <span class="n">done_at_step</span>

    <span class="c1"># Reading timestamps</span>
    <span class="n">timestamp_column</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span>
    <span class="n">timestamp_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">timestamp_column</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamp_column</span><span class="p">)]])</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Reading each group of timestamps (representing of each run)</span>
    <span class="k">for</span> <span class="n">group_i</span><span class="p">,</span> <span class="p">(</span><span class="n">group_start</span><span class="p">,</span> <span class="n">group_end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">timestamp_groups</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">timestamp_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
        <span class="n">timestamp_group</span> <span class="o">=</span> <span class="n">timestamp_column</span><span class="p">[</span><span class="n">group_start</span><span class="p">:</span><span class="n">group_end</span><span class="p">]</span>

        <span class="c1"># Initial read of the group</span>
        <span class="n">first_timestamp</span> <span class="o">=</span> <span class="n">timestamp_group</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">timestamp_day</span> <span class="o">=</span> <span class="n">first_timestamp</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">timestamp_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">timestamp_group</span><span class="o">.</span><span class="n">notna</span><span class="p">())</span>
        <span class="n">timestamp_string_list</span> <span class="o">=</span> <span class="n">timestamp_group</span><span class="p">[:</span><span class="n">timestamp_count</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

        <span class="n">day_delta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">timestamp_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp_string_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)]</span>

        <span class="c1"># Reading each timestamp of the list</span>
        <span class="k">for</span> <span class="n">timestamp_string</span> <span class="ow">in</span> <span class="n">timestamp_string_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">timestamp_string</span> <span class="o">=</span> <span class="n">timestamp_day</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_string</span><span class="p">)</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp_string</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">day_delta</span>

            <span class="c1"># If timestamp is smaller than the previous one, it means it is a new day and the day_delta has to be increased</span>
            <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">timestamp_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">day_delta</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">timestamp</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">timestamp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>

        <span class="c1"># Adding the timestamps to the general dictionary</span>
        <span class="n">associate_run_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sim_start_rows</span><span class="p">])</span> <span class="o">==</span> <span class="n">group_start</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">timestamps</span><span class="p">[</span><span class="n">associate_run_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp_list</span>

    <span class="c1"># Warn if no timestamps were found</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[Warning] No timestamps were found in the loaded simulation history...&#39;</span><span class="p">)</span>

    <span class="n">hist</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">timestamps</span>

    <span class="c1"># Other attributes</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">=</span> <span class="n">environment_dimensions</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">environment_shape</span> <span class="o">=</span> <span class="n">environment_shape</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">environment_source_position</span> <span class="o">=</span> <span class="n">environment_source_position</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">environment_source_radius</span> <span class="o">=</span> <span class="n">environment_source_radius</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="o">=</span> <span class="n">environment_layer_labels</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">agent_thresholds</span> <span class="o">=</span> <span class="n">agent_thresholds</span>

    <span class="c1"># Saving simulation dfs back</span>
    <span class="n">hist</span><span class="o">.</span><span class="n">_simulation_dfs</span> <span class="o">=</span> <span class="n">simulation_dfs</span>

    <span class="k">return</span> <span class="n">hist</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.SimulationHistory.plot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">sim_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to plot a the trajectory of a given simulation.
An ax can be use to plot it on.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sim_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The id of the simulation to plot.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ax</code>
            </td>
            <td>
                  <code><span title="matplotlib.pyplot.Axes">Axes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ax on which to plot the path. (If not provided, a new axis will be created)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
         <span class="n">sim_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
         <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to plot a the trajectory of a given simulation.</span>
<span class="sd">    An ax can be use to plot it on.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim_id : int, default=0</span>
<span class="sd">        The id of the simulation to plot.</span>
<span class="sd">    ax : plt.Axes, optional</span>
<span class="sd">        The ax on which to plot the path. (If not provided, a new axis will be created)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># TODO: Setup 3D plotting</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Plotting function only available for 2D environments for now...&quot;</span>

    <span class="c1"># Generate ax is not provided</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

    <span class="c1"># Retrieving sim</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_dfs</span><span class="p">[</span><span class="n">sim_id</span><span class="p">]</span>

    <span class="c1"># Plot setup</span>
    <span class="n">env_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">env_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">env_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Start</span>
    <span class="n">start_coord</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">start_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">start_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Start&#39;</span><span class="p">)</span>

    <span class="c1"># Source circle</span>
    <span class="n">goal_circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_source_position</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_radius</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Source&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">goal_circle</span><span class="p">)</span>

    <span class="c1"># Until step</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># Path</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">seq</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">seq</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Path&#39;</span><span class="p">)</span>

    <span class="c1"># Layer observations</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obs_layer</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[[</span><span class="s1">&#39;layer&#39;</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">layer_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">TABLEAU_COLORS</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="k">for</span> <span class="n">layer_i</span><span class="p">,</span> <span class="n">layer_label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">layer_i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">layer_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_layer</span> <span class="o">==</span> <span class="n">layer_i</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Reshaping to a single vector and not an n by 1 array</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">layer_mask</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">layer_mask</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># X, Y</span>
                       <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="n">layer_colors</span><span class="p">[(</span><span class="n">layer_i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer_colors</span><span class="p">)],</span> <span class="c1"># Looping over the colors in case there are more layers than colors</span>
                       <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="n">layer_label</span><span class="p">)</span>

    <span class="c1"># Process odor cues</span>
    <span class="n">odor_cues</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">observation_ids</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">layer_ids</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[[</span><span class="s1">&#39;layer&#39;</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">action_layer_thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">[</span><span class="n">layer_ids</span><span class="p">]</span>
        <span class="n">observation_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">odor_cues</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">action_layer_thresholds</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">odor_cues</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">action_layer_thresholds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]))[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Setting observation ids</span>
        <span class="n">observation_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">((</span><span class="n">odor_cues</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="kc">None</span><span class="p">,:])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">odor_cues</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="kc">None</span><span class="p">,:]))[:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Check whether the odor detection is binary or by level</span>
    <span class="n">odor_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">odor_bins</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">odor_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">odor_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">odor_levels</span><span class="p">:</span>
            <span class="n">cues_at_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">observation_ids</span> <span class="o">==</span> <span class="n">level</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">cues_at_level</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">cues_at_level</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">alpha</span><span class="o">=</span><span class="p">(</span><span class="n">level</span> <span class="o">/</span> <span class="n">odor_bins</span><span class="p">),</span>
                       <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Sensed level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">something_sensed</span> <span class="o">=</span> <span class="p">(</span><span class="n">observation_ids</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">something_sensed</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">something_sensed</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                   <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Something observed&#39;</span><span class="p">)</span>

    <span class="c1"># Generate legend</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.SimulationHistory.plot_runtimes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_runtimes</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to plot the runtimes over the iterations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ax</code>
            </td>
            <td>
                  <code><span title="matplotlib.pyplot.Axes">Axes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ax on which to plot the path. (If not provided, a new axis will be created)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_runtimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to plot the runtimes over the iterations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax : plt.Axes, optional</span>
<span class="sd">        The ax on which to plot the path. (If not provided, a new axis will be created)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Generate ax is not provided</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

    <span class="c1"># Computing differences and plotting</span>
    <span class="n">x_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">consecutive_timestamps</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">time_differences_ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t_diff</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="k">for</span> <span class="n">t_diff</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">consecutive_timestamps</span><span class="p">)])</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="n">time_differences_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_differences_ms</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time_differences_count</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">time_differences_ms</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Simulation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">x_start</span> <span class="o">+=</span> <span class="n">time_differences_count</span>

    <span class="c1"># Axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Runtime (ms)&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.SimulationHistory.plot_successes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_successes</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to plot a 2D map of whether a given starting point was successfull or not (and whether it died early).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ax</code>
            </td>
            <td>
                  <code><span title="matplotlib.pyplot.Axes">Axes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ax on which to plot the path. (If not provided, a new axis will be created)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_successes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to plot a 2D map of whether a given starting point was successfull or not (and whether it died early).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax : plt.Axes, optional</span>
<span class="sd">        The ax on which to plot the path. (If not provided, a new axis will be created)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Only implemented for 2D environments...&quot;</span>

    <span class="c1"># Generate ax is not provided</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

    <span class="c1"># Setting up an empty grid of the starting points</span>
    <span class="n">start_points_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span><span class="p">)</span>

    <span class="c1"># Compute the successful, failed and the ones that reached the horizon</span>
    <span class="n">success_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_points</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">successful_simulation</span><span class="p">]</span>
    <span class="n">failed_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_points</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">successful_simulation</span><span class="p">]</span>
    <span class="n">failed_not_at_horizon_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_points</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">successful_simulation</span> <span class="o">&amp;</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">simulations_at_horizon</span><span class="p">]</span>

    <span class="n">start_points_grid</span><span class="p">[</span><span class="n">failed_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">failed_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">start_points_grid</span><span class="p">[</span><span class="n">success_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">success_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">start_points_grid</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">)</span>

    <span class="c1"># The crosses where the points did not reach the horizon</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">failed_not_at_horizon_points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">failed_not_at_horizon_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Died early&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="olfactory_navigation.SimulationHistory.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_analysis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_components</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Function to save the simulation history to a csv file in a given folder.
Additionally, an analysis of the runs can be saved if the save_analysis is enabled.
The environment and agent used can be saved in the saved folder by enabling the 'save_component' parameter.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the file the simulation histories will be saved to.
If it is not provided, it will be by default "Simulations-<env_name>-n_<sim_count>-<sim_start_timestamp>-horizon_<max_sim_length>.csv"</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Folder to save the simulation histories to.
If the folder name is not provided the current folder will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_analysis</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to save an additional csv file with an analysis of the runs of the simulation.
It will contain the amount of steps taken, the amount of extra steps compared to optimality, the discounted rewards and the ratio between optimal trajectory and the steps taken.
The means and standard deviations of all the runs are also computed.
The file will have the same name as the simulation history file with an additional '-analysis' tag at the end.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_components</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to save the environment and agent along with the simulation histories in the given folder.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
         <span class="n">file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">save_analysis</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
         <span class="n">save_components</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
         <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to save the simulation history to a csv file in a given folder.</span>
<span class="sd">    Additionally, an analysis of the runs can be saved if the save_analysis is enabled.</span>
<span class="sd">    The environment and agent used can be saved in the saved folder by enabling the &#39;save_component&#39; parameter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : str, optional</span>
<span class="sd">        The name of the file the simulation histories will be saved to.</span>
<span class="sd">        If it is not provided, it will be by default &quot;Simulations-&lt;env_name&gt;-n_&lt;sim_count&gt;-&lt;sim_start_timestamp&gt;-horizon_&lt;max_sim_length&gt;.csv&quot;</span>
<span class="sd">    folder : str, optional</span>
<span class="sd">        Folder to save the simulation histories to.</span>
<span class="sd">        If the folder name is not provided the current folder will be used.</span>
<span class="sd">    save_analysis : bool, default=True</span>
<span class="sd">        Whether to save an additional csv file with an analysis of the runs of the simulation.</span>
<span class="sd">        It will contain the amount of steps taken, the amount of extra steps compared to optimality, the discounted rewards and the ratio between optimal trajectory and the steps taken.</span>
<span class="sd">        The means and standard deviations of all the runs are also computed.</span>
<span class="sd">        The file will have the same name as the simulation history file with an additional &#39;-analysis&#39; tag at the end.</span>
<span class="sd">    save_components : bool, default=False</span>
<span class="sd">        Whether or not to save the environment and agent along with the simulation histories in the given folder.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;Function not available, the agent and/or the environment is not set.&quot;</span>

    <span class="c1"># Handle file name</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">env_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;s_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">axis_shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis_shape</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span><span class="p">])</span>
        <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Simulations-</span><span class="si">{</span><span class="n">env_name</span><span class="si">}</span><span class="s1">-n_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">-horizon_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span><span class="si">}</span><span class="s1">.csv&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">+=</span> <span class="s1">&#39;.csv&#39;</span>

    <span class="c1"># Handle folder</span>
    <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="n">folder</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>

    <span class="c1"># Save components if requested</span>
    <span class="k">if</span> <span class="n">save_components</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">saved_at</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">folder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">saved_at</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">saved_at</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">folder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">saved_at</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span>

    <span class="c1"># Create csv file</span>
    <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_dfs</span><span class="p">)</span>

    <span class="c1"># timestamps information</span>
    <span class="n">simulation_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_dfs</span><span class="p">])</span>
    <span class="n">timestamps_column</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n_start</span><span class="p">,</span> <span class="n">run_timestamps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">i_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">simulation_lengths</span><span class="p">[:</span><span class="n">n_start</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ts_i</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">run_timestamps</span><span class="p">):</span>
            <span class="n">timestamps_column</span><span class="p">[</span><span class="n">i_start</span> <span class="o">+</span> <span class="n">ts_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">ts</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamps_column</span>

    <span class="c1"># Adding other useful info</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
    <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;reward_discount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_discount</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">environment_info</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">saved_at</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_dimensions</span><span class="p">),</span> <span class="c1"># int</span>
        <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">axis_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis_size</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_shape</span><span class="p">),</span>
        <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">axis_position</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis_position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_source_position</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_source_radius</span><span class="p">),</span> <span class="c1"># float</span>
        <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_layer_labels</span><span class="p">)</span> <span class="c1"># Using &#39;&amp;&#39; as splitter as &#39;_&#39; could be used in the labels themselves</span>
    <span class="p">]</span>
    <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">environment_info</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">environment_info</span><span class="p">)])</span>

    <span class="c1"># Converting the thresholds array to a string to be saved</span>
    <span class="n">thresholds_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">thresholds_string</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span><span class="p">])</span> <span class="k">for</span> <span class="n">row_i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span> <span class="c1"># Using &#39;&amp;&#39; as layer splitter as &#39;-&#39; can be used for negative thresholds</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">thresholds_string</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_thresholds</span><span class="p">])</span>

    <span class="n">agent_info</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">class_name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">saved_at</span><span class="p">,</span>
        <span class="n">thresholds_string</span>
    <span class="p">]</span>
    <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_info</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">agent_info</span><span class="p">)])</span>

    <span class="c1"># Saving csv</span>
    <span class="n">combined_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulations saved to: </span><span class="si">{</span><span class="n">folder</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_analysis</span><span class="p">:</span>
        <span class="n">runs_analysis_file_name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;-runs_analysis.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runs_analysis_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">runs_analysis_file_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation&#39;s runs analysis saved to: </span><span class="si">{</span><span class="n">folder</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">runs_analysis_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">general_analysis_file_name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;-general_analysis.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_analysis_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">general_analysis_file_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation&#39;s general analysis saved to: </span><span class="si">{</span><span class="n">folder</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">general_analysis_file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="olfactory_navigation.run_test" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_test</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_loop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">initialization_values</span><span class="o">=</span><span class="p">{},</span> <span class="n">reward_discount</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">print_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">print_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">print_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batches</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Function to run n simulations for a given agent in its environment (or a given modified environment).
The simulations start either from random start points or provided trough the start_points parameter.
The simulation can have shifted initial times (in the olfactory simulation).</p>
<p>The simulation will run for at most 'horizon' steps, after which the simulations will be considered failed.</p>
<p>Some statistics can be printed at end of the simulation with the 'print_stats' parameter.
It will print some performance statisitcs about the simulations such as the average discounter reward.
The reward discount can be set by the 'reward_discount' parameter.</p>
<p>To speedup the simulations, it can be run on the gpu by toggling the 'use_gpu' parameter.
This will have the consequence to send the various arrays to the gpu memory.
This will only work if the agent has the support for to work with cupy arrays.</p>
<p>This method returns a SimulationHistory object that saves all the positions the agent went through,
the actions the agent took, and the observation the agent received.
It also provides the possibility the save the results to a csv file and plot the various trajectories.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>agent</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Agent (olfactory_navigation.agent.Agent)" href="agent/#olfactory_navigation.agent.Agent">Agent</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The agent to be tested</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many simulation to run in parallel.
n is optional but it needs to match with what is provided in start_points.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_points</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The starting points of the simulation in 2d space.
If not provided, n random points will be generated based on the start probabilities of the environment.
Else, the amount of start_points need to match to n, if it is provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>environment</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Environment (olfactory_navigation.agent.Environment)" href="#olfactory_navigation.Environment">Environment</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The environment to run the simulations in.
By default, the environment linked to the agent will used.
This parameter is intended if the environment needs to be modified compared to environment the agent was trained on.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_shift</code>
            </td>
            <td>
                  <code><span title="int">int</span> or <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time at which to start the olfactory simulation array.
It can be either a single value, or n values.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_loop</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to loop the time if reaching the end. (starts back at 0)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>horizon</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The amount of steps to run the simulation for before killing the remaining simulations.</p>
              </div>
            </td>
            <td>
                  <code>1000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>initialization_values</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>In the case the agent is to be initialized with custom values,
the paramaters to be passed on the initialize_state function can be set here.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reward_discount</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How much a given reward is discounted based on how long it took to get it.
It is purely used to compute the Average Discount Reward (ADR) after the simulation.</p>
              </div>
            </td>
            <td>
                  <code>0.99</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>print_progress</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to show a progress bar of what step the simulations are at.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>print_stats</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print the stats at the end of the run.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>print_warning</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to print warnings when they occur or not.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_gpu</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to run the simulations on the GPU or not.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batches</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>In how many batches the simulations should be run.
This is useful in the case there are too many simulations and the memory can fill up.
The value of batches=-1 will make it that different batches amount are tried in increasing order if a MemoryError is encountered.</p>
              </div>
            </td>
            <td>
                  <code>-1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>hist</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="SimulationHistory (olfactory_navigation.simulation.SimulationHistory)" href="simulation/#olfactory_navigation.simulation.SimulationHistory">SimulationHistory</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A SimulationHistory object that tracked all the positions, actions and observations.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>olfactory_navigation/simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_test</span><span class="p">(</span><span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">,</span>
             <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">start_points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">environment</span><span class="p">:</span> <span class="n">Environment</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">time_shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
             <span class="n">time_loop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
             <span class="n">initialization_values</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
             <span class="n">reward_discount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span>
             <span class="n">print_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">print_stats</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">print_warning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">use_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">batches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SimulationHistory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to run n simulations for a given agent in its environment (or a given modified environment).</span>
<span class="sd">    The simulations start either from random start points or provided trough the start_points parameter.</span>
<span class="sd">    The simulation can have shifted initial times (in the olfactory simulation).</span>

<span class="sd">    The simulation will run for at most &#39;horizon&#39; steps, after which the simulations will be considered failed.</span>

<span class="sd">    Some statistics can be printed at end of the simulation with the &#39;print_stats&#39; parameter.</span>
<span class="sd">    It will print some performance statisitcs about the simulations such as the average discounter reward.</span>
<span class="sd">    The reward discount can be set by the &#39;reward_discount&#39; parameter.</span>

<span class="sd">    To speedup the simulations, it can be run on the gpu by toggling the &#39;use_gpu&#39; parameter.</span>
<span class="sd">    This will have the consequence to send the various arrays to the gpu memory.</span>
<span class="sd">    This will only work if the agent has the support for to work with cupy arrays.</span>

<span class="sd">    This method returns a SimulationHistory object that saves all the positions the agent went through,</span>
<span class="sd">    the actions the agent took, and the observation the agent received.</span>
<span class="sd">    It also provides the possibility the save the results to a csv file and plot the various trajectories.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    agent : Agent</span>
<span class="sd">        The agent to be tested</span>
<span class="sd">    n : int, optional</span>
<span class="sd">        How many simulation to run in parallel.</span>
<span class="sd">        n is optional but it needs to match with what is provided in start_points.</span>
<span class="sd">    start_points : np.ndarray, optional</span>
<span class="sd">        The starting points of the simulation in 2d space.</span>
<span class="sd">        If not provided, n random points will be generated based on the start probabilities of the environment.</span>
<span class="sd">        Else, the amount of start_points need to match to n, if it is provided.</span>
<span class="sd">    environment : Environment, optional</span>
<span class="sd">        The environment to run the simulations in.</span>
<span class="sd">        By default, the environment linked to the agent will used.</span>
<span class="sd">        This parameter is intended if the environment needs to be modified compared to environment the agent was trained on.</span>
<span class="sd">    time_shift : int or np.ndarray, default=0</span>
<span class="sd">        The time at which to start the olfactory simulation array.</span>
<span class="sd">        It can be either a single value, or n values.</span>
<span class="sd">    time_loop : bool, default=True</span>
<span class="sd">        Whether to loop the time if reaching the end. (starts back at 0)</span>
<span class="sd">    horizon : int, default=1000</span>
<span class="sd">        The amount of steps to run the simulation for before killing the remaining simulations.</span>
<span class="sd">    initialization_values : dict, default={}</span>
<span class="sd">        In the case the agent is to be initialized with custom values,</span>
<span class="sd">        the paramaters to be passed on the initialize_state function can be set here.</span>
<span class="sd">    reward_discount : float, default=0.99</span>
<span class="sd">        How much a given reward is discounted based on how long it took to get it.</span>
<span class="sd">        It is purely used to compute the Average Discount Reward (ADR) after the simulation.</span>
<span class="sd">    print_progress : bool, default=True</span>
<span class="sd">        Whether to show a progress bar of what step the simulations are at.</span>
<span class="sd">    print_stats : bool, default=True</span>
<span class="sd">        Whether to print the stats at the end of the run.</span>
<span class="sd">    print_warning : bool, default=True</span>
<span class="sd">        Whether to print warnings when they occur or not.</span>
<span class="sd">    use_gpu : bool, default=False</span>
<span class="sd">        Whether to run the simulations on the GPU or not.</span>
<span class="sd">    batches : int, default=-1</span>
<span class="sd">        In how many batches the simulations should be run.</span>
<span class="sd">        This is useful in the case there are too many simulations and the memory can fill up.</span>
<span class="sd">        The value of batches=-1 will make it that different batches amount are tried in increasing order if a MemoryError is encountered.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    hist : SimulationHistory</span>
<span class="sd">        A SimulationHistory object that tracked all the positions, actions and observations.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Gathering n</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_points</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_points</span><span class="p">)</span>

    <span class="c1"># Handle the case an specific environment is given</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">print_warning</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">environment</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">agent</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Warning] The provided environment&#39;s shape doesn&#39;t match the environment has been trained on...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using the provided environment, not the agent environment.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">environment</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">environment</span>

    <span class="c1"># Timeshift</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time_shift</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">time_shift</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time_shift</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">time_shift</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">n</span><span class="p">,),</span> <span class="sa">f</span><span class="s2">&quot;time_shift array has a wrong shape (Given: </span><span class="si">{</span><span class="n">time_shift</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, expected (</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">,))&quot;</span>
    <span class="n">time_shift</span> <span class="o">=</span> <span class="n">time_shift</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Auto batches selector where the amount of batches increases if a memory error is detected</span>
    <span class="k">if</span> <span class="n">batches</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">all_try_batches</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="mi">11000</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">try_batches</span> <span class="ow">in</span> <span class="n">all_try_batches</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">run_test</span><span class="p">(</span><span class="n">agent</span> <span class="o">=</span> <span class="n">agent</span><span class="p">,</span>
                                <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span>
                                <span class="n">start_points</span> <span class="o">=</span> <span class="n">start_points</span><span class="p">,</span>
                                <span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="p">,</span>
                                <span class="n">time_shift</span> <span class="o">=</span> <span class="n">time_shift</span><span class="p">,</span>
                                <span class="n">time_loop</span> <span class="o">=</span> <span class="n">time_loop</span><span class="p">,</span>
                                <span class="n">horizon</span> <span class="o">=</span> <span class="n">horizon</span><span class="p">,</span>
                                <span class="n">initialization_values</span> <span class="o">=</span> <span class="n">initialization_values</span><span class="p">,</span>
                                <span class="n">reward_discount</span> <span class="o">=</span> <span class="n">reward_discount</span><span class="p">,</span>
                                <span class="n">print_progress</span> <span class="o">=</span> <span class="n">print_progress</span><span class="p">,</span>
                                <span class="n">print_stats</span> <span class="o">=</span> <span class="n">print_stats</span><span class="p">,</span>
                                <span class="n">print_warning</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># If there was any, it would have been printed already</span>
                                <span class="n">use_gpu</span> <span class="o">=</span> <span class="n">use_gpu</span><span class="p">,</span>
                                <span class="n">batches</span> <span class="o">=</span> <span class="n">try_batches</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">hist</span>
            <span class="k">except</span> <span class="ne">MemoryError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Memory full: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Increasing the amount of batches...&#39;</span><span class="p">)</span>

    <span class="c1"># If more than one batch is selected, split the starting point arrays by the amounts of simulations in each batch</span>
    <span class="k">elif</span> <span class="n">batches</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Computing the amount of simulations to be in each batch</span>
        <span class="n">n_batches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">n</span> <span class="o">/</span> <span class="n">batches</span><span class="p">]</span> <span class="o">*</span> <span class="n">batches</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">n_batches</span><span class="p">[:(</span><span class="n">n</span><span class="o">%</span><span class="n">batches</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">n_start</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Full SimulationHistory object</span>
        <span class="n">combined_hist</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Time tracking</span>
        <span class="n">all_sim_start_ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="c1"># Batches loop</span>
        <span class="n">batch_iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Batches&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">print_progress</span> <span class="k">else</span> <span class="n">n_batches</span>
        <span class="k">for</span> <span class="n">b_n</span> <span class="ow">in</span> <span class="n">batch_iterator</span><span class="p">:</span>
            <span class="n">b_hist</span> <span class="o">=</span> <span class="n">run_test</span><span class="p">(</span><span class="n">agent</span> <span class="o">=</span> <span class="n">agent</span><span class="p">,</span>
                              <span class="n">n</span> <span class="o">=</span> <span class="n">b_n</span><span class="p">,</span>
                              <span class="n">start_points</span> <span class="o">=</span> <span class="n">start_points</span><span class="p">[</span><span class="n">n_start</span><span class="p">:</span><span class="n">n_start</span><span class="o">+</span><span class="n">b_n</span><span class="p">],</span>
                              <span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="p">,</span>
                              <span class="n">time_shift</span> <span class="o">=</span> <span class="n">time_shift</span><span class="p">[</span><span class="n">n_start</span><span class="p">:</span><span class="n">n_start</span><span class="o">+</span><span class="n">b_n</span><span class="p">],</span>
                              <span class="n">time_loop</span> <span class="o">=</span> <span class="n">time_loop</span><span class="p">,</span>
                              <span class="n">horizon</span> <span class="o">=</span> <span class="n">horizon</span><span class="p">,</span>
                              <span class="n">initialization_values</span> <span class="o">=</span> <span class="n">initialization_values</span><span class="p">,</span>
                              <span class="n">reward_discount</span> <span class="o">=</span> <span class="n">reward_discount</span><span class="p">,</span>
                              <span class="n">print_progress</span> <span class="o">=</span> <span class="n">print_progress</span><span class="p">,</span>
                              <span class="n">print_stats</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># Forced false to not print too many things</span>
                              <span class="n">print_warning</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># If there was any, it would have been printed already</span>
                              <span class="n">use_gpu</span> <span class="o">=</span> <span class="n">use_gpu</span><span class="p">,</span>
                              <span class="n">batches</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">n_start</span> <span class="o">+=</span> <span class="n">b_n</span>

            <span class="c1"># Combining SimulationHistory objects</span>
            <span class="k">if</span> <span class="n">combined_hist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">combined_hist</span> <span class="o">=</span> <span class="n">b_hist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combined_hist</span> <span class="o">+=</span> <span class="n">b_hist</span>

        <span class="c1"># Print stats of the complete history is asked</span>
        <span class="k">if</span> <span class="n">print_stats</span><span class="p">:</span>
            <span class="n">all_sim_end_ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulations done in </span><span class="si">{</span><span class="p">(</span><span class="n">all_sim_end_ts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">all_sim_start_ts</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">s:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">combined_hist</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">combined_hist</span>

    <span class="c1"># Move things to GPU if needed</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span>
    <span class="k">if</span> <span class="n">use_gpu</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">gpu_support</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;GPU support is not enabled, the use_gpu option is not available.&quot;</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">cp</span>

        <span class="c1"># Move instances to GPU</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">gpu_version</span>
        <span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">gpu_version</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time_shift</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_points</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_points</span><span class="p">)</span>

    <span class="c1"># Set start positions</span>
    <span class="n">agent_position</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">start_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">start_points</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;The provided start_points are of the wrong shape (expected </span><span class="si">{</span><span class="n">environment</span><span class="o">.</span><span class="n">dimensions</span><span class="si">}</span><span class="s1">; received </span><span class="si">{</span><span class="n">start_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="n">agent_position</span> <span class="o">=</span> <span class="n">start_points</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Generating random starts</span>
        <span class="n">agent_position</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">random_start_points</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># Initialize agent&#39;s state</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">initialize_state</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">initialization_values</span><span class="p">)</span>

    <span class="c1"># Create simulation history tracker</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">SimulationHistory</span><span class="p">(</span>
        <span class="n">start_points</span><span class="o">=</span><span class="n">agent_position</span><span class="p">,</span>
        <span class="n">environment</span><span class="o">=</span><span class="n">environment</span><span class="p">,</span>
        <span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span>
        <span class="n">time_shift</span><span class="o">=</span><span class="n">time_shift</span><span class="p">,</span>
        <span class="n">horizon</span><span class="o">=</span><span class="n">horizon</span><span class="p">,</span>
        <span class="n">reward_discount</span><span class="o">=</span><span class="n">reward_discount</span>
    <span class="p">)</span>

    <span class="c1"># Track begin of simulation ts</span>
    <span class="n">sim_start_ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c1"># Simulation loop</span>
    <span class="n">iterator</span> <span class="o">=</span> <span class="n">trange</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span> <span class="k">if</span> <span class="n">print_progress</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="c1"># Letting agent choose the action to take based on it&#39;s curent state</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">choose_action</span><span class="p">()</span>

        <span class="c1"># Updating the agent&#39;s actual position (hidden to him)</span>
        <span class="n">agent_position</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">agent_position</span><span class="p">,</span>
                                          <span class="n">movement</span><span class="o">=</span><span class="p">(</span><span class="n">action</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">environment</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="n">action</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]))</span> <span class="c1"># Getting only the physical component of the action vector if environment has layers.</span>

        <span class="c1"># Get an observation based on the new position of the agent</span>
        <span class="n">observation</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">get_observation</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">agent_position</span><span class="p">,</span>
                                                  <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
                                                  <span class="n">layer</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">environment</span><span class="o">.</span><span class="n">has_layers</span> <span class="k">else</span> <span class="n">action</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span> <span class="c1"># Getting the layer information column of the action matrix.</span>

        <span class="c1"># Check if the source is reached</span>
        <span class="n">source_reached</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">source_reached</span><span class="p">(</span><span class="n">agent_position</span><span class="p">)</span>

        <span class="c1"># Add the position to the observation if the agent is space aware</span>
        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">space_aware</span><span class="p">:</span>
            <span class="n">observation</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">observation</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">agent_position</span><span class="p">))</span>

        <span class="c1"># Return the observation to the agent</span>
        <span class="n">update_succeeded</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
                                              <span class="n">observation</span><span class="o">=</span><span class="n">observation</span><span class="p">,</span>
                                              <span class="n">source_reached</span><span class="o">=</span><span class="n">source_reached</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_succeeded</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_succeeded</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_reached</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Handling the case where simulations have reached the end</span>
        <span class="n">sims_at_end</span> <span class="o">=</span> <span class="p">((</span><span class="n">time_shift</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">time_loop</span> <span class="k">else</span> <span class="n">environment</span><span class="o">.</span><span class="n">timesteps</span><span class="p">))</span>

        <span class="c1"># Agents to terminate</span>
        <span class="n">to_terminate</span> <span class="o">=</span> <span class="n">source_reached</span> <span class="o">|</span> <span class="n">sims_at_end</span> <span class="o">|</span> <span class="o">~</span><span class="n">update_succeeded</span>

        <span class="c1"># Send the values to the tracker</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">actions</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">next_positions</span><span class="o">=</span><span class="n">agent_position</span><span class="p">,</span>
            <span class="n">observations</span><span class="o">=</span><span class="n">observation</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">space_aware</span> <span class="k">else</span> <span class="n">observation</span><span class="p">,</span>
            <span class="n">reached_source</span><span class="o">=</span><span class="n">source_reached</span><span class="p">,</span>
            <span class="n">interupt</span><span class="o">=</span><span class="n">to_terminate</span>
        <span class="p">)</span>

        <span class="c1"># Interupt agents that reached the end</span>
        <span class="n">agent_position</span> <span class="o">=</span> <span class="n">agent_position</span><span class="p">[</span><span class="o">~</span><span class="n">to_terminate</span><span class="p">]</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="n">time_shift</span><span class="p">[</span><span class="o">~</span><span class="n">to_terminate</span><span class="p">]</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">simulations_to_kill</span><span class="o">=</span><span class="n">to_terminate</span><span class="p">)</span>

        <span class="c1"># Early stopping if all agents done</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent_position</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># Update progress bar</span>
        <span class="k">if</span> <span class="n">print_progress</span><span class="p">:</span>
            <span class="n">done_count</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">done_count</span>
            <span class="n">success_count</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">success_count</span>
            <span class="n">success_percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">success_count</span><span class="o">/</span><span class="n">done_count</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="k">if</span> <span class="n">done_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">100</span>
            <span class="n">dead_percentage</span> <span class="o">=</span> <span class="p">((</span><span class="n">done_count</span><span class="o">-</span><span class="n">success_count</span><span class="p">)</span><span class="o">/</span><span class="n">done_count</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="k">if</span> <span class="n">done_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">iterator</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span>
                <span class="s1">&#39;done &#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">done_count</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="p">(</span><span class="n">done_count</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;success &#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">success_count</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">done_count</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">success_percentage</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dead &#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">done_count</span><span class="o">-</span><span class="n">success_count</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">done_count</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">dead_percentage</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%)&#39;</span>
            <span class="p">})</span>

    <span class="c1"># If requested print the simulation start</span>
    <span class="k">if</span> <span class="n">print_stats</span><span class="p">:</span>
        <span class="n">sim_end_ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulations done in </span><span class="si">{</span><span class="p">(</span><span class="n">sim_end_ts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sim_start_ts</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">s:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hist</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: Home">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Home
              </div>
            </div>
          </a>
        
        
          
          <a href="agent/" class="md-footer__link md-footer__link--next" aria-label="Next: agent">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                agent
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.footer", "navigation.path", "navigation.top", "navigation.tabs", "navigation.tabs.sticky"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>